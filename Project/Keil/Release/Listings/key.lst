C51 COMPILER V9.60.7.0   KEY                                                               02/17/2025 17:05:46 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE KEY
OBJECT MODULE PLACED IN .\Release\Objects\key.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\Hardware\key.c OPTIMIZE(8,SIZE) BROWSE INTVECTOR(0X8000) INCDIR(..
                    -\..\Libraries\Include;..\..\User;..\..\Hardware;..\..\App) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\key.l
                    -st) OBJECT(.\Release\Objects\key.obj)

line level    source

   1          #include "key.h"
*** WARNING C322 IN LINE 71 OF \BaiduSyncdisk\A_WorkSt\Aworkst\2025-01-22-project250122-ËÕĞÀ-°´Ä¦ÒÇÓïÒô¿î-SX384\code\pro
             -ject-250122-TX8C1011\Libraries\Include\debug.h: unknown identifier
   2          
   3          // ===================================================
   4          // æŒ‰é”®ç›¸å…³é…ç½®                                      //
   5          // ===================================================
   6          #define KEY_FILTER_TIMES (3) // æŒ‰é”®æ¶ˆæŠ–æ¬¡æ•° (æ¶ˆæŠ–æ—¶é—´ == æ¶ˆæŠ–æ¬¡æ•° * æŒ‰é”®æ‰«ææ—¶é—´)
   7          volatile u8 key_event;       // å­˜æ”¾æŒ‰é”®äº‹ä»¶çš„å˜é‡
   8          
   9          /*
  10              æ£€æµ‹adæŒ‰é”®ï¼Œä½¿ç”¨VDDä½œä¸ºå‚è€ƒç”µå‹
  11              10Kä¸Šæ‹‰è¿æ¥åˆ°VDD
  12              å¼€å…³å’Œæ¨¡å¼æŒ‰é”®ä½¿ç”¨2.2Rä¸‹æ‹‰ï¼ŒåŠ çƒ­æŒ‰é”®ä½¿ç”¨10Kä¸‹æ‹‰
  13              é‚£ä¹ˆå¼€å…³å’Œæ¨¡å¼æŒ‰é”®æŒ‰ä¸‹æ—¶ï¼Œå¯¹åº”çš„ç”µå‹æ˜¯
  14              2.2R / (10K + 2.2R) * VDD,çº¦ä¸º 0.0002 VDD
  15              åŠ çƒ­æŒ‰é”®æŒ‰ä¸‹æ—¶ï¼Œå¯¹åº”çš„ç”µå‹
  16              10K / (10K + 10K) * VDD == 0.5 VDD
  17          
  18              VDDå¯¹åº”çš„adå€¼ä¸º4096ï¼Œé‚£ä¹ˆ
  19              å¼€å…³å’Œæ¨¡å¼æŒ‰é”®å¯¹åº”çš„adå€¼  0.8192
  20              åŠ çƒ­æŒ‰é”®å¯¹åº”çš„adå€¼       2048
  21              æ²¡æœ‰æŒ‰é”®æŒ‰ä¸‹æ—¶ï¼Œå¯¹åº”çš„adå€¼ 4096
  22              å– adå€¼>>4 çš„ä¸­é—´å€¼ä½œä¸ºåˆ’åˆ†
  23          
  24              0.8192 / 16 == 0.0512
  25              2048 / 16 == 128
  26              4096 / 16 == 256
  27              (128 - 0.0512) / 2 ,çº¦ä¸º64
  28              (256 - 128) / 2ï¼Œçº¦ä¸º64
  29              é‚£ä¹ˆæ£€æµ‹åˆ° adå€¼>>4 å°äº 64 + 0 æ—¶ï¼Œè®¤ä¸ºæ˜¯ å¼€å…³/æ¨¡å¼æŒ‰é”®æŒ‰ä¸‹
  30              æ£€æµ‹åˆ° adå€¼>>4 å¤§äº 64 ä¸”å°äº 64 + 128æ—¶ï¼Œè®¤ä¸ºæ˜¯ åŠ çƒ­æŒ‰é”®æŒ‰ä¸‹
  31              æ£€æµ‹åˆ° adå€¼>>4 å¤§äº 64 + 128 æ—¶ï¼Œè®¤ä¸º æ²¡æœ‰æŒ‰é”®æŒ‰ä¸‹
  32          */
  33          #define AD_KEY_VAL_NONE 255 // è¡¨ç¤ºæ²¡æœ‰æŒ‰é”®æŒ‰ä¸‹
  34          
  35          #define AD_KEY_VAL_MODE (64)       // å¼€å…³/æ¨¡å¼æŒ‰é”®
  36          #define AD_KEY_VAL_HEAT (64 + 128) // åŠ çƒ­æŒ‰é”®
  37          
  38          // å®šä¹‰æŒ‰é”®çš„idï¼Œä¸ key_id_table[]ä¸­çš„é¡ºåºæœ‰å…³
  39          // ç›®å‰é™¤äº†KEY_ID_NONE, KEY_ID_MODEå¯¹åº”æ•°ç»„çš„ç¬¬0ä¸ªï¼ŒKEY_ID_HEATå¯¹åº”æ•°ç»„çš„ç¬¬äºŒä¸ª
  40          enum
  41          {
  42              KEY_ID_NONE = 0,
  43              KEY_ID_MODE,
  44              KEY_ID_HEAT,
  45          };
  46          
  47          // å®šä¹‰æŒ‰é”®çš„äº‹ä»¶
  48          enum
  49          {
  50              KEY_EVENT_NONE = 0,
  51              KEY_EVENT_MODE_CLICK,
C51 COMPILER V9.60.7.0   KEY                                                               02/17/2025 17:05:46 PAGE 2   

  52              KEY_EVENT_MODE_HOLD,
  53              KEY_EVENT_HEAT_CLICK,
  54          };
  55          
  56          // å­˜æ”¾æŒ‰é”®
  57          const u8 key_id_table[] = {
  58              AD_KEY_VAL_MODE,
  59              AD_KEY_VAL_HEAT,
  60          }; // å„ä¸ªæŒ‰é”®ä»¥ä¸­é—´å€¼ä½œä¸ºåˆ†éš”ï¼Œä»å°åˆ°å¤§æ’åˆ—
  61          
  62          // extern volatile bit flag_is_dev_open;
  63          extern volatile bit flag_is_in_charging;
  64          
  65          extern volatile bit flag_is_enter_low_power; // æ ‡å¿—ä½ï¼Œæ˜¯å¦è¦è¿›å…¥ä½åŠŸè€—
  66          
  67          extern void fun_ctl_motor_status(u8 adjust_motor_status);
  68          extern void fun_ctl_power_on(void);
  69          extern void fun_ctl_power_off(void);
  70          extern void fun_ctl_heat_status(u8 adjust_heat_status);
  71          
  72          // adæŒ‰é”®æ‰«ææ£€æµ‹å‡½æ•°ï¼Œéœ€è¦æ”¾åˆ°å‘¨æœŸä¸º10msçš„å¾ªç¯å†…æ‰§è¡Œ
  73          void key_scan_10ms_isr(void)
  74          {
  75   1          u8 i = 0; // å¾ªç¯è®¡æ•°å€¼
  76   1          static volatile u8 last_key_id = KEY_ID_NONE;
  77   1          static volatile u8 press_cnt = 0;               // æŒ‰é”®æŒ‰ä¸‹çš„æ—¶é—´è®¡æ•°
  78   1          static volatile u8 filter_cnt = 0;              // æŒ‰é”®æ¶ˆæŠ–ï¼Œä½¿ç”¨çš„å˜é‡
  79   1          static volatile u8 filter_key_id = KEY_ID_NONE; // æŒ‰é”®æ¶ˆæŠ–æ—¶ä½¿ç”¨çš„å˜é‡
  80   1          volatile u8 cur_key_id = KEY_ID_NONE;
  81   1      
  82   1          static volatile bit flag_is_key_mode_hold = 0;
  83   1      
  84   1          volatile u8 adc_val = 0;
  85   1      
  86   1          adc_sel_channel(ADC_CHANNEL_KEY_SCAN);
  87   1          adc_val = adc_get_val_once() >> 4;
  88   1      
  89   1          for (i = 0; i < ARRAY_SIZE(key_id_table); i++) // è·å–å¯¹åº”çš„æŒ‰é”®id
  90   1          {
  91   2              if (adc_val < key_id_table[i])
  92   2              {
  93   3                  // ç”±äºç¬¬0ä¸ªè¡¨ç¤ºKEY_ID_NONE,è¿™é‡Œè¦èµ‹å€¼æœ‰æ•ˆçš„é”®å€¼ï¼Œéœ€è¦åŠ ä¸Š1
  94   3                  cur_key_id = i + 1;
  95   3                  break;
  96   3              }
  97   2          }
  98   1      
  99   1          // æ¶ˆæŠ–/æ»¤æ³¢
 100   1          if (cur_key_id != filter_key_id)
 101   1          {
 102   2              // å¦‚æœæœ‰æŒ‰é”®æŒ‰ä¸‹/æ¾å¼€
 103   2              filter_cnt = 0;
 104   2              filter_key_id = cur_key_id;
 105   2              return;
 106   2          }
 107   1      
 108   1          if (filter_cnt < KEY_FILTER_TIMES)
 109   1          {
 110   2              // å¦‚æœæ£€æµ‹åˆ°ç›¸åŒçš„æŒ‰é”®æŒ‰ä¸‹/æ¾å¼€
 111   2              // é˜²æ­¢è®¡æ•°æº¢å‡º
 112   2              filter_cnt++;
 113   2              return;
C51 COMPILER V9.60.7.0   KEY                                                               02/17/2025 17:05:46 PAGE 3   

 114   2          }
 115   1      
 116   1          // æ»¤æ³¢/æ¶ˆæŠ–å®Œæˆåï¼Œæ‰§è¡Œåˆ°è¿™é‡Œ
 117   1          if (last_key_id != cur_key_id)
 118   1          {
 119   2              if (last_key_id == KEY_ID_NONE)
 120   2              {
 121   3                  // å¦‚æœæœ‰æŒ‰é”®æŒ‰ä¸‹ï¼Œæ¸…é™¤æŒ‰é”®æŒ‰ä¸‹çš„æ—¶é—´è®¡æ•°
 122   3                  press_cnt = 0;
 123   3              }
 124   2              else if (cur_key_id == KEY_ID_NONE)
 125   2              {
 126   3                  // å¦‚æœæŒ‰é”®æ¾å¼€
 127   3                  if (press_cnt < 75)
 128   3                  {
 129   4                      // æŒ‰ä¸‹æ—¶é—´å°äº 750ms ï¼Œæ˜¯çŸ­æŒ‰
 130   4                      if (KEY_ID_MODE == last_key_id)
 131   4                      {
 132   5                          // å¼€å…³/æ¨¡å¼æŒ‰é”®çŸ­æŒ‰
 133   5                          key_event = KEY_EVENT_MODE_CLICK;
 134   5                      }
 135   4                      else if (KEY_ID_HEAT == last_key_id)
 136   4                      {
 137   5                          // åŠ çƒ­æŒ‰é”®çŸ­æŒ‰
 138   5                          key_event = KEY_EVENT_HEAT_CLICK;
 139   5                      }
 140   4                  }
 141   3                  else
 142   3                  {
 143   4                      // é•¿æŒ‰ã€é•¿æŒ‰æŒç»­ä¹‹åæ¾æ‰‹
 144   4                      if (KEY_ID_MODE == last_key_id)
 145   4                      {
 146   5                          flag_is_key_mode_hold = 0;
 147   5                      }
 148   4                  }
 149   3              }
 150   2          }
 151   1          else if (cur_key_id != KEY_ID_NONE)
 152   1          {
 153   2              // å¦‚æœæŒ‰é”®æŒ‰ä½ä¸æ”¾
 154   2              if (press_cnt < 255)
 155   2                  press_cnt++;
 156   2      
 157   2              if (KEY_ID_MODE == cur_key_id)
 158   2              {
 159   3                  // if (flag_is_dev_open)
 160   3                  // å½“å‰è®°å½•ç”µæœºå’ŒåŠ çƒ­çŠ¶æ€çš„å˜é‡ï¼Œåªè¦æœ‰ä¸€ä¸ªä¸ä¸º0ï¼Œè¯´æ˜è®¾å¤‡åœ¨å·¥ä½œ
 161   3                  if (cur_motor_status || cur_ctl_heat_status)
 162   3                  {
 163   4                      if (press_cnt >= 200) // 2000ms
 164   4                      {
 165   5                          if (flag_is_key_mode_hold)
 166   5                          {
 167   6                              // å¦‚æœè¯¥æŒ‰é”®è¿˜æœªæ¾æ‰‹ï¼Œä¸æ‰§è¡Œæ“ä½œ
 168   6                          }
 169   5                          else
 170   5                          {
 171   6                              key_event = KEY_EVENT_MODE_HOLD;
 172   6                              flag_is_key_mode_hold = 1;
 173   6                          }
 174   5                      }
 175   4                  }
C51 COMPILER V9.60.7.0   KEY                                                               02/17/2025 17:05:46 PAGE 4   

 176   3                  else
 177   3                  {
 178   4                      // å¦‚æœå½“å‰è®¾å¤‡æ˜¯å…³é—­çš„
 179   4                      if (press_cnt >= 100) // 1000msåŠ ä¸Šçœ‹é—¨ç‹—å”¤é†’çš„1024ms
 180   4                      {
 181   5                          if (flag_is_key_mode_hold)
 182   5                          {
 183   6                              // å¦‚æœè¯¥æŒ‰é”®è¿˜æœªæ¾æ‰‹ï¼Œä¸æ‰§è¡Œæ“ä½œ
 184   6                          }
 185   5                          else
 186   5                          {
 187   6                              key_event = KEY_EVENT_MODE_HOLD;
 188   6                              flag_is_key_mode_hold = 1;
 189   6                          }
 190   5                      }
 191   4                  }
 192   3              }
 193   2          }
 194   1      
 195   1          last_key_id = cur_key_id;
 196   1      }
 197          
 198          // æŒ‰é”®äº‹ä»¶å¤„ç†
 199          void key_event_handle(void)
 200          {
 201   1          // if (flag_is_dev_open)
 202   1          // å½“å‰è®°å½•ç”µæœºå’ŒåŠ çƒ­çŠ¶æ€çš„å˜é‡ï¼Œåªè¦æœ‰ä¸€ä¸ªä¸ä¸º0ï¼Œè¯´æ˜è®¾å¤‡åœ¨å·¥ä½œ
 203   1          if (cur_motor_status || cur_ctl_heat_status)
 204   1          {
 205   2              // å¦‚æœè®¾å¤‡æ­£åœ¨è¿è¡Œ
 206   2              if (KEY_EVENT_MODE_HOLD == key_event)
 207   2              {
 208   3                  // å…³æœºï¼š
 209   3                  fun_ctl_power_off();
 210   3                  SPEECH_POWER_DISABLE();
 211   3                  flag_is_enter_low_power = 1; // å…è®¸è¿›å…¥ä½åŠŸè€—
 212   3              }
 213   2              else if (KEY_EVENT_MODE_CLICK == key_event)
 214   2              {
 215   3                  // è®¾å¤‡è¿è¡Œæ—¶ï¼Œæ£€æµ‹åˆ° å¼€å…³/æ¨¡å¼ æŒ‰é”®çŸ­æŒ‰
 216   3                  // å‚æ•°å¡«0ï¼Œæ ¹æ®å…¨å±€å˜é‡ cur_motor_status çš„çŠ¶æ€æ¥è‡ªåŠ¨è°ƒèŠ‚
 217   3                  fun_ctl_motor_status(0);
 218   3              }
 219   2              else if (KEY_EVENT_HEAT_CLICK == key_event)
 220   2              {
 221   3                  // è®¾å¤‡è¿è¡Œæ—¶ï¼Œæ£€æµ‹åˆ° åŠ çƒ­ æŒ‰é”®çŸ­æŒ‰
 222   3                  // å‚æ•°å¡«0ï¼Œæ ¹æ®å…¨å±€å˜é‡ cur_ctl_heat_status çš„çŠ¶æ€æ¥è‡ªåŠ¨è°ƒèŠ‚
 223   3                  fun_ctl_heat_status(0);
 224   3              }
 225   2          }
 226   1          else
 227   1          {
 228   2              // å¦‚æœè®¾å¤‡æ²¡æœ‰åœ¨è¿è¡Œ
 229   2              if (KEY_EVENT_MODE_HOLD == key_event && /* é•¿æŒ‰äº† å¼€å…³/æ¨¡å¼æŒ‰é”® */
 230   2                  0 == flag_is_in_charging)           /* å½“å‰æ²¡æœ‰åœ¨å……ç”µ */
 231   2              {
 232   3                  // fun_ctl_power_on(); // å‡½æ•°å†…éƒ¨ä¼šå°† flag_is_dev_open ç½®ä¸€
 233   3                  fun_ctl_power_on();
 234   3                  SPEECH_POWER_ENABLE();
 235   3              }
 236   2          }
 237   1      
C51 COMPILER V9.60.7.0   KEY                                                               02/17/2025 17:05:46 PAGE 5   

 238   1          // å¤„ç†å®Œæˆåï¼Œæ¸…é™¤æŒ‰é”®äº‹ä»¶
 239   1          key_event = KEY_EVENT_NONE;
 240   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    250    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
