C51 COMPILER V9.60.7.0   CHARGE                                                            02/14/2025 17:51:38 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE CHARGE
OBJECT MODULE PLACED IN .\Release\Objects\charge.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\App\charge.c OPTIMIZE(8,SIZE) BROWSE INTVECTOR(0X8000) INCDIR(..\.
                    -.\Libraries\Include;..\..\User;..\..\Hardware;..\..\App) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\charge.
                    -lst) OBJECT(.\Release\Objects\charge.obj)

line level    source

   1          #include "charge.h"
*** WARNING C322 IN LINE 71 OF \BaiduSyncdisk\A_WorkSt\Aworkst\2025-01-22-project250122-ËÕĞÀ-°´Ä¦ÒÇÓïÒô¿î-SX384\code\pro
             -ject-250122-TX8C1011\Libraries\Include\debug.h: unknown identifier
   2          #include "tx8c101x.h"
   3          
   4          #if USE_MY_DEBUG
              #include <stdio.h>
              #endif
   7          
   8          extern volatile bit flag_is_in_charging;
   9          extern volatile bit flag_tim_scan_maybe_not_charge;
  10          extern volatile bit flag_tim_scan_maybe_in_charging;
  11          extern volatile bit flag_tim_set_is_in_charging;
  12          
  13          // å……ç”µæ‰«æä¸æ£€æµ‹
  14          /**
  15           * @brief    å……ç”µã€ç”µæ± çš„æ‰«æå’Œç›¸å…³å¤„ç†
  16                       å¦‚æœä¸€ä¸Šç”µæ£€æµ‹åˆ°ç”µæ± ä¸ºç©ºï¼Œä¸èƒ½è°ƒç”¨è¯¥å‡½æ•°
  17                       é™¤äº†å®šæ—¶å™¨ï¼Œå¯ä¾›å¤–éƒ¨æ£€æµ‹çš„æ ‡å¿—ä½ï¼š
  18                          flag_is_in_charging
  19                          flag_bat_is_full 
  20           */
  21          void charge_scan_handle(void)
  22          {
  23   1          u8 i = 0;                 // å¾ªç¯è®¡æ•°å€¼
  24   1          u32 adc_bat_val = 0;      // å­˜æ”¾æ£€æµ‹åˆ°çš„ç”µæ± ç”µå‹çš„adcå€¼
  25   1          u32 adc_charging_val = 0; // å­˜æ”¾æ£€æµ‹åˆ°çš„å……ç”µç”µå‹çš„adcå€¼
  26   1          u16 tmp_bat_val = 0;      // å­˜æ”¾æ£€æµ‹åˆ°çš„ç”µæ± ç”µå‹+è®¡ç®—çš„å‹å·®å¯¹åº”çš„adcå€¼
  27   1      
  28   1          adc_sel_channel(ADC_CHANNEL_BAT); // åˆ‡æ¢åˆ°æ£€æµ‹ç”µæ± é™å‹åçš„ç”µå‹çš„æ£€æµ‹å¼•è„š
  29   1          adc_bat_val = adc_get_val_once(); // æ›´æ–°ç”µæ± å¯¹åº”çš„adå€¼
  30   1      
  31   1          adc_sel_channel(ADC_CHANNEL_CHARGE);   // åˆ‡æ¢åˆ°æ£€æµ‹å……ç”µçš„ç”µå‹æ£€æµ‹å¼•è„š(æ£€æµ‹åˆ°çš„å……ç”
             -µç”µå‹ == USB-Cå£ç”µå‹ / 2)
  32   1          adc_charging_val = adc_get_val_once(); // æ›´æ–°å½“å‰æ£€æµ‹åˆ°çš„å……ç”µç”µå‹å¯¹åº”çš„adå€¼
  33   1      
  34   1          if (flag_is_in_charging)
  35   1          {
  36   2              // å¦‚æœæ­£åœ¨å……ç”µï¼Œæ£€æµ‹æ˜¯å¦æ‹”å‡ºäº†å……ç”µçº¿
  37   2              if (adc_charging_val < ADCDETECT_CHARING_THRESHOLD)
  38   2              {
  39   3                  // ç»™å¯¹åº”çš„æ ‡å¿—ä½ç½®ä¸€ï¼Œå¦‚æœè¿ç»­ 50 mséƒ½æ˜¯è¿™ä¸ªçŠ¶æ€ï¼Œè¯´æ˜æ‹”å‡ºäº†å……ç”µå
             -™¨
  40   3                  flag_tim_scan_maybe_not_charge = 1;
  41   3              }
  42   2              else
  43   2              {
  44   3                  flag_tim_scan_maybe_not_charge = 0;
  45   3              }
  46   2      
  47   2              if (0 == flag_tim_set_is_in_charging) // å¦‚æœå®šæ—¶å™¨è¿ç»­ 50 ms éƒ½æ˜¯æ£€æµ‹åˆ°æ‹”å‡ºäº†å……ç”
             -µå™¨
  48   2              {
C51 COMPILER V9.60.7.0   CHARGE                                                            02/14/2025 17:51:38 PAGE 2   

  49   3                  // å¦‚æœåœ¨å……ç”µæ—¶ï¼Œæ£€æµ‹åˆ°æ‹”å‡ºäº†å……ç”µçº¿
  50   3                  flag_is_in_charging = 0;
  51   3      
  52   3                  tmr2_pwm_disable(); // å…³é—­PWMè¾“å‡º
  53   3      
  54   3      #if USE_MY_DEBUG
                          printf("uncharging\n");
              #endif
  57   3              }
  58   2          } // if (flag_is_in_charging)
  59   1          else
  60   1          {
  61   2              // å¦‚æœä¸åœ¨å……ç”µï¼Œæ£€æµ‹æ˜¯å¦æ’å…¥äº†å……ç”µçº¿
  62   2              if (adc_charging_val >= ADCDETECT_CHARING_THRESHOLD)
  63   2              {
  64   3                  // ç»™å¯¹åº”çš„æ ‡å¿—ä½ç½®ä¸€ï¼Œå¦‚æœç´¯è®¡ 50 ms éƒ½æ˜¯è¿™ä¸ªçŠ¶æ€ï¼Œè¯´æ˜æ’å…¥äº†å……ç”µ
             -å™¨
  65   3                  flag_tim_scan_maybe_in_charging = 1;
  66   3              }
  67   2              else
  68   2              {
  69   3                  flag_tim_scan_maybe_in_charging = 0;
  70   3              }
  71   2      
  72   2              if (flag_tim_set_is_in_charging) // å¦‚æœå®šæ—¶å™¨ç´¯è®¡ 50 mséƒ½æ˜¯æ£€æµ‹åˆ°æ’å…¥äº†å……ç”µå™¨
  73   2              {
  74   3                  // ç¡®è®¤æ˜¯æ’å…¥å……ç”µçº¿åï¼Œæ— è®ºå¤„äºä»€ä¹ˆçŠ¶æ€ï¼Œéƒ½å˜ä¸ºå…³æœºçŠ¶æ€
  75   3                  flag_is_in_charging = 1;
  76   3      
  77   3      #if USE_MY_DEBUG
                          printf("charging\n");
              #endif
  80   3      
  81   3                  tmr2_pwm_enable(); // ä½¿èƒ½PWMè¾“å‡º
  82   3              }
  83   2          }
  84   1      
  85   1          if (flag_is_in_charging)
  86   1          {
  87   2              u16 max_pwm_val = 0;  // ä¸´æ—¶å­˜æ”¾æœ€å¤§å ç©ºæ¯”å¯¹åº”çš„å€¼
  88   2              u16 last_pwm_val = 0; // è®°å½•ä¹‹å‰çš„pwmå ç©ºæ¯”çš„å€¼
  89   2              u16 tmp_val = 0;      // ä¸´æ—¶å­˜æ”¾éœ€è¦è°ƒèŠ‚çš„å ç©ºæ¯”å¯¹åº”çš„å€¼
  90   2              static u16 tmp_val_l[8] = {0};
  91   2              static u8 tmp_val_cnt = 0;
  92   2      
  93   2              last_pwm_val = TMR2_PWML + ((u16)TMR2_PWMH << 7);  // è¯»å‡ºä¸Šä¸€æ¬¡PWMå ç©ºæ¯”å¯¹åº”çš„å€¼
  94   2              max_pwm_val = TMR2_PRL + ((u16)TMR2_PRH << 7) + 1; // è¯»å‡ºPWMå ç©ºæ¯”è®¾å®šçš„ã€æœ€å¤§çš„å€¼
  95   2              // printf("max_pwm_val %lu\n", max_pwm_val);
  96   2      
  97   2              /*
  98   2                  ä¿®æ”¹ç”µå‹å·®å€¼ï¼Œç”µå‹å·®å€¼ = 203 - (adc_bat_val * 122 / 1000)
  99   2      
 100   2                  æ¨å¯¼è¿‡ç¨‹ï¼š
 101   2                  åœ¨å……ç”µæ—¶æµ‹å¾—ï¼Œå……ç”µç”µæµ1.1Aå·¦å³ï¼Œå‹å·®ä¸º-30(adå€¼)æ—¶ï¼Œç”µæ± ä¸€ä¾§ç”µå‹ä¸º7.
             -8V(adå€¼ï¼š1917)
 102   2                               å……ç”µç”µæµ1.1Aå·¦å³ï¼Œå‹å·®ä¸º0(adå€¼)æ—¶ï¼Œç”µæ± ä¸€ä¾§ç”µå‹ä¸º6.8V(adå€¼ï¼
             -š1671)
 103   2                  å‡è®¾xè½´ä¸ºç”µå‹å¯¹åº”çš„adå€¼ï¼Œyè½´ä¸ºå‹å·®å¯¹åº”çš„adå€¼ï¼Œå»ºç«‹å‚è€ƒåæ ‡ç³»
 104   2                  æ ¹æ®è¿™ä¸¤ä¸ªæµ‹è¯•ç‚¹ï¼Œå‘ç°xè½´æ­£å‘å¢é•¿ï¼Œyè½´è´Ÿå‘å¢é•¿ï¼Œç”»å‡ºçš„æ–œçº¿å‘ä¸‹ï¼
             -Œæ–œç‡ä¸ºè´Ÿï¼Œæ±‚å‡ºæ–œç‡
 105   2                      k = Î”y/Î”x = (0 - 30) / (1917 - 1671)ï¼Œçº¦ä¸º -0.122
 106   2                  å»ºç«‹å…¬å¼ï¼šy = kx + bï¼Œä»£å…¥ï¼Œè§£å¾— b çº¦ä¸º 203 ï¼ˆå››èˆäº”å…¥æ˜¯204ï¼‰
C51 COMPILER V9.60.7.0   CHARGE                                                            02/14/2025 17:51:38 PAGE 3   

 107   2                  y = kx + b ==> å‹å·® = -0.122 * å……ç”µæ—¶çš„ç”µæ± ç”µå‹ + 203
 108   2                  è½¬æ¢æˆå•ç‰‡æœºå¯ä»¥è®¡ç®—çš„å½¢å¼ï¼šå‹å·® = 203 - (å……ç”µæ—¶çš„ç”µæ± ç”µå‹ * 122 / 100
             -0)
 109   2              */
 110   2      
 111   2              if (adc_bat_val <= 2837) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 6.5V
 112   2              {
 113   3                  tmp_bat_val = (adc_bat_val + 37);
 114   3              }
 115   2              else if (adc_bat_val <= 3056) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 7.0V
 116   2              {
 117   3                  tmp_bat_val = (adc_bat_val + 27);
 118   3              }
 119   2              else if (adc_bat_val <= 3188) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 7.3V
 120   2              {
 121   3                  tmp_bat_val = (adc_bat_val + 16);
 122   3              }
 123   2              else if (adc_bat_val <= 3326) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 7.62V
 124   2              {
 125   3                  tmp_bat_val = (adc_bat_val + 0);
 126   3              }
 127   2              else // å¦‚æœåœ¨å……ç”µæ—¶æ£€æµ‹åˆ°ç”µæ± ç”µå‹å¤§äº
 128   2              {
 129   3                  // å¦‚æœæ£€æµ‹ç”µæ± çš„åˆ†å‹ç”µé˜»æ˜¯ 22K / 100Kï¼Œ1.2-1.3A,æœ€å¸¸è§æ˜¯åœ¨1.22Aã€1.26A
 130   3                  // å¦‚æœæ£€æµ‹ç”µæ± çš„åˆ†å‹ç”µé˜»æ˜¯ 220K / 1Mï¼Œå……ç”µç”µæµåœ¨0.9A-1A
 131   3                  // tmp_bat_val = (u32)adc_bat_val - ((u32)adc_bat_val * 157 / 1000 - 294);
 132   3                  tmp_bat_val = (u32)adc_bat_val - ((u32)adc_bat_val * 157 / 1000 - 522);
 133   3              }
 134   2      
 135   2              tmp_bat_val += 95; //
 136   2      
 137   2              // for (i = 0; i < ARRAY_SIZE(bat_val_fix_table); i++)
 138   2              // {
 139   2              //     if (adc_bat_val <= bat_val_fix_table[i].adc_bat_val)
 140   2              //     {
 141   2              //         tmp_bat_val = (adc_bat_val + bat_val_fix_table[i].tmp_bat_val_fix);
 142   2              //         break;
 143   2              //     }
 144   2      
 145   2              //     if (i == (ARRAY_SIZE(bat_val_fix_table) - 1))
 146   2              //     {
 147   2              //         tmp_bat_val = (u32)adc_bat_val - ((u32)adc_bat_val * 157 / 1000 - 522) + TMP_BAT_VAL_FI
             -X;
 148   2              //     }
 149   2              // }
 150   2      
 151   2              /*
 152   2                  å‡å‹å…¬å¼ï¼šVo = Vi / (1 - D)
 153   2      
 154   2                  é€šè¿‡PWMæ¥æ§åˆ¶å‡å‹ï¼Œè¿™é‡Œå‡è®¾å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼ ä¸º Dï¼ŒPWMå ç©ºæ¯”å
             -¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ ä¸º 1
 155   2                  Vo = Vi / (PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ - å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼)
 156   2                  å½“å‰PWMå ç©ºæ¯”è¶Šå¤§ï¼ŒVoä¹Ÿè¶Šå¤§ï¼Œå……ç”µçš„ç”µæµä¹Ÿä¼šè¶Šå¤§
 157   2      
 158   2                  (PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ - å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼) = Vi / Vo
 159   2                  å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼ = PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ - Vi / Vo
 160   2      
 161   2                  è¿™é‡Œæ£€æµ‹åˆ°çš„å……ç”µç”µå‹çš„adå€¼ == USB-Cå£ç”µå‹ / 2[ä¸Šä¸‹æ‹‰ç”µé˜»åˆ†å‹] / å‚è€ƒç”
             -µå‹[3Vï¼Œé‚£ä¹ˆè¿™é‡Œå°±æ˜¯é™¤ä»¥3] * 4096[adè½¬æ¢ç²¾åº¦ï¼Œ12ä½-->0~4096]
 162   2                  å³ï¼Œè¿™é‡Œæ£€æµ‹åˆ°çš„å……ç”µç”µå‹çš„adå€¼ == USB-Cå£ç”µå‹ / 2 / 3 * 4096
 163   2                  æ£€æµ‹åˆ°çš„ç”µæ± ç”µå‹çš„adå€¼ == ç”µæ± ç”µå‹ * 0.18 / 3Vå‚è€ƒç”µå‹ * 4096 == ç”µæ± ç”µå
             -‹ * 220 / 1220 / 3Vå‚è€ƒç”µå‹ * 4096
C51 COMPILER V9.60.7.0   CHARGE                                                            02/14/2025 17:51:38 PAGE 4   

 164   2                  (ç”µæ± çš„åˆ†å‹ç”µé˜»ï¼š ä¸Šæ‹‰220Kï¼Œä¸‹æ‹‰1Mï¼Œåˆ†å‹ç³»æ•°ï¼š 220 / 1220)
 165   2      
 166   2                  æ£€æµ‹å……ç”µç”µå‹å’Œæ£€æµ‹ç”µæ± ç”µå‹ä½¿ç”¨çš„ä¸æ˜¯åŒä¸€ä¸ªåˆ†å‹ç³»æ•°ï¼Œè¦ä¸€èµ·è¿ç®—æ
             -—¶ï¼Œè¿™é‡Œå°†å……ç”µç”µå‹çš„adå† * 2 * 220 / 1220
 167   2                  å³ (adc_charging_val * 22 / 61)
 168   2      
 169   2                  å†ä»£å›å…¬å¼ï¼šå½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼ = PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§ç
             -š„å€¼ - Vi / Vo
 170   2                  å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼ = PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ - å……ç”µç”µå
             -‹ / å……ç”µæ—¶ç”µæ± ä¸¤ä¾§çš„ç”µå‹
 171   2                  tmp_val = max_pwm_val - å……ç”µç”µå‹ / å……ç”µæ—¶ç”µæ± ä¸¤ä¾§çš„ç”µå‹
 172   2                  è½¬æ¢æˆå•ç‰‡æœºå¯ä»¥è®¡ç®—çš„å½¢å¼ï¼š
 173   2                  tmp_val = max_pwm_val - (adc_charging_val * 22 / 61) / tmp_bat_valï¼Œä½†æ˜¯ max_pwm_val çš„å€¼
             -ä¸æ˜¯1ï¼Œä¸ç¬¦åˆ Vo = Vi / (1 - D)
 174   2                  è¿™é‡Œè¦æ”¹æˆ tmp_val = max_pwm_val - max_pwm_val * (adc_charging_val * 22 / 61) / tmp_bat_v
             -al
 175   2                  tmp_val = max_pwm_val - (adc_charging_val * max_pwm_val * 22 / 61) / tmp_bat_val
 176   2              */
 177   2              // D = 1 - (Vi / Vo)
 178   2              // tmp_val = max_pwm_val - (adc_charging_val * max_pwm_val * 22 / 61) / tmp_bat_val;
 179   2              tmp_val = max_pwm_val - ((u32)adc_charging_val * max_pwm_val * 94 / 147) / tmp_bat_val;
 180   2      
 181   2              if (tmp_val >= max_pwm_val)
 182   2              {
 183   3                  // å¦‚æœPWMå ç©ºæ¯”å¯¹åº”çš„å€¼ å¤§äº æœ€å¤§å ç©ºæ¯”å¯¹åº”çš„å€¼ï¼Œè¯´æ˜è®¡ç®—æº¢å‡ºï¼ˆå
             -¯èƒ½æ˜¯ç”µæ± ç”µå‹è¿‡å°ï¼‰ï¼ŒæŒ‰0å¤„ç†
 184   3                  tmp_val = 0;
 185   3              }
 186   2      
 187   2              // æ»¤æ³¢æ“ä½œï¼Œä¸€å¼€å§‹tmp_valä¼šå¾ˆå°ï¼Œé‡‡é›†å¤šæ¬¡åè¶‹äºä¸€ä¸ªå¹³å‡å€¼ï¼š
 188   2              tmp_val_cnt++;
 189   2              tmp_val_cnt &= 0x07;
 190   2              tmp_val_l[tmp_val_cnt] = (tmp_val_l[tmp_val_cnt] + tmp_val) >> 1;
 191   2              tmp_val = 0;
 192   2              for (i = 0; i < 8; i++)
 193   2              {
 194   3                  tmp_val += tmp_val_l[i];
 195   3              }
 196   2              tmp_val >>= 3;
 197   2      
 198   2              if (tmp_val > last_pwm_val)
 199   2              {
 200   3                  last_pwm_val = last_pwm_val + 1;
 201   3              }
 202   2              else if (tmp_val < last_pwm_val)
 203   2              {
 204   3                  last_pwm_val = last_pwm_val - 1;
 205   3              }
 206   2       
 207   2              TMR2_PWML = last_pwm_val % 256;
 208   2              TMR2_PWMH = last_pwm_val / 256; 
 209   2          } // if (flag_is_in_charging)
 210   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    586    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     17      17
   IDATA SIZE       =   ----    ----
C51 COMPILER V9.60.7.0   CHARGE                                                            02/14/2025 17:51:38 PAGE 5   

   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
