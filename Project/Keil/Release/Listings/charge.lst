C51 COMPILER V9.60.7.0   CHARGE                                                            02/27/2025 10:59:10 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE CHARGE
OBJECT MODULE PLACED IN .\Release\Objects\charge.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\App\charge.c OPTIMIZE(9,SIZE) BROWSE INTVECTOR(0X8000) INCDIR(..\.
                    -.\Libraries\Include;..\..\User;..\..\Hardware;..\..\App) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\charge.
                    -lst) OBJECT(.\Release\Objects\charge.obj)

line level    source

   1          #include "charge.h"
*** WARNING C322 IN LINE 71 OF \BaiduSyncdisk\A_WorkSt\Aworkst\2025-01-22-project250122-ËÕĞÀ-°´Ä¦ÒÇÓïÒô¿î-SX384\code\pro
             -ject-250122-TX8C1011\Libraries\Include\debug.h: unknown identifier
   2          #include "tx8c101x.h"
   3          
   4          #if USE_MY_DEBUG
              #include <stdio.h>
              #endif
   7          
   8          extern volatile bit flag_is_in_charging;
   9          extern volatile bit flag_bat_is_full;      // ç”µæ± æ˜¯å¦è¢«å……æ»¡ç”µçš„æ ‡å¿—ä½
  10          extern volatile bit flag_bat_is_near_full; // æ ‡å¿—ä½ï¼Œè¡¨ç¤ºç”µæ± æ˜¯å¦å¿«å……æ»¡ç”µ
  11          extern volatile bit flag_ctl_dev_close;    // æ§åˆ¶æ ‡å¿—ä½ï¼Œæ˜¯å¦è¦å…³é—­è®¾å¤‡
  12          extern volatile bit flag_ctl_led_blink;    // æ§åˆ¶æ ‡å¿—ä½ï¼Œæ˜¯å¦æ§åˆ¶æŒ‡ç¤ºç¯é—ªçƒ
  13          
  14          extern volatile bit flag_tim_scan_maybe_not_charge;
  15          extern volatile bit flag_tim_scan_maybe_in_charging;
  16          extern volatile bit flag_tim_set_is_in_charging;
  17          
  18          extern volatile bit flag_tim_scan_bat_maybe_near_full; // ç”¨äºç»™å®šæ—¶å™¨æ‰«æçš„æ ‡å¿—ä½ï¼Œå¯èƒ½æ£€
             -æµ‹åˆ°ç”µæ± å¿«è¢«å……æ»¡ç”µ
  19          extern volatile bit flag_tim_set_bat_is_near_full;     // ç”±å®šæ—¶å™¨ç½®ä½/å¤ä½çš„ï¼Œè¡¨ç¤ºç”µæ± æ˜¯å
             -¦å¿«è¢«å……æ»¡ç”µçš„æ ‡å¿—ä½
  20          
  21          extern volatile bit flag_tim_scan_bat_maybe_full; // ç”¨äºç»™å®šæ—¶å™¨æ‰«æçš„æ ‡å¿—ä½ï¼Œå¯èƒ½æ£€æµ‹åˆ
             -°ç”µæ± è¢«å……æ»¡ç”µ
  22          extern volatile bit flag_tim_set_bat_is_full;     // ç”±å®šæ—¶å™¨ç½®ä½/å¤ä½çš„ï¼Œè¡¨ç¤ºç”µæ± æ˜¯å¦è¢«å
             -……æ»¡ç”µçš„æ ‡å¿—ä½
  23          
  24          // ç”¨äºç»™å®šæ—¶å™¨æ‰«æçš„æ ‡å¿—ä½ï¼Œå¯èƒ½æ£€æµ‹åˆ°äº†ä½ç”µé‡
  25          // ä¼šåœ¨å¼€æœºå·¥ä½œæ—¶ æ›´æ–°è¯¥æ ‡å¿—ä½çš„çŠ¶æ€ï¼Œåœ¨å……ç”µæ—¶æ¸…é™¤æ ‡å¿—ä½
  26          extern volatile bit flag_tim_scan_maybe_low_bat;
  27          extern volatile bit flag_tim_set_bat_is_low; // ç”±å®šæ—¶å™¨ç½®ä½/å¤ä½çš„ï¼Œè¡¨ç¤ºåœ¨å·¥ä½œæ—¶ï¼Œç”µæ± 
             -æ˜¯å¦å¤„äºä½ç”µé‡çš„æ ‡å¿—ä½
  28          extern volatile bit flag_ctl_low_bat_alarm;  // æ§åˆ¶æ ‡å¿—ä½ï¼Œæ˜¯å¦ä½¿èƒ½ä½ç”µé‡æŠ¥è­¦
  29          
  30          extern volatile bit flag_tim_scan_maybe_shut_down; // ç”¨äºç»™å®šæ—¶å™¨æ‰«æçš„æ ‡å¿—ä½ï¼Œå¯èƒ½æ£€æµ‹å
             -ˆ°äº† ç”µæ± ç”µå‹ ä½äº å…³æœºå¯¹åº”çš„ç”µå‹
  31          extern volatile bit flag_tim_set_shut_down;        // ç”±å®šæ—¶å™¨ç½®ä½/å¤ä½çš„ï¼Œè¡¨ç¤ºåœ¨å·¥ä½œæ—¶ï¼Œ
             -æ£€æµ‹åˆ°äº† ç”µæ± ç”µå‹ åœ¨ä¸€æ®µæ—¶é—´å†…éƒ½ä½äº å…³æœºå¯¹åº”çš„ç”µå‹
  32          
  33          extern volatile bit flag_is_disable_to_open; // æ ‡å¿—ä½ï¼Œæ˜¯å¦ä¸ä½¿èƒ½å¼€æœº(ä½ç”µé‡ä¸å…è®¸å¼€æœº
             -)
  34          
  35          extern volatile bit flag_is_enter_low_power; // æ ‡å¿—ä½ï¼Œæ˜¯å¦è¦è¿›å…¥ä½åŠŸè€—
  36          
  37          // å……ç”µæ‰«æä¸æ£€æµ‹
  38          /**
  39           * @brief    å……ç”µã€ç”µæ± çš„æ‰«æå’Œç›¸å…³å¤„ç†
  40                       å¦‚æœä¸€ä¸Šç”µæ£€æµ‹åˆ°ç”µæ± ä¸ºç©ºï¼Œä¸èƒ½è°ƒç”¨è¯¥å‡½æ•°
  41                       é™¤äº†å®šæ—¶å™¨ï¼Œå¯ä¾›å¤–éƒ¨æ£€æµ‹çš„æ ‡å¿—ä½ï¼š
  42                          flag_is_in_charging
  43                          flag_bat_is_full
C51 COMPILER V9.60.7.0   CHARGE                                                            02/27/2025 10:59:10 PAGE 2   

  44           */
  45          void charge_scan_handle(void)
  46          {
  47   1          u16 adc_bat_val = 0;             // å­˜æ”¾æ£€æµ‹åˆ°çš„ç”µæ± ç”µå‹çš„adcå€¼
  48   1          u16 adc_charging_val = 0;        // å­˜æ”¾æ£€æµ‹åˆ°çš„å……ç”µç”µå‹çš„adcå€¼
  49   1          u16 tmp_bat_val = 0;             // å­˜æ”¾æ£€æµ‹åˆ°çš„ç”µæ± ç”µå‹+è®¡ç®—çš„å‹å·®å¯¹åº”çš„adcå€¼
  50   1          static u8 over_charging_cnt = 0; // å­˜æ”¾è¿‡å……è®¡æ•°
  51   1      
  52   1          adc_sel_channel(ADC_CHANNEL_BAT); // åˆ‡æ¢åˆ°æ£€æµ‹ç”µæ± é™å‹åçš„ç”µå‹çš„æ£€æµ‹å¼•è„š
  53   1          adc_bat_val = adc_get_val();      // æ›´æ–°ç”µæ± å¯¹åº”çš„adå€¼
  54   1      
  55   1          adc_sel_channel(ADC_CHANNEL_CHARGE); // åˆ‡æ¢åˆ°æ£€æµ‹å……ç”µçš„ç”µå‹æ£€æµ‹å¼•è„š(æ£€æµ‹åˆ°çš„å……ç”µç
             -”µå‹ == USB-Cå£ç”µå‹ / 2)
  56   1          adc_charging_val = adc_get_val();    // æ›´æ–°å½“å‰æ£€æµ‹åˆ°çš„å……ç”µç”µå‹å¯¹åº”çš„adå€¼
  57   1      
  58   1          // printf("bat val %u\n", adc_bat_val);
  59   1          // printf("charge val %u\n", adc_charging_val);
  60   1      
  61   1          // ä½ç”µé‡ä¸å…è®¸å¼€æœº
  62   1          if (adc_bat_val < LOW_BAT_ALARM_AD_VAL)
  63   1          {
  64   2              flag_is_disable_to_open = 1;
  65   2          }
  66   1          // else if (adc_bat_val > (LOW_BAT_ALARM_AD_VAL + 15))
  67   1          else
  68   1          {
  69   2              flag_is_disable_to_open = 0;
  70   2              flag_tim_scan_maybe_low_bat = 0;
  71   2          }
  72   1      
  73   1          if (flag_is_in_charging)
  74   1          {
  75   2              // å¦‚æœæ­£åœ¨å……ç”µï¼Œæ£€æµ‹ç”µæ± æ˜¯å¦å……æ»¡ç”µ
  76   2      
  77   2      #if 1 // æ£€æµ‹åœ¨å……ç”µæ—¶ï¼Œç”µæ± æ˜¯å¦å……æ»¡ç”µï¼Œå¹¶åšç›¸åº”çš„å¤„ç†
  78   2      
  79   2              if (0 == flag_bat_is_full)
  80   2              {
  81   3                  // å¦‚æœæ­£åœ¨å……ç”µï¼Œä¸”ç”µæ± æœªå……æ»¡ç”µï¼Œæ£€æµ‹ç”µè§†æ˜¯å¦å¿«å……æ»¡ç”µ æˆ–æ˜¯ ç”µæ± å…
             -…æ»¡ç”µ
  82   3      
  83   3                  // å¦‚æœæ£€æµ‹åˆ°å……æ»¡ç”µï¼ˆå¯èƒ½è§¦å‘äº†ç”µæ± ä¿æŠ¤æ¿çš„è¿‡å……ä¿æŠ¤ï¼‰ï¼Œç›´æ¥è¾“å‡º0
             -%çš„PWM
  84   3                  if (adc_bat_val >= ADCDETECT_BAT_FULL + ADCDETECT_BAT_NULL_EX)
  85   3                  {
  86   4                      // å¦‚æœæ£€æµ‹åˆ°çš„adå€¼æ¯” æ»¡ç”µçš„adå€¼ è¿˜è¦å¤š
  87   4                      // PWMå ç©ºæ¯”è®¾ç½®ä¸º0ï¼Œè®©å ç©ºæ¯”é‡æ–°å¼€å§‹é€’å¢ï¼Œç”µæµä»é›¶å¼€å§‹é€æ¸å¢å¤
             -§
  88   4                      TMR2_PWML = 0; // å ç©ºæ¯” 0%
  89   4                      TMR2_PWMH = 0;
  90   4                      over_charging_cnt++; // è¿‡å……æ£€æµ‹è®¡æ•°åŠ ä¸€
  91   4                      // flag_tim_scan_bat_maybe_full = 1; // (å¯ä»¥ä¸ç”¨ç»™è¿™ä¸ªæ ‡å¿—ä½ç½®ä¸€ï¼Œè¿™é‡Œåªæ
             -˜¯æµ‹è¯•æ—¶ä½¿ç”¨)
  92   4                  }
  93   3                  else if (adc_bat_val >= ADCDETECT_BAT_FULL) // æ£€æµ‹ç”µæ± æ˜¯å¦æ»¡ç”µ
  94   3                  {
  95   4                      // ç»™å¯¹åº”çš„æ ‡å¿—ä½ç½®ä¸€ï¼Œè®©å®šæ—¶å™¨æ¥æ£€æµ‹æ˜¯å¦æŒç»­ä¸€æ®µæ—¶é—´éƒ½æ˜¯æ»¡ç”µ
  96   4                      flag_tim_scan_bat_maybe_full = 1;
  97   4                  }
  98   3                  else if (adc_bat_val >= ADCVAL_NEAR_FULL_CHAGE) // æ£€æµ‹åˆ°æœ‰ä¸€æ¬¡ç”µæ± å¿«å……æ»¡ç”µ
  99   3                  {
 100   4                      // å¦‚æœç”µæ± å¿«å……æ»¡ç”µ
C51 COMPILER V9.60.7.0   CHARGE                                                            02/27/2025 10:59:10 PAGE 3   

 101   4                      flag_tim_scan_bat_maybe_near_full = 1; // è¡¨ç¤ºç”µæ± å¿«å……æ»¡ç”µ
 102   4                  }
 103   3                  else
 104   3                  {
 105   4                      // å¦‚æœæ£€æµ‹åˆ°çš„adå€¼å°äºæ»¡ç”µé˜ˆå€¼
 106   4                      // æ¸…ç©ºå¯¹åº”çš„æ ‡å¿—ä½ï¼Œè®©å®šæ—¶å™¨ä¸æ£€æµ‹æ˜¯å¦æ»¡ç”µ
 107   4                      flag_tim_scan_bat_maybe_full = 0;
 108   4                      flag_tim_scan_bat_maybe_near_full = 0;
 109   4                  }
 110   3      
 111   3                  if (flag_tim_set_bat_is_near_full && 0 == flag_bat_is_near_full)
 112   3                  {
 113   4                      // å¦‚æœç”µæ± æ¥è¿‘æ»¡ç”µï¼Œå…³é—­å……ç”µæ—¶çš„å‘¼å¸ç¯ï¼Œç‚¹äº®ç»¿ç¯ï¼Œä½†æ˜¯ä¸å…³é—­
             -æ§åˆ¶å……ç”µçš„PWM
 114   4                      flag_bat_is_near_full = 1;
 115   4                      delay_ms(1);    // å¿…é¡»è¦ç­‰å¾…å®šæ—¶å™¨å…³é—­å……ç”µæ—¶é—ªçƒçš„å‘¼å¸ç¯
 116   4                      LED_RED_OFF();  // å…³é—­å……ç”µæ—¶é—ªçƒçš„å‘¼å¸ç¯
 117   4                      LED_GREEN_ON(); // å……æ»¡ç”µæ—¶ï¼Œè®©ç»¿ç¯å¸¸äº®
 118   4                  }
 119   3      
 120   3                  if (flag_tim_set_bat_is_full || (over_charging_cnt >= 8))
 121   3                  // if (flag_tim_set_bat_is_full) // æµ‹è¯•æ—¶ä½¿ç”¨åˆ°çš„æ¡ä»¶
 122   3                  {
 123   4                      // å¦‚æœå®šæ—¶å™¨æ£€æµ‹äº†ä¸€æ®µæ—¶é—´(5s)ï¼Œéƒ½æ˜¯å……æ»¡ç”µçš„çŠ¶æ€ï¼Œæˆ–ç€æ˜¯ç´¯è®¡æœ
             -‰è¿‡å……ï¼Œè¯´æ˜ç”µæ± å……æ»¡ç”µ
 124   4                      over_charging_cnt = 0; // æ¸…é™¤è¿‡å……è®¡æ•°
 125   4                      flag_bat_is_full = 1;  // è¡¨ç¤ºç”µæ± è¢«å……æ»¡ç”µ
 126   4                      tmr2_pwm_disable();    // å…³é—­æ§åˆ¶å‡å‹ç”µè·¯çš„pwm
 127   4                      TMR2_PWML = 0;         // å ç©ºæ¯” 0%
 128   4                      TMR2_PWMH = 0;         //
 129   4                      // flag_is_in_charging = 0; // ä¸èƒ½ç»™è¿™ä¸ªæ ‡å¿—ä½æ¸…é›¶ï¼ˆäº¤ç»™å……ç”µæ‰«ææ¥æ¸…é›
             -¶ï¼‰
 130   4                      // delay_ms(1);    // å¯èƒ½è¦ç­‰å¾…å®šæ—¶å™¨å…³é—­å……ç”µæ—¶é—ªçƒçš„å‘¼å¸ç¯
 131   4                      LED_RED_OFF();  // å…³é—­å……ç”µæ—¶é—ªçƒçš„å‘¼å¸ç¯
 132   4                      LED_GREEN_ON(); // å……æ»¡ç”µæ—¶ï¼Œè®©ç»¿ç¯å¸¸äº®
 133   4                  }
 134   3              } // if (0 == flag_bat_is_full)
 135   2      
 136   2      #endif // æ£€æµ‹åœ¨å……ç”µæ—¶ï¼Œç”µæ± æ˜¯å¦å……æ»¡ç”µï¼Œå¹¶åšç›¸åº”çš„å¤„ç†
 137   2      
 138   2      #if 1 // (è¿™ä¸ªåŠŸèƒ½è¦æ”¾åœ¨è¯¥è¯­å¥å—çš„æœ€å)æ£€æµ‹åœ¨å……ç”µæ—¶ï¼Œæ˜¯å¦æ‹”å‡ºäº†å……ç”µçº¿ï¼Œå¹¶å
             -šç›¸åº”çš„å¤„ç†
 139   2            // å¦‚æœæ­£åœ¨å……ç”µï¼Œæ£€æµ‹æ˜¯å¦æ‹”å‡ºäº†å……ç”µçº¿
 140   2              if (adc_charging_val < ADCDETECT_CHARING_THRESHOLD)
 141   2              {
 142   3                  // ç»™å¯¹åº”çš„æ ‡å¿—ä½ç½®ä¸€ï¼Œå¦‚æœè¿ç»­ xx mséƒ½æ˜¯è¿™ä¸ªçŠ¶æ€ï¼Œè¯´æ˜æ‹”å‡ºäº†å……ç”µå
             -™¨
 143   3                  flag_tim_scan_maybe_not_charge = 1;
 144   3              }
 145   2              else
 146   2              {
 147   3                  flag_tim_scan_maybe_not_charge = 0;
 148   3              }
 149   2      
 150   2              if (0 == flag_tim_set_is_in_charging) // å¦‚æœå®šæ—¶å™¨è¿ç»­ 50 ms éƒ½æ˜¯æ£€æµ‹åˆ°æ‹”å‡ºäº†å……ç”
             -µå™¨
 151   2              {
 152   3                  // å¦‚æœåœ¨å……ç”µæ—¶ï¼Œæ£€æµ‹åˆ°æ‹”å‡ºäº†å……ç”µçº¿
 153   3                  flag_is_in_charging = 0;
 154   3      
 155   3                  // æ¸…ç©ºå……ç”µæ—¶ä½¿ç”¨çš„æ ‡å¿—ä½å’Œå˜é‡ï¼š
 156   3                  flag_tim_scan_bat_maybe_full = 0;
C51 COMPILER V9.60.7.0   CHARGE                                                            02/27/2025 10:59:10 PAGE 4   

 157   3                  flag_tim_scan_bat_maybe_near_full = 0;
 158   3                  // flag_tim_set_bat_is_full = 0; // å¯ä»¥ä¸ç”¨æ¸…é›¶è¿™ä¸ªå˜é‡ï¼Œå®šæ—¶å™¨åç»­ä¼šè‡ªåŠ¨æ
             -¸…é›¶
 159   3                  flag_bat_is_near_full = 0;
 160   3                  flag_bat_is_full = 0;
 161   3                  over_charging_cnt = 0; // æ¸…é™¤è¿‡å……è®¡æ•°
 162   3      
 163   3                  flag_is_enter_low_power = 1; // å…è®¸è¿›å…¥ä½åŠŸè€—
 164   3      
 165   3                  // å¯ä»¥äº¤ç»™ä½åŠŸè€—å‡½æ•°æ¥å…³é—­PWMï¼š
 166   3                  // tmr2_pwm_disable(); // å…³é—­æ§åˆ¶å……ç”µçš„PWMè¾“å‡º
 167   3                  delay_ms(1); // ç­‰å¾…å®šæ—¶å™¨æ¸…ç©ºç›¸åº”çš„å˜é‡å’Œæ ‡å¿—ä½
 168   3                               // å¯ä»¥äº¤ç»™ä½åŠŸè€—å‡½æ•°æ¥å…³ç¯ï¼š
 169   3                               // LED_GREEN_OFF();
 170   3                               // LED_RED_OFF();
 171   3      
 172   3      #if USE_MY_DEBUG
                          printf("uncharging\n");
              #endif // #if USE_MY_DEBUG
 175   3      
 176   3                  // return; // é€€å‡ºå‡½æ•°ï¼Œé˜²æ­¢å†æ‰§è¡Œä¸‹é¢çš„åŠŸèƒ½
 177   3              }
 178   2      #endif // æ£€æµ‹åœ¨å……ç”µæ—¶ï¼Œæ˜¯å¦æ‹”å‡ºäº†å……ç”µçº¿ï¼Œå¹¶åšç›¸åº”çš„å¤„ç†
 179   2      
 180   2          } // if (flag_is_in_charging)
 181   1          else // å¦‚æœä¸åœ¨å……ç”µ
 182   1          {
 183   2      
 184   2      #if 1 // åœ¨è®¾å¤‡å·¥ä½œæ—¶ï¼Œæ£€æµ‹æ˜¯å¦å¤„äºä½ç”µé‡ï¼Œå¹¶è¿›è¡Œç›¸åº”å¤„ç†
 185   2      
 186   2              if (0 != cur_motor_status || 0 != cur_ctl_heat_status)
 187   2              {
 188   3                  // å¦‚æœè®¾å¤‡åœ¨å·¥ä½œ
 189   3      
 190   3                  if (adc_bat_val <= SHUT_DOWN_BAT_AD_VAL)
 191   3                  {
 192   4                      // å¦‚æœç”µæ± ç”µå‹ å°äºç­‰äº å…³æœºå¯¹åº”çš„ç”µå‹
 193   4                      flag_tim_scan_maybe_shut_down = 1;
 194   4                      flag_tim_scan_maybe_low_bat = 0; // è¡¨ç¤ºä¸å¤„äºä½ç”µå‹ï¼Œè€Œæ˜¯å¤„äºå…³æœºç”µå‹ï¼Œ
             -è®©å®šæ—¶å™¨åªæ‰§è¡Œå…³æœºç”µå‹çš„è¿ç»­æ£€æµ‹éƒ¨åˆ†
 195   4                  }
 196   3                  else if (adc_bat_val <= LOW_BAT_ALARM_AD_VAL)
 197   3                  // if (adc_bat_val <= LOW_BAT_ALARM_AD_VAL) // è¿˜æ²¡æœ‰æ·»åŠ ä½ç”µé‡å…³æœºåŠŸèƒ½æ—¶ï¼Œç”¨äº
             -æµ‹è¯•ä½ç”µé‡æŠ¥è­¦çš„åŠŸèƒ½
 198   3                  {
 199   4                      // å¦‚æœç”µæ± ç”µå‹ å°äºç­‰äº ä½ç”µé‡æŠ¥è­¦å¯¹åº”çš„ç”µå‹
 200   4                      flag_tim_scan_maybe_low_bat = 1;
 201   4                      flag_tim_scan_maybe_shut_down = 0; // å½“å‰ç”µæ± ç”µå‹æ­£å¤„äº å…³æœºç”µå‹ ~ ä½ç”µé‡
             -ä¹‹é—´ï¼Œè¿˜æ²¡åˆ°è¦å…³æœºçš„æƒ…å†µ
 202   4                  }
 203   3                  else
 204   3                  {
 205   4                      // å¦‚æœç”µæ± ç”µå‹ å¤§äº ä½ç”µé‡æŠ¥è­¦å¯¹åº”çš„ç”µå‹
 206   4                      flag_tim_scan_maybe_low_bat = 0;
 207   4                      flag_tim_scan_maybe_shut_down = 0;
 208   4                  }
 209   3      
 210   3                  // å¦‚æœè¿ç»­ä¸€æ®µæ—¶é—´æ£€æµ‹åˆ°ç”µæ± ç”µå‹ä½äºå…³æœºç”µå‹
 211   3                  if (flag_tim_set_shut_down)
 212   3                  {
 213   4                      flag_ctl_dev_close = 1;
 214   4                      // SPEECH_POWER_DISABLE(); // å…³é—­è¯­éŸ³ICçš„ç”µæº(åœ¨ä½åŠŸè€—å‡½æ•°å†…å…³é—­)
C51 COMPILER V9.60.7.0   CHARGE                                                            02/27/2025 10:59:10 PAGE 5   

 215   4                      flag_is_enter_low_power = 1; // å…è®¸è¿›å…¥ä½åŠŸè€—
 216   4                  }
 217   3                  else if (flag_tim_set_bat_is_low && 0 == flag_ctl_low_bat_alarm)
 218   3                  // if (flag_tim_set_bat_is_low && 0 == flag_ctl_low_bat_alarm) // è¿˜æ²¡æœ‰æ·»åŠ ä½ç”µé‡å…³æ
             -œºåŠŸèƒ½æ—¶ï¼Œç”¨äºæµ‹è¯•ä½ç”µé‡æŠ¥è­¦çš„åŠŸèƒ½
 219   3                  {
 220   4                      // å¦‚æœè¿ç»­ä¸€æ®µæ—¶é—´æ£€æµ‹åˆ°ç”µæ± ç”µå‹å¤„äºä½ç”µé‡ï¼Œå¹¶ä¸”æ²¡æœ‰æ‰“å¼€ä½ç”µ
             -é‡æŠ¥è­¦
 221   4                      // flag_ctl_led_blink = 0; // å…ˆæ‰“æ–­å½“å‰çš„ç¯å…‰é—ªçƒæ•ˆæœï¼Œåœ¨è¿›è¡Œå…¶ä»–å¤„ç†
 222   4                      // delay_ms(1);
 223   4                      interrupt_led_blink();
 224   4                      LED_GREEN_OFF();
 225   4                      LED_RED_OFF();
 226   4                      flag_ctl_low_bat_alarm = 1; // ä½¿èƒ½ä½ç”µé‡æŠ¥è­¦
 227   4                  }
 228   3              }
 229   2      #endif // åœ¨è®¾å¤‡å·¥ä½œæ—¶ï¼Œæ£€æµ‹æ˜¯å¦å¤„äºä½ç”µé‡ï¼Œå¹¶è¿›è¡Œç›¸åº”å¤„ç†
 230   2      
 231   2      #if 1 // æ£€æµ‹ä¸åœ¨å……ç”µæ—¶ï¼Œæ˜¯å¦æœ‰æ’å…¥å……ç”µçº¿ï¼Œå¹¶åšç›¸åº”çš„å¤„ç†
 232   2            // å¦‚æœä¸åœ¨å……ç”µï¼Œæ£€æµ‹æ˜¯å¦æ’å…¥äº†å……ç”µçº¿
 233   2              if (adc_charging_val >= ADCDETECT_CHARING_THRESHOLD)
 234   2              {
 235   3                  // ç»™å¯¹åº”çš„æ ‡å¿—ä½ç½®ä¸€ï¼Œå¦‚æœç´¯è®¡ 50 ms éƒ½æ˜¯è¿™ä¸ªçŠ¶æ€ï¼Œè¯´æ˜æ’å…¥äº†å……ç”µ
             -å™¨
 236   3                  flag_tim_scan_maybe_in_charging = 1;
 237   3              }
 238   2              else
 239   2              {
 240   3                  flag_tim_scan_maybe_in_charging = 0;
 241   3              }
 242   2      
 243   2              if (flag_tim_set_is_in_charging) // å¦‚æœå®šæ—¶å™¨ç´¯è®¡ 50 mséƒ½æ˜¯æ£€æµ‹åˆ°æ’å…¥äº†å……ç”µå™¨
 244   2              {
 245   3                  // ç¡®è®¤æ˜¯æ’å…¥å……ç”µçº¿åï¼Œæ— è®ºå¤„äºä»€ä¹ˆçŠ¶æ€ï¼Œéƒ½å˜ä¸ºå…³æœºçŠ¶æ€
 246   3                  flag_is_in_charging = 1;
 247   3      
 248   3                  // æ¸…ç©ºä¸å……ç”µæ—¶ä½¿ç”¨çš„å˜é‡å’Œæ ‡å¿—ä½
 249   3                  flag_tim_scan_maybe_low_bat = 0; // è¡¨ç¤ºä¸å¤„äºä½ç”µé‡
 250   3                  flag_ctl_low_bat_alarm = 0;      // å…³é—­ä½ç”µé‡æŠ¥è­¦
 251   3      
 252   3      #if USE_MY_DEBUG
                          printf("charging\n");
              #endif // #if USE_MY_DEBUG
 255   3      
 256   3                  // åœ¨æµ‹è¯•æ—¶å…³é—­
 257   3                  tmr2_pwm_enable();           // ä½¿èƒ½PWMè¾“å‡º
 258   3                  flag_ctl_dev_close = 1;      // æ§åˆ¶æ ‡å¿—ä½ç½®ä¸€ï¼Œè®©ä¸»å‡½æ•°æ‰«æåˆ°ï¼Œå¹¶å…³æœº
 259   3                  flag_is_enter_low_power = 0; // ä¸è¿›å…¥ä½åŠŸè€—
 260   3      
 261   3                  // flag_ctl_led_blink = 0; // æ‰“æ–­å½“å‰çš„ç¯å…‰é—ªçƒæ•ˆæœ
 262   3                  // delay_ms(1);
 263   3                  interrupt_led_blink();
 264   3                  LED_GREEN_OFF(); // å…³é—­ç»¿ç¯(å¦‚æœç­‰åˆ°ä¸»å¾ªç¯æ‰«æåˆ°å†å…³é—­ç»¿ç¯ï¼Œç¬¬1msä¼šå‡ºç
             -°çº¢ç¯å’Œç»¿ç¯ä¸€èµ·ç‚¹äº®çš„æƒ…å†µ)
 265   3              }
 266   2      #endif // æ£€æµ‹ä¸åœ¨å……ç”µæ—¶ï¼Œæ˜¯å¦æœ‰æ’å…¥å……ç”µçº¿ï¼Œå¹¶åšç›¸åº”çš„å¤„ç†
 267   2          }
 268   1      
 269   1      #if 1 // å……ç”µç”µæµæ§åˆ¶
 270   1      
 271   1          // if (flag_is_in_charging && 0 == flag_bat_is_full)
 272   1          if (flag_is_in_charging)
C51 COMPILER V9.60.7.0   CHARGE                                                            02/27/2025 10:59:10 PAGE 6   

 273   1          {
 274   2              u8 i = 0;            // å¾ªç¯è®¡æ•°å€¼
 275   2              u8 max_pwm_val = 0;  // ä¸´æ—¶å­˜æ”¾æœ€å¤§å ç©ºæ¯”å¯¹åº”çš„å€¼
 276   2              u8 last_pwm_val = 0; // è®°å½•ä¹‹å‰çš„pwmå ç©ºæ¯”çš„å€¼
 277   2              u16 tmp_val = 0;     // ä¸´æ—¶å­˜æ”¾éœ€è¦è°ƒèŠ‚çš„å ç©ºæ¯”å¯¹åº”çš„å€¼
 278   2              static u16 tmp_val_l[8] = {0};
 279   2              static u8 tmp_val_cnt = 0;
 280   2      
 281   2              // last_pwm_val = (u16)TMR2_PWML + ((u16)TMR2_PWMH << 7); // è¯»å‡ºä¸Šä¸€æ¬¡PWMå ç©ºæ¯”å¯¹åº”çš„å
             -€¼
 282   2              // max_pwm_val = TMR2_PRL + ((u16)TMR2_PRH << 7) + 1;     // è¯»å‡ºPWMå ç©ºæ¯”è®¾å®šçš„ã€æœ€å¤§ç
             -š„å€¼
 283   2              last_pwm_val = TMR2_PWML;
 284   2              max_pwm_val = TMR2_PRL + 1;
 285   2      
 286   2              /*
 287   2                  ä¿®æ”¹ç”µå‹å·®å€¼ï¼Œç”µå‹å·®å€¼ = 203 - (adc_bat_val * 122 / 1000)
 288   2      
 289   2                  æ¨å¯¼è¿‡ç¨‹ï¼š
 290   2                  åœ¨å……ç”µæ—¶æµ‹å¾—ï¼Œå……ç”µç”µæµ1.1Aå·¦å³ï¼Œå‹å·®ä¸º-30(adå€¼)æ—¶ï¼Œç”µæ± ä¸€ä¾§ç”µå‹ä¸º7.
             -8V(adå€¼ï¼š1917)
 291   2                               å……ç”µç”µæµ1.1Aå·¦å³ï¼Œå‹å·®ä¸º0(adå€¼)æ—¶ï¼Œç”µæ± ä¸€ä¾§ç”µå‹ä¸º6.8V(adå€¼ï¼
             -š1671)
 292   2                  å‡è®¾xè½´ä¸ºç”µå‹å¯¹åº”çš„adå€¼ï¼Œyè½´ä¸ºå‹å·®å¯¹åº”çš„adå€¼ï¼Œå»ºç«‹å‚è€ƒåæ ‡ç³»
 293   2                  æ ¹æ®è¿™ä¸¤ä¸ªæµ‹è¯•ç‚¹ï¼Œå‘ç°xè½´æ­£å‘å¢é•¿ï¼Œyè½´è´Ÿå‘å¢é•¿ï¼Œç”»å‡ºçš„æ–œçº¿å‘ä¸‹ï¼
             -Œæ–œç‡ä¸ºè´Ÿï¼Œæ±‚å‡ºæ–œç‡
 294   2                      k = Î”y/Î”x = (0 - 30) / (1917 - 1671)ï¼Œçº¦ä¸º -0.122
 295   2                  å»ºç«‹å…¬å¼ï¼šy = kx + bï¼Œä»£å…¥ï¼Œè§£å¾— b çº¦ä¸º 203 ï¼ˆå››èˆäº”å…¥æ˜¯204ï¼‰
 296   2                  y = kx + b ==> å‹å·® = -0.122 * å……ç”µæ—¶çš„ç”µæ± ç”µå‹ + 203
 297   2                  è½¬æ¢æˆå•ç‰‡æœºå¯ä»¥è®¡ç®—çš„å½¢å¼ï¼šå‹å·® = 203 - (å……ç”µæ—¶çš„ç”µæ± ç”µå‹ * 122 / 100
             -0)
 298   2              */
 299   2      
 300   2              if (adc_bat_val <= 2752) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 6.5V
 301   2              {
 302   3                  tmp_bat_val = (adc_bat_val + 37);
 303   3              }
 304   2              else if (adc_bat_val <= 2964) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 7.0V
 305   2              {
 306   3                  tmp_bat_val = (adc_bat_val + 27);
 307   3              }
 308   2              else if (adc_bat_val <= 3091) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 7.3V
 309   2              {
 310   3                  tmp_bat_val = (adc_bat_val + 16);
 311   3              }
 312   2              else if (adc_bat_val <= 3227) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 7.62V
 313   2              {
 314   3                  tmp_bat_val = (adc_bat_val + 0);
 315   3              }
 316   2              else // å¦‚æœåœ¨å……ç”µæ—¶æ£€æµ‹åˆ°ç”µæ± ç”µå‹å¤§äº
 317   2              {
 318   3                  // å¦‚æœæ£€æµ‹ç”µæ± çš„åˆ†å‹ç”µé˜»æ˜¯ 22K / 100Kï¼Œ1.2-1.3A,æœ€å¸¸è§æ˜¯åœ¨1.22Aã€1.26A
 319   3                  // å¦‚æœæ£€æµ‹ç”µæ± çš„åˆ†å‹ç”µé˜»æ˜¯ 220K / 1Mï¼Œå……ç”µç”µæµåœ¨0.9A-1A
 320   3                  // tmp_bat_val = (u32)adc_bat_val - ((u32)adc_bat_val * 157 / 1000 - 294);
 321   3                  tmp_bat_val = (u32)adc_bat_val - ((u32)adc_bat_val * 157 / 1000 - 522);
 322   3              }
 323   2      
 324   2              // tmp_bat_val += 30;
 325   2              // tmp_bat_val += 22; // åé¢ä¼šåˆ°1.5A
 326   2              // tmp_bat_val += 18;// åé¢ä¼šåˆ°1.5A
 327   2              tmp_bat_val += 10; // A
 328   2              // tmp_bat_val +=0;//1.28A
C51 COMPILER V9.60.7.0   CHARGE                                                            02/27/2025 10:59:10 PAGE 7   

 329   2      
 330   2              // for (i = 0; i < ARRAY_SIZE(bat_val_fix_table); i++)
 331   2              // {
 332   2              //     if (adc_bat_val <= bat_val_fix_table[i].adc_bat_val)
 333   2              //     {
 334   2              //         tmp_bat_val = (adc_bat_val + bat_val_fix_table[i].tmp_bat_val_fix);
 335   2              //         break;
 336   2              //     }
 337   2      
 338   2              //     if (i == (ARRAY_SIZE(bat_val_fix_table) - 1))
 339   2              //     {
 340   2              //         tmp_bat_val = (u32)adc_bat_val - ((u32)adc_bat_val * 157 / 1000 - 522) + TMP_BAT_VAL_FI
             -X;
 341   2              //     }
 342   2              // }
 343   2      
 344   2              /*
 345   2                  å‡å‹å…¬å¼ï¼šVo = Vi / (1 - D)
 346   2      
 347   2                  é€šè¿‡PWMæ¥æ§åˆ¶å‡å‹ï¼Œè¿™é‡Œå‡è®¾å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼ ä¸º Dï¼ŒPWMå ç©ºæ¯”å
             -¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ ä¸º 1
 348   2                  Vo = Vi / (PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ - å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼)
 349   2                  å½“å‰PWMå ç©ºæ¯”è¶Šå¤§ï¼ŒVoä¹Ÿè¶Šå¤§ï¼Œå……ç”µçš„ç”µæµä¹Ÿä¼šè¶Šå¤§
 350   2      
 351   2                  (PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ - å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼) = Vi / Vo
 352   2                  å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼ = PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ - Vi / Vo
 353   2      
 354   2                  è¿™é‡Œæ£€æµ‹åˆ°çš„å……ç”µç”µå‹çš„adå€¼ == USB-Cå£ç”µå‹ / 2[ä¸Šä¸‹æ‹‰ç”µé˜»åˆ†å‹] / å‚è€ƒç”
             -µå‹[3Vï¼Œé‚£ä¹ˆè¿™é‡Œå°±æ˜¯é™¤ä»¥3] * 4096[adè½¬æ¢ç²¾åº¦ï¼Œ12ä½-->0~4096]
 355   2                  å³ï¼Œè¿™é‡Œæ£€æµ‹åˆ°çš„å……ç”µç”µå‹çš„adå€¼ == USB-Cå£ç”µå‹ / 2 / 3 * 4096
 356   2                  æ£€æµ‹åˆ°çš„ç”µæ± ç”µå‹çš„adå€¼ == ç”µæ± ç”µå‹ * 0.18 / 3Vå‚è€ƒç”µå‹ * 4096 == ç”µæ± ç”µå
             -‹ * 220 / 1220 / 3Vå‚è€ƒç”µå‹ * 4096
 357   2                  (ç”µæ± çš„åˆ†å‹ç”µé˜»ï¼š ä¸Šæ‹‰220Kï¼Œä¸‹æ‹‰1Mï¼Œåˆ†å‹ç³»æ•°ï¼š 220 / 1220)
 358   2      
 359   2                  æ£€æµ‹å……ç”µç”µå‹å’Œæ£€æµ‹ç”µæ± ç”µå‹ä½¿ç”¨çš„ä¸æ˜¯åŒä¸€ä¸ªåˆ†å‹ç³»æ•°ï¼Œè¦ä¸€èµ·è¿ç®—æ
             -—¶ï¼Œè¿™é‡Œå°†å……ç”µç”µå‹çš„adå† * 2 * 220 / 1220
 360   2                  å³ (adc_charging_val * 22 / 61)
 361   2      
 362   2                  å†ä»£å›å…¬å¼ï¼šå½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼ = PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§ç
             -š„å€¼ - Vi / Vo
 363   2                  å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼ = PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ - å……ç”µç”µå
             -‹ / å……ç”µæ—¶ç”µæ± ä¸¤ä¾§çš„ç”µå‹
 364   2                  tmp_val = max_pwm_val - å……ç”µç”µå‹ / å……ç”µæ—¶ç”µæ± ä¸¤ä¾§çš„ç”µå‹
 365   2                  è½¬æ¢æˆå•ç‰‡æœºå¯ä»¥è®¡ç®—çš„å½¢å¼ï¼š
 366   2                  tmp_val = max_pwm_val - (adc_charging_val * 22 / 61) / tmp_bat_valï¼Œä½†æ˜¯ max_pwm_val çš„å€¼
             -ä¸æ˜¯1ï¼Œä¸ç¬¦åˆ Vo = Vi / (1 - D)
 367   2                  è¿™é‡Œè¦æ”¹æˆ tmp_val = max_pwm_val - max_pwm_val * (adc_charging_val * 22 / 61) / tmp_bat_v
             -al
 368   2                  tmp_val = max_pwm_val - (adc_charging_val * max_pwm_val * 22 / 61) / tmp_bat_val
 369   2              */
 370   2              // D = 1 - (Vi / Vo)
 371   2              // tmp_val = max_pwm_val - (adc_charging_val * max_pwm_val * 22 / 61) / tmp_bat_val;
 372   2              tmp_val = max_pwm_val - ((u32)adc_charging_val * max_pwm_val * 94 / 147) / tmp_bat_val;
 373   2      
 374   2              if (tmp_val >= max_pwm_val)
 375   2              {
 376   3                  // å¦‚æœPWMå ç©ºæ¯”å¯¹åº”çš„å€¼ å¤§äº æœ€å¤§å ç©ºæ¯”å¯¹åº”çš„å€¼ï¼Œè¯´æ˜è®¡ç®—æº¢å‡ºï¼ˆå
             -¯èƒ½æ˜¯ç”µæ± ç”µå‹è¿‡å°ï¼‰ï¼ŒæŒ‰0å¤„ç†
 377   3                  tmp_val = 0;
 378   3              }
 379   2      
 380   2              // æ»¤æ³¢æ“ä½œï¼Œä¸€å¼€å§‹tmp_valä¼šå¾ˆå°ï¼Œé‡‡é›†å¤šæ¬¡åè¶‹äºä¸€ä¸ªå¹³å‡å€¼ï¼š
C51 COMPILER V9.60.7.0   CHARGE                                                            02/27/2025 10:59:10 PAGE 8   

 381   2              tmp_val_cnt++;
 382   2              tmp_val_cnt &= 0x07;
 383   2              tmp_val_l[tmp_val_cnt] = (tmp_val_l[tmp_val_cnt] + tmp_val) >> 1;
 384   2              tmp_val = 0;
 385   2              for (i = 0; i < 8; i++)
 386   2              {
 387   3                  tmp_val += tmp_val_l[i];
 388   3              }
 389   2              tmp_val >>= 3;
 390   2      
 391   2              if (tmp_val > last_pwm_val)
 392   2              {
 393   3                  // last_pwm_val = last_pwm_val + 1;
 394   3                  last_pwm_val++;
 395   3              }
 396   2              else if (tmp_val < last_pwm_val)
 397   2              {
 398   3                  // last_pwm_val = last_pwm_val - 1;
 399   3                  last_pwm_val--;
 400   3              }
 401   2      
 402   2              TMR2_PWML = last_pwm_val % 256;
 403   2              // TMR2_PWMH = last_pwm_val / 256;  // æœ€å¤§å ç©ºæ¯”çš„å€¼ä¸è¶…è¿‡255ï¼Œä¸ºäº†èŠ‚çœç¨‹åºç©ºé—
             -´ï¼Œå¯ä»¥ä¸ç”¨é…ç½®é«˜8ä½çš„å¯„å­˜å™¨
 404   2              TMR2_PWMH = 0;
 405   2      
 406   2              // å……ç”µæ—¶ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å†è°ƒæ•´ä¸€æ¬¡PWMå ç©ºæ¯”ï¼Œå¦åˆ™å……ç”µç”µæµè·³åŠ¨ä¼šå¾ˆå‰å®
             -³
 407   2              delay_ms(100);
 408   2          } // if (flag_is_in_charging)
 409   1      #endif // å……ç”µç”µæµæ§åˆ¶
 410   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    675    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     18      11
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
