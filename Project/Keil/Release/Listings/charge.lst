C51 COMPILER V9.60.7.0   CHARGE                                                            04/30/2025 09:25:19 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE CHARGE
OBJECT MODULE PLACED IN .\Release\Objects\charge.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\App\charge.c OPTIMIZE(9,SIZE) BROWSE INTVECTOR(0X8000) INCDIR(..\.
                    -.\Libraries\Include;..\..\User;..\..\Hardware;..\..\App) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\charge.
                    -lst) OBJECT(.\Release\Objects\charge.obj)

line level    source

   1          #include "charge.h"
*** WARNING C322 IN LINE 71 OF \BaiduSyncdisk\A_WorkSt\Aworkst\2025-01-22-project250122-ËÕĞÀ-°´Ä¦ÒÇÓïÒô¿î-SX384\code\pro
             -ject-250122-TX8C1011\Libraries\Include\debug.h: unknown identifier
   2          #include "tx8c101x.h"
   3          
   4          #if USE_MY_DEBUG
              #include <stdio.h>
              #endif
   7          
   8          extern volatile bit flag_is_in_charging;
   9          extern volatile bit flag_bat_is_full;      // ç”µæ± æ˜¯å¦è¢«å……æ»¡ç”µçš„æ ‡å¿—ä½
  10          extern volatile bit flag_bat_is_near_full; // æ ‡å¿—ä½ï¼Œè¡¨ç¤ºç”µæ± æ˜¯å¦å¿«å……æ»¡ç”µ
  11          extern volatile bit flag_ctl_dev_close;    // æ§åˆ¶æ ‡å¿—ä½ï¼Œæ˜¯å¦è¦å…³é—­è®¾å¤‡
  12          extern volatile bit flag_ctl_led_blink;    // æ§åˆ¶æ ‡å¿—ä½ï¼Œæ˜¯å¦æ§åˆ¶æŒ‡ç¤ºç¯é—ªçƒ
  13          
  14          extern volatile bit flag_tim_scan_maybe_not_charge;
  15          extern volatile bit flag_tim_scan_maybe_in_charging;
  16          extern volatile bit flag_tim_set_is_in_charging;
  17          
  18          extern volatile bit flag_tim_scan_bat_maybe_near_full; // ç”¨äºç»™å®šæ—¶å™¨æ‰«æçš„æ ‡å¿—ä½ï¼Œå¯èƒ½æ£€
             -æµ‹åˆ°ç”µæ± å¿«è¢«å……æ»¡ç”µ
  19          extern volatile bit flag_tim_set_bat_is_near_full;     // ç”±å®šæ—¶å™¨ç½®ä½/å¤ä½çš„ï¼Œè¡¨ç¤ºç”µæ± æ˜¯å
             -¦å¿«è¢«å……æ»¡ç”µçš„æ ‡å¿—ä½
  20          
  21          extern volatile bit flag_tim_scan_bat_maybe_full; // ç”¨äºç»™å®šæ—¶å™¨æ‰«æçš„æ ‡å¿—ä½ï¼Œå¯èƒ½æ£€æµ‹åˆ
             -°ç”µæ± è¢«å……æ»¡ç”µ
  22          extern volatile bit flag_tim_set_bat_is_full;     // ç”±å®šæ—¶å™¨ç½®ä½/å¤ä½çš„ï¼Œè¡¨ç¤ºç”µæ± æ˜¯å¦è¢«å
             -……æ»¡ç”µçš„æ ‡å¿—ä½
  23          
  24          // ç”¨äºç»™å®šæ—¶å™¨æ‰«æçš„æ ‡å¿—ä½ï¼Œå¯èƒ½æ£€æµ‹åˆ°äº†ä½ç”µé‡
  25          // ä¼šåœ¨å¼€æœºå·¥ä½œæ—¶ æ›´æ–°è¯¥æ ‡å¿—ä½çš„çŠ¶æ€ï¼Œåœ¨å……ç”µæ—¶æ¸…é™¤æ ‡å¿—ä½
  26          extern volatile bit flag_tim_scan_maybe_low_bat;
  27          extern volatile bit flag_tim_set_bat_is_low; // ç”±å®šæ—¶å™¨ç½®ä½/å¤ä½çš„ï¼Œè¡¨ç¤ºåœ¨å·¥ä½œæ—¶ï¼Œç”µæ± 
             -æ˜¯å¦å¤„äºä½ç”µé‡çš„æ ‡å¿—ä½
  28          extern volatile bit flag_ctl_low_bat_alarm;  // æ§åˆ¶æ ‡å¿—ä½ï¼Œæ˜¯å¦ä½¿èƒ½ä½ç”µé‡æŠ¥è­¦
  29          
  30          // extern volatile bit flag_tim_scan_maybe_shut_down; // ç”¨äºç»™å®šæ—¶å™¨æ‰«æçš„æ ‡å¿—ä½ï¼Œå¯èƒ½æ£€æ
             -µ‹åˆ°äº† ç”µæ± ç”µå‹ ä½äº å…³æœºå¯¹åº”çš„ç”µå‹
  31          // extern volatile bit flag_tim_set_shut_down;        // ç”±å®šæ—¶å™¨ç½®ä½/å¤ä½çš„ï¼Œè¡¨ç¤ºåœ¨å·¥ä½œæ—¶
             -ï¼Œæ£€æµ‹åˆ°äº† ç”µæ± ç”µå‹ åœ¨ä¸€æ®µæ—¶é—´å†…éƒ½ä½äº å…³æœºå¯¹åº”çš„ç”µå‹
  32          
  33          extern volatile bit flag_is_disable_to_open; // æ ‡å¿—ä½ï¼Œæ˜¯å¦ä¸ä½¿èƒ½å¼€æœº(ä½ç”µé‡ä¸å…è®¸å¼€æœº
             -)
  34          
  35          extern volatile bit flag_is_enter_low_power; // æ ‡å¿—ä½ï¼Œæ˜¯å¦è¦è¿›å…¥ä½åŠŸè€—
  36          
  37          extern volatile bit flag_tim_scan_maybe_motor_stalling; // ç”¨äºç»™å®šæ—¶å™¨æ‰«æçš„æ ‡å¿—ä½ï¼Œå¯èƒ½æ£
             -€æµ‹åˆ°äº†ç”µæœºå µè½¬
  38          
  39          extern volatile bit flag_is_adjust_current_time_comes;
  40          
  41          // å……ç”µæ‰«æä¸æ£€æµ‹
  42          /**
C51 COMPILER V9.60.7.0   CHARGE                                                            04/30/2025 09:25:19 PAGE 2   

  43           * @brief    å……ç”µã€ç”µæ± çš„æ‰«æå’Œç›¸å…³å¤„ç†
  44                       å¦‚æœä¸€ä¸Šç”µæ£€æµ‹åˆ°ç”µæ± ä¸ºç©ºï¼Œä¸èƒ½è°ƒç”¨è¯¥å‡½æ•°
  45                       é™¤äº†å®šæ—¶å™¨ï¼Œå¯ä¾›å¤–éƒ¨æ£€æµ‹çš„æ ‡å¿—ä½ï¼š
  46                          flag_is_in_charging
  47                          flag_bat_is_full
  48           */
  49          void charge_scan_handle(void)
  50          {
  51   1          volatile u16 adc_bat_val = 0;      // å­˜æ”¾æ£€æµ‹åˆ°çš„ç”µæ± ç”µå‹çš„adcå€¼
  52   1          volatile u16 adc_charging_val = 0; // å­˜æ”¾æ£€æµ‹åˆ°çš„å……ç”µç”µå‹çš„adcå€¼
  53   1          static u8 over_charging_cnt = 0;   // å­˜æ”¾è¿‡å……è®¡æ•°
  54   1      
  55   1          adc_sel_channel(ADC_CHANNEL_BAT); // åˆ‡æ¢åˆ°æ£€æµ‹ç”µæ± é™å‹åçš„ç”µå‹çš„æ£€æµ‹å¼•è„š
  56   1          adc_bat_val = adc_get_val();      // æ›´æ–°ç”µæ± å¯¹åº”çš„adå€¼
  57   1      
  58   1          adc_sel_channel(ADC_CHANNEL_CHARGE); // åˆ‡æ¢åˆ°æ£€æµ‹å……ç”µçš„ç”µå‹æ£€æµ‹å¼•è„š(æ£€æµ‹åˆ°çš„å……ç”µç
             -”µå‹ == USB-Cå£ç”µå‹ / 2)
  59   1          adc_charging_val = adc_get_val();    // æ›´æ–°å½“å‰æ£€æµ‹åˆ°çš„å……ç”µç”µå‹å¯¹åº”çš„adå€¼
  60   1      
  61   1          // printf("bat val %u\n", adc_bat_val);
  62   1          // printf("charge val %u\n", adc_charging_val);
  63   1      
  64   1          // ä½ç”µé‡ä¸å…è®¸å¼€æœº
  65   1          if (adc_bat_val < LOW_BAT_ALARM_AD_VAL)
  66   1          {
  67   2              flag_is_disable_to_open = 1;
  68   2          }
  69   1          // else if (adc_bat_val > (LOW_BAT_ALARM_AD_VAL + 15))
  70   1          else
  71   1          {
  72   2              flag_is_disable_to_open = 0;
  73   2              flag_tim_scan_maybe_low_bat = 0;
  74   2          }
  75   1      
  76   1          if (flag_is_in_charging)
  77   1          {
  78   2              // å¦‚æœæ­£åœ¨å……ç”µï¼Œæ£€æµ‹ç”µæ± æ˜¯å¦å……æ»¡ç”µ
  79   2      
  80   2      #if 1 // æ£€æµ‹åœ¨å……ç”µæ—¶ï¼Œç”µæ± æ˜¯å¦å……æ»¡ç”µï¼Œå¹¶åšç›¸åº”çš„å¤„ç†
  81   2      
  82   2              if (0 == flag_bat_is_full)
  83   2              {
  84   3                  // å¦‚æœæ­£åœ¨å……ç”µï¼Œä¸”ç”µæ± æœªå……æ»¡ç”µï¼Œæ£€æµ‹ç”µè§†æ˜¯å¦å¿«å……æ»¡ç”µ æˆ–æ˜¯ ç”µæ± å…
             -…æ»¡ç”µ
  85   3      
  86   3                  // å¦‚æœæ£€æµ‹åˆ°å……æ»¡ç”µï¼ˆå¯èƒ½è§¦å‘äº†ç”µæ± ä¿æŠ¤æ¿çš„è¿‡å……ä¿æŠ¤ï¼‰ï¼Œç›´æ¥è¾“å‡º0
             -%çš„PWM
  87   3                  if (adc_bat_val >= (ADCDETECT_BAT_FULL + ADCDETECT_BAT_NULL_EX))
  88   3                  {
  89   4                      // å¦‚æœæ£€æµ‹åˆ°çš„adå€¼æ¯” æ»¡ç”µçš„adå€¼ è¿˜è¦å¤š
  90   4                      // PWMå ç©ºæ¯”è®¾ç½®ä¸º0ï¼Œè®©å ç©ºæ¯”é‡æ–°å¼€å§‹é€’å¢ï¼Œç”µæµä»é›¶å¼€å§‹é€æ¸å¢å¤
             -§
  91   4                      TMR2_PWML = 0; // å ç©ºæ¯” 0%
  92   4                      TMR2_PWMH = 0;
  93   4                      over_charging_cnt++; // è¿‡å……æ£€æµ‹è®¡æ•°åŠ ä¸€
  94   4                      // flag_tim_scan_bat_maybe_full = 1; // (å¯ä»¥ä¸ç”¨ç»™è¿™ä¸ªæ ‡å¿—ä½ç½®ä¸€ï¼Œè¿™é‡Œåªæ
             -˜¯æµ‹è¯•æ—¶ä½¿ç”¨)
  95   4                  }
  96   3                  else if (adc_bat_val >= ADCDETECT_BAT_FULL) // æ£€æµ‹ç”µæ± æ˜¯å¦æ»¡ç”µ
  97   3                  {
  98   4                      // ç»™å¯¹åº”çš„æ ‡å¿—ä½ç½®ä¸€ï¼Œè®©å®šæ—¶å™¨æ¥æ£€æµ‹æ˜¯å¦æŒç»­ä¸€æ®µæ—¶é—´éƒ½æ˜¯æ»¡ç”µ
  99   4                      flag_tim_scan_bat_maybe_full = 1;
C51 COMPILER V9.60.7.0   CHARGE                                                            04/30/2025 09:25:19 PAGE 3   

 100   4                  }
 101   3                  else if (adc_bat_val >= ADCVAL_NEAR_FULL_CHAGE) // æ£€æµ‹åˆ°æœ‰ä¸€æ¬¡ç”µæ± å¿«å……æ»¡ç”µ
 102   3                  {
 103   4                      // å¦‚æœç”µæ± å¿«å……æ»¡ç”µ
 104   4                      flag_tim_scan_bat_maybe_near_full = 1; // è¡¨ç¤ºç”µæ± å¿«å……æ»¡ç”µ
 105   4                  }
 106   3                  else
 107   3                  {
 108   4                      // å¦‚æœæ£€æµ‹åˆ°çš„adå€¼å°äºæ»¡ç”µé˜ˆå€¼
 109   4                      // æ¸…ç©ºå¯¹åº”çš„æ ‡å¿—ä½ï¼Œè®©å®šæ—¶å™¨ä¸æ£€æµ‹æ˜¯å¦æ»¡ç”µ
 110   4                      flag_tim_scan_bat_maybe_full = 0;
 111   4                      flag_tim_scan_bat_maybe_near_full = 0;
 112   4                  }
 113   3      
 114   3                  if (flag_tim_set_bat_is_near_full && 0 == flag_bat_is_near_full)
 115   3                  {
 116   4                      // å¦‚æœç”µæ± æ¥è¿‘æ»¡ç”µï¼Œå…³é—­å……ç”µæ—¶çš„å‘¼å¸ç¯ï¼Œç‚¹äº®ç»¿ç¯ï¼Œä½†æ˜¯ä¸å…³é—­
             -æ§åˆ¶å……ç”µçš„PWM
 117   4                      flag_bat_is_near_full = 1;
 118   4                      delay_ms(1);    // å¿…é¡»è¦ç­‰å¾…å®šæ—¶å™¨å…³é—­å……ç”µæ—¶é—ªçƒçš„å‘¼å¸ç¯
 119   4                      LED_RED_OFF();  // å…³é—­å……ç”µæ—¶é—ªçƒçš„å‘¼å¸ç¯
 120   4                      LED_GREEN_ON(); // å¿«å……æ»¡ç”µæ—¶ï¼Œè®©ç»¿ç¯å¸¸äº®
 121   4                  }
 122   3      
 123   3                  if (flag_tim_set_bat_is_full || (over_charging_cnt >= 8))
 124   3                  // if (flag_tim_set_bat_is_full) // æµ‹è¯•æ—¶ä½¿ç”¨åˆ°çš„æ¡ä»¶
 125   3                  {
 126   4                      // å¦‚æœå®šæ—¶å™¨æ£€æµ‹äº†ä¸€æ®µæ—¶é—´(5s)ï¼Œéƒ½æ˜¯å……æ»¡ç”µçš„çŠ¶æ€ï¼Œæˆ–ç€æ˜¯ç´¯è®¡æœ
             -‰è¿‡å……ï¼Œè¯´æ˜ç”µæ± å……æ»¡ç”µ
 127   4                      over_charging_cnt = 0; // æ¸…é™¤è¿‡å……è®¡æ•°
 128   4                      flag_bat_is_full = 1;  // è¡¨ç¤ºç”µæ± è¢«å……æ»¡ç”µ
 129   4                      tmr2_pwm_disable();    // å…³é—­æ§åˆ¶å‡å‹ç”µè·¯çš„pwm
 130   4                      TMR2_PWML = 0;         // å ç©ºæ¯” 0%
 131   4                      TMR2_PWMH = 0;         //
 132   4                      // flag_is_in_charging = 0; // ä¸èƒ½ç»™è¿™ä¸ªæ ‡å¿—ä½æ¸…é›¶ï¼ˆäº¤ç»™å……ç”µæ‰«ææ¥æ¸…é›
             -¶ï¼‰
 133   4                      // delay_ms(1);    // å¯èƒ½è¦ç­‰å¾…å®šæ—¶å™¨å…³é—­å……ç”µæ—¶é—ªçƒçš„å‘¼å¸ç¯
 134   4                      LED_RED_OFF();  // å…³é—­å……ç”µæ—¶é—ªçƒçš„å‘¼å¸ç¯
 135   4                      LED_GREEN_ON(); // å……æ»¡ç”µæ—¶ï¼Œè®©ç»¿ç¯å¸¸äº®
 136   4                  }
 137   3              } // if (0 == flag_bat_is_full)
 138   2      
 139   2      #endif // æ£€æµ‹åœ¨å……ç”µæ—¶ï¼Œç”µæ± æ˜¯å¦å……æ»¡ç”µï¼Œå¹¶åšç›¸åº”çš„å¤„ç†
 140   2      
 141   2      #if 1 // (è¿™ä¸ªåŠŸèƒ½è¦æ”¾åœ¨è¯¥è¯­å¥å—çš„æœ€å)æ£€æµ‹åœ¨å……ç”µæ—¶ï¼Œæ˜¯å¦æ‹”å‡ºäº†å……ç”µçº¿ï¼Œå¹¶å
             -šç›¸åº”çš„å¤„ç†
 142   2            // å¦‚æœæ­£åœ¨å……ç”µï¼Œæ£€æµ‹æ˜¯å¦æ‹”å‡ºäº†å……ç”µçº¿
 143   2              if (adc_charging_val < ADCDETECT_CHARING_THRESHOLD)
 144   2              {
 145   3                  // ç»™å¯¹åº”çš„æ ‡å¿—ä½ç½®ä¸€ï¼Œå¦‚æœè¿ç»­ xx mséƒ½æ˜¯è¿™ä¸ªçŠ¶æ€ï¼Œè¯´æ˜æ‹”å‡ºäº†å……ç”µå
             -™¨
 146   3                  flag_tim_scan_maybe_not_charge = 1;
 147   3              }
 148   2              else
 149   2              {
 150   3                  flag_tim_scan_maybe_not_charge = 0;
 151   3              }
 152   2      
 153   2              if (0 == flag_tim_set_is_in_charging) // å¦‚æœå®šæ—¶å™¨è¿ç»­ 50 ms éƒ½æ˜¯æ£€æµ‹åˆ°æ‹”å‡ºäº†å……ç”
             -µå™¨
 154   2              {
 155   3                  // å¦‚æœåœ¨å……ç”µæ—¶ï¼Œæ£€æµ‹åˆ°æ‹”å‡ºäº†å……ç”µçº¿
C51 COMPILER V9.60.7.0   CHARGE                                                            04/30/2025 09:25:19 PAGE 4   

 156   3                  flag_is_in_charging = 0;
 157   3      
 158   3                  // æ¸…ç©ºå……ç”µæ—¶ä½¿ç”¨çš„æ ‡å¿—ä½å’Œå˜é‡ï¼š
 159   3                  flag_tim_scan_bat_maybe_full = 0;
 160   3                  flag_tim_scan_bat_maybe_near_full = 0;
 161   3                  // flag_tim_set_bat_is_full = 0; // å¯ä»¥ä¸ç”¨æ¸…é›¶è¿™ä¸ªå˜é‡ï¼Œå®šæ—¶å™¨åç»­ä¼šè‡ªåŠ¨æ
             -¸…é›¶
 162   3                  flag_bat_is_near_full = 0;
 163   3                  flag_bat_is_full = 0;
 164   3                  over_charging_cnt = 0; // æ¸…é™¤è¿‡å……è®¡æ•°
 165   3      
 166   3                  flag_is_enter_low_power = 1; // å…è®¸è¿›å…¥ä½åŠŸè€—
 167   3      
 168   3                  // å¯ä»¥äº¤ç»™ä½åŠŸè€—å‡½æ•°æ¥å…³é—­PWMï¼š
 169   3                  // tmr2_pwm_disable(); // å…³é—­æ§åˆ¶å……ç”µçš„PWMè¾“å‡º
 170   3                  delay_ms(1); // ç­‰å¾…å®šæ—¶å™¨æ¸…ç©ºç›¸åº”çš„å˜é‡å’Œæ ‡å¿—ä½
 171   3                               // å¯ä»¥äº¤ç»™ä½åŠŸè€—å‡½æ•°æ¥å…³ç¯ï¼š
 172   3                               // LED_GREEN_OFF();
 173   3                               // LED_RED_OFF();
 174   3      
 175   3      #if USE_MY_DEBUG
                          printf("uncharging\n");
              #endif // #if USE_MY_DEBUG
 178   3      
 179   3                  // return; // é€€å‡ºå‡½æ•°ï¼Œé˜²æ­¢å†æ‰§è¡Œä¸‹é¢çš„åŠŸèƒ½
 180   3              }
 181   2      #endif // æ£€æµ‹åœ¨å……ç”µæ—¶ï¼Œæ˜¯å¦æ‹”å‡ºäº†å……ç”µçº¿ï¼Œå¹¶åšç›¸åº”çš„å¤„ç†
 182   2      
 183   2          } // if (flag_is_in_charging)
 184   1          else // å¦‚æœä¸åœ¨å……ç”µ
 185   1          {
 186   2      
 187   2      #if 1 // åœ¨è®¾å¤‡å·¥ä½œæ—¶ï¼Œæ£€æµ‹æ˜¯å¦å¤„äºä½ç”µé‡ï¼Œå¹¶è¿›è¡Œç›¸åº”å¤„ç†
 188   2      
 189   2              // if (0 != cur_motor_status || 0 != cur_ctl_heat_status)
 190   2              if (SPEECH_CTL_PIN_OPEN == SPEECH_CTL_PIN) /* å¦‚æœè¯­éŸ³ICè¿˜åœ¨å·¥ä½œï¼Œè¯´æ˜æ²¡æœ‰è¿›å…¥ä½åŠ
             -Ÿè€— */
 191   2              {
 192   3                  // å¦‚æœè®¾å¤‡åœ¨å·¥ä½œ
 193   3                  if (adc_bat_val <= LOW_BAT_ALARM_AD_VAL)
 194   3                  {
 195   4                      // å¦‚æœç”µæ± ç”µå‹ å°äºç­‰äº ä½ç”µé‡æŠ¥è­¦å¯¹åº”çš„ç”µå‹
 196   4                      flag_tim_scan_maybe_low_bat = 1;
 197   4                      // flag_tim_scan_maybe_shut_down = 0; // å½“å‰ç”µæ± ç”µå‹æ­£å¤„äº å…³æœºç”µå‹ ~ ä½ç”µ
             -é‡ä¹‹é—´ï¼Œè¿˜æ²¡åˆ°è¦å…³æœºçš„æƒ…å†µ
 198   4                  }
 199   3                  else
 200   3                  {
 201   4                      // å¦‚æœç”µæ± ç”µå‹ å¤§äº ä½ç”µé‡æŠ¥è­¦å¯¹åº”çš„ç”µå‹
 202   4                      flag_tim_scan_maybe_low_bat = 0;
 203   4                      // flag_tim_scan_maybe_shut_down = 0;
 204   4                  }
 205   3      
 206   3                  // å¦‚æœè¿ç»­ä¸€æ®µæ—¶é—´æ£€æµ‹åˆ°ç”µæ± ç”µå‹ä½äºå…³æœºç”µå‹
 207   3                  // if (flag_tim_set_shut_down)
 208   3                  // {
 209   3                  //     flag_ctl_dev_close = 1;
 210   3                  //     // SPEECH_POWER_DISABLE(); // å…³é—­è¯­éŸ³ICçš„ç”µæº(åœ¨ä½åŠŸè€—å‡½æ•°å†…å…³é—­)
 211   3                  //     flag_is_enter_low_power = 1; // å…è®¸è¿›å…¥ä½åŠŸè€—
 212   3                  // }
 213   3                  // else if (flag_tim_set_bat_is_low && 0 == flag_ctl_low_bat_alarm)
 214   3                  if (flag_tim_set_bat_is_low &&
C51 COMPILER V9.60.7.0   CHARGE                                                            04/30/2025 09:25:19 PAGE 5   

 215   3                      0 == flag_ctl_low_bat_alarm &&
 216   3                      0 == flag_is_enter_low_power &&
 217   3                      0 == flag_tim_scan_maybe_motor_stalling) /* å¦‚æœç”µæœºæœªå µè½¬ */
 218   3                  {
 219   4                      // å¦‚æœè¿ç»­ä¸€æ®µæ—¶é—´æ£€æµ‹åˆ°ç”µæ± ç”µå‹å¤„äºä½ç”µé‡ï¼Œå¹¶ä¸”æ²¡æœ‰æ‰“å¼€ä½ç”µ
             -é‡æŠ¥è­¦
 220   4                      interrupt_led_blink(); // å…³é—­LEDé—ªçƒ
 221   4                      LED_GREEN_OFF();
 222   4                      LED_RED_OFF();
 223   4                      flag_ctl_low_bat_alarm = 1; // ä½¿èƒ½ä½ç”µé‡æŠ¥è­¦
 224   4                  }
 225   3              }
 226   2      #endif // åœ¨è®¾å¤‡å·¥ä½œæ—¶ï¼Œæ£€æµ‹æ˜¯å¦å¤„äºä½ç”µé‡ï¼Œå¹¶è¿›è¡Œç›¸åº”å¤„ç†
 227   2      
 228   2      #if 1 // æ£€æµ‹ä¸åœ¨å……ç”µæ—¶ï¼Œæ˜¯å¦æœ‰æ’å…¥å……ç”µçº¿ï¼Œå¹¶åšç›¸åº”çš„å¤„ç†
 229   2            // å¦‚æœä¸åœ¨å……ç”µï¼Œæ£€æµ‹æ˜¯å¦æ’å…¥äº†å……ç”µçº¿
 230   2              if (adc_charging_val >= ADCDETECT_CHARING_THRESHOLD)
 231   2              {
 232   3                  // ç»™å¯¹åº”çš„æ ‡å¿—ä½ç½®ä¸€ï¼Œå¦‚æœç´¯è®¡ 50 ms éƒ½æ˜¯è¿™ä¸ªçŠ¶æ€ï¼Œè¯´æ˜æ’å…¥äº†å……ç”µ
             -å™¨
 233   3                  flag_tim_scan_maybe_in_charging = 1;
 234   3              }
 235   2              else
 236   2              {
 237   3                  flag_tim_scan_maybe_in_charging = 0;
 238   3              }
 239   2      
 240   2              if (flag_tim_set_is_in_charging) // å¦‚æœå®šæ—¶å™¨ç´¯è®¡ 50 mséƒ½æ˜¯æ£€æµ‹åˆ°æ’å…¥äº†å……ç”µå™¨
 241   2              {
 242   3                  // ç¡®è®¤æ˜¯æ’å…¥å……ç”µçº¿åï¼Œæ— è®ºå¤„äºä»€ä¹ˆçŠ¶æ€ï¼Œéƒ½å˜ä¸ºå…³æœºçŠ¶æ€
 243   3                  flag_is_in_charging = 1;
 244   3      
 245   3                  // æ¸…ç©ºä¸å……ç”µæ—¶ä½¿ç”¨çš„å˜é‡å’Œæ ‡å¿—ä½
 246   3                  flag_tim_scan_maybe_low_bat = 0; // è¡¨ç¤ºä¸å¤„äºä½ç”µé‡
 247   3                  flag_ctl_low_bat_alarm = 0;      // å…³é—­ä½ç”µé‡æŠ¥è­¦
 248   3      
 249   3      #if USE_MY_DEBUG
                          printf("charging\n");
              #endif // #if USE_MY_DEBUG
 252   3      
 253   3                  // åœ¨æµ‹è¯•æ—¶å…³é—­
 254   3                  tmr2_pwm_enable();           // ä½¿èƒ½PWMè¾“å‡º
 255   3                  flag_ctl_dev_close = 1;      // æ§åˆ¶æ ‡å¿—ä½ç½®ä¸€ï¼Œè®©ä¸»å‡½æ•°æ‰«æåˆ°ï¼Œå¹¶å…³æœº
 256   3                  flag_is_enter_low_power = 0; // ä¸è¿›å…¥ä½åŠŸè€—
 257   3      
 258   3                  // flag_ctl_led_blink = 0; // æ‰“æ–­å½“å‰çš„ç¯å…‰é—ªçƒæ•ˆæœ
 259   3                  // delay_ms(1);
 260   3                  interrupt_led_blink();
 261   3                  LED_GREEN_OFF(); // å…³é—­ç»¿ç¯(å¦‚æœç­‰åˆ°ä¸»å¾ªç¯æ‰«æåˆ°å†å…³é—­ç»¿ç¯ï¼Œç¬¬1msä¼šå‡ºç
             -°çº¢ç¯å’Œç»¿ç¯ä¸€èµ·ç‚¹äº®çš„æƒ…å†µ)
 262   3              }
 263   2      #endif // æ£€æµ‹ä¸åœ¨å……ç”µæ—¶ï¼Œæ˜¯å¦æœ‰æ’å…¥å……ç”µçº¿ï¼Œå¹¶åšç›¸åº”çš„å¤„ç†
 264   2          }
 265   1      
 266   1      #if 1 // å……ç”µç”µæµæ§åˆ¶
 267   1      
 268   1          // if (flag_is_in_charging && 0 == flag_bat_is_full)
 269   1          if (flag_is_in_charging)
 270   1          {
 271   2      #if 0 // ä½¿ç”¨è®¡ç®—çš„æ–¹å¼æ¥è°ƒèŠ‚å……ç”µç”µæµ
              
                      u8 i = 0;                             // å¾ªç¯è®¡æ•°å€¼
C51 COMPILER V9.60.7.0   CHARGE                                                            04/30/2025 09:25:19 PAGE 6   

                      const u8 max_pwm_val = TMR2_PRL + 1;  // ä¸´æ—¶å­˜æ”¾æœ€å¤§å ç©ºæ¯”å¯¹åº”çš„å€¼
                      volatile u8 last_pwm_val = TMR2_PWML; // è®°å½•ä¹‹å‰çš„pwmå ç©ºæ¯”çš„å€¼
                      volatile u16 tmp_val;                 // ä¸´æ—¶å­˜æ”¾éœ€è¦è°ƒèŠ‚çš„å ç©ºæ¯”å¯¹åº”çš„å€¼
                      volatile u16 tmp_bat_val;             // å­˜æ”¾æ£€æµ‹åˆ°çš„ç”µæ± ç”µå‹+è®¡ç®—çš„å‹å·®å¯¹åº”çš„ad
             -cå€¼(å¯ä»¥ä¸åˆå§‹åŒ–)
                      static volatile u16 tmp_val_l[8] = {0};
                      static volatile u8 tmp_val_cnt = 0;
              
                      tmp_bat_val = adc_bat_val;
              // tmp_bat_val = (u32)adc_bat_val - ((u32)adc_bat_val * 157 / 1000);
              // tmp_bat_val = (u32)adc_bat_val - ((u32)adc_bat_val * 800 / 1000);
              // tmp_bat_val += 2300;
              #if 1
                      if (adc_bat_val <= 2752) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 6.5Vï¼ˆå®é™…æµ‹è¯•ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µå…
             -…ç”µé€Ÿåº¦ä¼šå¾ˆå¿«ï¼Œæµ‹ä¸å‡ºç¨³å®šå……ç”µæ—¶çš„ç”µæµï¼‰
                      {
                          // tmp_bat_val = (adc_bat_val + (37)); /*  */
                          // tmp_bat_val += ((37 + 25)); /*  */
                          // tmp_bat_val += ((37 + 35)); /*  */
                          tmp_bat_val += ((80)); /*  */
                          // tmp_bat_val += ((37 + 50)); /*   */
                          // tmp_bat_val += ((37 + 70)); /*  */
                          // tmp_bat_val = (adc_bat_val + (37 + 40)); /* 6.40--1.07ï¼Œ */
                      }
                      else if (adc_bat_val <= 2837) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 6.7V
                      {
                          // tmp_bat_val = (adc_bat_val + (40)); /*  6.6--0.93 */
                          // tmp_bat_val += (20);
                          // tmp_bat_val += (25);
                          tmp_bat_val += (60); /*  */
                          // tmp_bat_val += (70); /*  */
                          // tmp_bat_val += (80); /*  */
                          // tmp_bat_val += (90); /*  */
                          // tmp_bat_val += (100); /*  */
                          // tmp_bat_val += (30);
                          // tmp_bat_val += (40);
                      }
                      else if (adc_bat_val <= 2964) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 7.0V
                      {
                          // tmp_bat_val -= 150;
                          // tmp_bat_val = (adc_bat_val + (40)); /*  6.6--0.93 */
                          tmp_bat_val += (20); /*  */
                          // tmp_bat_val += (40); /*  */
              
                          // tmp_bat_val += (200); /*  */
                          // tmp_bat_val += (400); /*  */
                          // tmp_bat_val += (480); /*  */
                          // tmp_bat_val += (500); /*  */
                          // tmp_bat_val += (600); /*  */
                      }
                      else if (adc_bat_val <= 3091) // å¦‚æœåšæŒç”µæ± ç”µå‹å°äº 7.3V
                      {
                          // tmp_bat_val = (adc_bat_val + 16);
                          // tmp_bat_val += (10);
                          // tmp_bat_val -= (5);
                          // tmp_bat_val -= (10); /* åˆ°äº†7.2V--1.3A */
                          // tmp_bat_val -= (15);
                          // tmp_bat_val -= (20);
                          tmp_bat_val -= 25; /* 7.23--1.16 */
                          // tmp_bat_val -= (30); /* 7.17--0.97 */
                      }
              #endif
C51 COMPILER V9.60.7.0   CHARGE                                                            04/30/2025 09:25:19 PAGE 7   

                      // else if (adc_bat_val <= 3227) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 7.62V
                      // else
                      // {
                      //     // tmp_bat_val = (adc_bat_val + (0));
                      //     // tmp_bat_val += (0);
                      //     // tmp_bat_val -= 60;
              
                      //     // tmp_bat_val -=25;
                      //     // u16 tmp_u16 = (adc_bat_val - 3091) / 2;
                      //     // for (i = 0; i < tmp_u16; i++)
                      //     // {
                      //     //     tmp_bat_val--;
                      //     // }
                      //     #if 0
                      //     // ç”µæ± ç”µå‹è¶Šå¤§ï¼Œéœ€è¦ä¿®æ”¹çš„è¡¥å¿å€¼è¶Šå¤§ï¼Œé€šè¿‡å¾ªç¯æ¥å¤„ç†
                      //     u16 tmp_u16 = (adc_bat_val - 3091) / 2;
                      //     for (i = 0; i < tmp_u16; i++)
                      //     {
                      //         // tmp_bat_val -= 1;
                      //         tmp_bat_val -= 2;
                      //         // tmp_bat_val -= 3;// åˆ°åé¢ç”µæ± ç”µå‹è¶Šé«˜ï¼Œç”µæµè¶Šå°
                      //         // tmp_bat_val -= 4; // åˆ°åé¢ç”µæ± ç”µå‹è¶Šé«˜ï¼Œç”µæµè¶Šå°
                      //     }
              
                      //     // tmp_bat_val += 40;
                      //     // tmp_bat_val += 80;
                      //     // tmp_bat_val += 120;
                      //     // tmp_bat_val += 130; // 0.8-0.9A
                      //     // tmp_bat_val += 140;
                      //     // tmp_bat_val += 145;
                      //     tmp_bat_val += 150;
                      //     // tmp_bat_val += 160;
                      //     #endif
              
                      /*
                          å®é™…æµ‹è¯•ï¼Œè¿™é‡Œç”µå‹å‡é«˜åï¼Œç”µæµä¹Ÿä¼šå¿«é€Ÿå¢åŠ :
                      */
                      //     // tmp_bat_val -= -0.762(adc_bat_val - 3091) + 79;
                      //     u16 tmp = (u32)(adc_bat_val - 3091) * 381 / 500;
                      //     if (tmp >= 79) // å¦‚æœadc_bat_valå¤§äºç­‰äº3195ï¼Œç”µæ± ä¸€ä¾§ç”µå‹è‡³å°‘å¤§äº7.54
                      //     {
                      //         tmp_bat_val -= (tmp - 79); /*  */
                      //         // tmp_bat_val += (tmp - 79); /* è¿™é‡Œçš„è®¡ç®—è¿˜æœ‰é—®é¢˜ï¼Œç”µæµä¼šåˆ°2.3A */
                      //     }
                      //     else
                      //     {
                      //         tmp_bat_val -= (79 - tmp) ;
                      //     }
                      // }
                      else // å¦‚æœåœ¨å……ç”µæ—¶æ£€æµ‹åˆ°ç”µæ± ç”µå‹å¤§äº
                      {
                          // tmp_bat_val = (u32)adc_bat_val - ((u32)adc_bat_val * 157 / 1000 - 522);
                          // tmp_bat_val -= ((u32)adc_bat_val * 157 / 1000 - 522);
                          // tmp_bat_val -= ((u32)adc_bat_val * 157 / 1000 - 500);
                          // tmp_bat_val -= ((u32)adc_bat_val * 157 / 1000 - 480);
                          // tmp_bat_val -= ((u32)adc_bat_val * 157 / 1000 - 480);
                          // tmp_bat_val += 100; // 7.45å·¦å³ï¼Œ0.51A
                          // tmp_bat_val += 160; //  7.45--0.573
              
                          // tmp_bat_val += 200; //
                          // tmp_bat_val -= ((u32)adc_bat_val * 360 / 1000);
              
C51 COMPILER V9.60.7.0   CHARGE                                                            04/30/2025 09:25:19 PAGE 8   

                          // tmp_bat_val -= 45;
                          // tmp_bat_val -= 55;
              
                          u16 tmp = adc_bat_val - 3091;
                          // tmp_bat_val += 150;
                          // tmp_bat_val += 200;
                          tmp_bat_val += 225;
                          // tmp_bat_val += 250;
                          // tmp_bat_val += 300;
                          while (1)
                          {
                              // if (tmp > 3)
                              // {
                              //     // adå€¼æ¯å˜åŒ–3å°±è¡¥å¿5
                              //     tmp -= 3;
                              //     tmp_bat_val -= 5;
                              // }
                              if (tmp > 4)
                              {
                                  tmp -= 4;
                                  tmp_bat_val -= 5;
                              }
                              else
                              {
                                  break;
                              }
                          }
              
                          // tmp_bat_val = (u32)adc_bat_val - ((u32)adc_bat_val * 157 / 1000 - 522) + (15); /* å®é™…æµ‹
             -è¯•ï¼Œåœ¨æœ€åå‡å»215çš„è¡¥å¿ä¸‹ï¼Œ */
                      }
              
                      /* tmp_bat_valè¶Šå¤§ï¼Œæœ€ç»ˆå……ç”µç”µæµä¹Ÿä¼šè¶Šå¤§ï¼Œè¿™é‡Œè¦å¯¹å®ƒåšè¡¥å¿ï¼Œtmp_bat_valè¶Šå
             -¤§ï¼Œè¡¥å¿ä¹Ÿè¦ç›¸åº”å¢å¤§ */
                      // tmp_bat_val = (u32)adc_bat_val - ((u32)adc_bat_val * 800 / 1000);
                      // tmp_bat_val += 15;
                      // tmp_bat_val += 25;
                      // tmp_bat_val += 50;
                      // tmp_bat_val += 100;
                      // tmp_bat_val += 115;
                      // tmp_bat_val += 200;
                      // tmp_bat_val += 350;
                      // tmp_bat_val += 400;
                      // tmp_bat_val += 500;
                      // tmp_bat_val += 600;
                      // tmp_bat_val += 800;
                      // tmp_bat_val += 1000;
                      // tmp_bat_val += 1100;
                      // tmp_bat_val += 1200;
                      // tmp_bat_val += 2000;
                      // tmp_bat_val += 2100;
                      // tmp_bat_val += 2200;
                      // tmp_bat_val += 2300;
                      // tmp_bat_val += 2500;
              
              #if 1  // è¡¥å¿å¼€å…³
                      {
                          // u16 i;
                          // for (i = 0; i < 50; i++) //
                          // for (i = 0; i < 80; i++) //
                          for (i = 0; i < 120; i++) // ===================
                          // for (i = 0; i < 125; i++) //
C51 COMPILER V9.60.7.0   CHARGE                                                            04/30/2025 09:25:19 PAGE 9   

                          // for (i = 0; i < 150; i++) //
                          // for (i = 0; i < 300; i++) //
                          // for (i = 0; i < 1000; i++) //
                          {
                              if (tmp_bat_val > 2) // tmp_bat_valä¸èƒ½ç­‰äº0
                              {
                                  tmp_bat_val--;
                              }
                          }
                      }
              #endif // è¡¥å¿å¼€å…³
              
                      if (adc_bat_val >= 3472) // å¤§äº8.2V,å°†ç”µæµè°ƒèŠ‚è‡³500-600mA
                      {
                          // tmp_bat_val -= 20;
                      }
              
                      tmp_val = max_pwm_val - ((u32)adc_charging_val * max_pwm_val * 94 / 147) / tmp_bat_val;
              
                      // é‡æ–°è®¡ç®—äº†åˆ†å‹ç³»æ•°çš„å…¬å¼ï¼ˆå®é™…æµ‹è¯•å‘ç°ç”µæµä¼šæ¯”æœªé‡æ–°è®¡ç®—çš„ï¼Œç”µæµ
             -è¿˜è¦å¤§ï¼Œæ–œç‡ä¹Ÿæ›´å¤§ï¼‰ï¼š
                      // tmp_val = max_pwm_val - ((u32)adc_charging_val * max_pwm_val * 165 / 266) / tmp_bat_val;
              
                      if (tmp_val >= max_pwm_val)
                      {
                          // å¦‚æœPWMå ç©ºæ¯”å¯¹åº”çš„å€¼ å¤§äº æœ€å¤§å ç©ºæ¯”å¯¹åº”çš„å€¼ï¼Œè¯´æ˜è®¡ç®—æº¢å‡ºï¼ˆå
             -¯èƒ½æ˜¯ç”µæ± ç”µå‹è¿‡å°ï¼‰ï¼ŒæŒ‰0å¤„ç†
                          tmp_val = 0;
                      }
              
                      // æ»¤æ³¢æ“ä½œï¼Œä¸€å¼€å§‹tmp_valä¼šå¾ˆå°ï¼Œé‡‡é›†å¤šæ¬¡åè¶‹äºä¸€ä¸ªå¹³å‡å€¼ï¼š
                      // å¦‚æœä¸æ»¤æ³¢ï¼Œå……ç”µç”µæµä¼šé¢‘ç¹è·³åŠ¨
                      tmp_val_cnt++;
                      tmp_val_cnt &= 0x07;
                      tmp_val_l[tmp_val_cnt] = (tmp_val_l[tmp_val_cnt] + tmp_val) >> 1;
                      tmp_val = 0;
                      for (i = 0; i < 8; i++)
                      {
                          tmp_val += tmp_val_l[i];
                      }
                      tmp_val >>= 3;
              
                      if ((u8)tmp_val > last_pwm_val)
                      {
                          // last_pwm_val = last_pwm_val + 1;
                          last_pwm_val++;
                      }
                      else if ((u8)tmp_val < last_pwm_val)
                      // else // ä¸èƒ½ç›´æ¥ç”¨elseï¼Œå¦‚æœå‡åˆ°0è¿˜åœ¨ç»§ç»­å‡å°ï¼Œä¼šå¯¼è‡´æ•°æ®æº¢å‡º
                      {
                          // last_pwm_val = last_pwm_val - 1;
                          if (last_pwm_val > 1) // é˜²æ­¢å‡åˆ°0è¿˜åœ¨ç»§ç»­å‡ï¼Œå¯¼è‡´æº¢å‡º
                              last_pwm_val--;
                      }
              
                      TMR2_PWML = last_pwm_val % 256;
                      // TMR2_PWMH = last_pwm_val / 256;  // æœ€å¤§å ç©ºæ¯”çš„å€¼ä¸è¶…è¿‡255ï¼Œä¸ºäº†èŠ‚çœç¨‹åºç©ºé—
             -´ï¼Œå¯ä»¥ä¸ç”¨é…ç½®é«˜8ä½çš„å¯„å­˜å™¨
                      TMR2_PWMH = 0;
              
                      // å……ç”µæ—¶ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å†è°ƒæ•´ä¸€æ¬¡PWMå ç©ºæ¯”ï¼Œå¦åˆ™å……ç”µç”µæµè·³åŠ¨ä¼šå¾ˆå‰å®
             -³
C51 COMPILER V9.60.7.0   CHARGE                                                            04/30/2025 09:25:19 PAGE 10  

                      // delay_ms(100);
              
              #endif // ä½¿ç”¨è®¡ç®—çš„æ–¹å¼æ¥è°ƒèŠ‚å……ç”µç”µæµ
 517   2      
 518   2      #if 1
 519   2              u8 i = 0;
 520   2              u8 last_pwm_val = TMR2_PWML;     // è¯»å‡ºä¸Šä¸€æ¬¡PWMå ç©ºæ¯”å¯¹åº”çš„å€¼
 521   2              const u8 max_pwm_val = TMR2_PRL; // è¯»å‡ºPWMå ç©ºæ¯”è®¾å®šçš„ã€æœ€å¤§çš„å€¼
 522   2              u16 tmp_bat_val = adc_bat_val;
 523   2              static u8 tmp_val_cnt = 0;
 524   2              u32 tmp_val;
 525   2              static u8 tmp_val_l[8] = 0;
 526   2      
 527   2              // last_pwm_val = TMR2_PWML + ((u16)TMR2_PWMH << 7);  // è¯»å‡ºä¸Šä¸€æ¬¡PWMå ç©ºæ¯”å¯¹åº”çš„å€¼
 528   2              // max_pwm_val = TMR2_PRL + ((u16)TMR2_PRH << 7) + 1; // è¯»å‡ºPWMå ç©ºæ¯”è®¾å®šçš„ã€æœ€å¤§çš„å€
             -¼
 529   2      
 530   2              if (adc_bat_val <= 2752) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 6.5V
 531   2              {
 532   3                  // tmp_bat_val = (adc_bat_val + 37);
 533   3                  tmp_bat_val += 37;
 534   3              }
 535   2              else if (adc_bat_val <= 2964) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 7.0V
 536   2              {
 537   3                  // tmp_bat_val = (adc_bat_val + 27);
 538   3                  tmp_bat_val += 27; // +=27ï¼Œæœ€åå†+=95ï¼Œåªæœ‰0.22A
 539   3                  // tmp_bat_val += 127;
 540   3              }
 541   2              else if (adc_bat_val <= 3091) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 7.3V
 542   2              {
 543   3                  // tmp_bat_val = (adc_bat_val + 16);
 544   3                  tmp_bat_val += 16;
 545   3              }
 546   2              else if (adc_bat_val <= 3227) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 7.62V
 547   2              {
 548   3                  // tmp_bat_val = (adc_bat_val + 0);
 549   3              }
 550   2              else // å¦‚æœåœ¨å……ç”µæ—¶æ£€æµ‹åˆ°ç”µæ± ç”µå‹å¤§äº
 551   2              {
 552   3                  // tmp_bat_val = (u32)adc_bat_val - ((u32)adc_bat_val * 157 / 1000 - 522);
 553   3                  tmp_bat_val -= ((u32)adc_bat_val * 157 / 1000 - 506);
 554   3              }
 555   2      
 556   2              // tmp_bat_val += 55; //
 557   2              // tmp_bat_val += 75; //
 558   2              // tmp_bat_val += 95; // ç§»æ¤è¿‡æ¥åï¼ŒåŸæœ¬æ˜¯åŠ 95
 559   2              // tmp_bat_val += 150; //
 560   2              // tmp_bat_val += 300; //
 561   2              // tmp_bat_val += 600; //
 562   2              tmp_bat_val += 900; //
 563   2      
 564   2              if (adc_bat_val >= 3515) // å¦‚æœç”µæ± ç”µå‹å¤§äº 8.3V ï¼Œé™ä½å……ç”µç”µæµ
 565   2              {
 566   3                  tmp_bat_val -= 40;
 567   3              }
 568   2      
 569   2              tmp_val = max_pwm_val - ((u32)adc_charging_val * max_pwm_val * 94 / 147) / tmp_bat_val;
 570   2      
 571   2              if (tmp_val >= max_pwm_val)
 572   2              {
 573   3                  // å¦‚æœPWMå ç©ºæ¯”å¯¹åº”çš„å€¼ å¤§äº æœ€å¤§å ç©ºæ¯”å¯¹åº”çš„å€¼ï¼Œè¯´æ˜è®¡ç®—æº¢å‡ºï¼ˆå
             -¯èƒ½æ˜¯ç”µæ± ç”µå‹è¿‡å°ï¼‰ï¼ŒæŒ‰0å¤„ç†
C51 COMPILER V9.60.7.0   CHARGE                                                            04/30/2025 09:25:19 PAGE 11  

 574   3                  tmp_val = 0;
 575   3              }
 576   2      
 577   2              // æ»¤æ³¢æ“ä½œï¼Œä¸€å¼€å§‹tmp_valä¼šå¾ˆå°ï¼Œé‡‡é›†å¤šæ¬¡åè¶‹äºä¸€ä¸ªå¹³å‡å€¼ï¼š
 578   2              tmp_val_cnt++;
 579   2              tmp_val_cnt &= 0x07;
 580   2              tmp_val_l[tmp_val_cnt] = (tmp_val_l[tmp_val_cnt] + tmp_val) >> 1;
 581   2              tmp_val = 0;
 582   2              for (i = 0; i < 8; i++)
 583   2              {
 584   3                  tmp_val += tmp_val_l[i];
 585   3              }
 586   2              tmp_val >>= 3;
 587   2      
 588   2              // {
 589   2              //     /*
 590   2              //         å¦‚æœå·®å€¼è¿‡å¤§ï¼Œåˆ™å¿«é€Ÿè°ƒèŠ‚ï¼Œå¦‚æœå·®å€¼è¿‡å°ï¼Œåˆ™æ…¢é€Ÿè°ƒèŠ‚ï¼Œ
 591   2              //         é˜²æ­¢ç”µæµçªå˜ï¼Œå¯¼è‡´ä¸åŒçš„æ¿å­æœ€ç»ˆå……ç”µç”µæµä¸ä¸€è‡´
 592   2              //     */
 593   2              //     static u8 cnt = 0;
 594   2              //     cnt++;
 595   2      
 596   2              //     if (tmp_val > last_pwm_val)
 597   2              //     {
 598   2              //         if ((tmp_val - last_pwm_val) > 2 || cnt >= 10)
 599   2              //         {
 600   2              //             last_pwm_val++;
 601   2              //             cnt = 0;
 602   2              //         }
 603   2              //     }
 604   2              //     else if (tmp_val < last_pwm_val)
 605   2              //     {
 606   2              //         if ((last_pwm_val - tmp_val) > 2 || cnt >= 10)
 607   2              //         {
 608   2              //             last_pwm_val--;
 609   2              //             cnt = 0;
 610   2              //         }
 611   2              //     }
 612   2              // }
 613   2      
 614   2              if (flag_is_adjust_current_time_comes)
 615   2              {
 616   3                  flag_is_adjust_current_time_comes = 0;
 617   3                  if ((u8)tmp_val > last_pwm_val)
 618   3                  // if (tmp_val > last_pwm_val)
 619   3                  {
 620   4                      // last_pwm_val = last_pwm_val + 1;
 621   4                      last_pwm_val++;
 622   4                  }
 623   3                  else if ((u8)tmp_val < last_pwm_val)
 624   3                  // else if (tmp_val < last_pwm_val)
 625   3                  {
 626   4                      // last_pwm_val = last_pwm_val - 1;
 627   4                      last_pwm_val--;
 628   4                  }
 629   3              }
 630   2      
 631   2              // T2DATA = last_pwm_val;
 632   2      
 633   2              // printf("last_pwm_val %u\n",last_pwm_val);
 634   2              TMR2_PWML = last_pwm_val;
 635   2              // TMR2_PWML = last_pwm_val % 256;
C51 COMPILER V9.60.7.0   CHARGE                                                            04/30/2025 09:25:19 PAGE 12  

 636   2              // TMR2_PWMH = last_pwm_val / 256;
 637   2              TMR2_PWMH = 0;
 638   2      
 639   2      #endif
 640   2      
 641   2          } // if (flag_is_in_charging)
 642   1      #endif // å……ç”µç”µæµæ§åˆ¶
 643   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    687    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     10      13
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
