C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Release\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\main.c OPTIMIZE(9,SIZE) BROWSE INTVECTOR(0X8000) INCDIR(..\..
                    -\Libraries\Include;..\..\User;..\..\Hardware;..\..\App) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\main.lst
                    -) OBJECT(.\Release\Objects\main.obj)

line level    source

   1          /**
   2           ******************************************************************************
   3           * @file    main.c
   4           * @author  HUGE-IC Application Team
   5           * @version V1.0.0
   6           * @date    01-05-2021
   7           * @brief   Main program body
   8           ******************************************************************************
   9           * @attention
  10           *
  11           * <h2><center>&copy; COPYRIGHT 2021 HUGE-IC</center></h2>
  12           *
  13           * °æÈ¨ËµÃ÷ºóÐø²¹ÉÏ
  14           *
  15           ******************************************************************************
  16           */
  17          
  18          #include "include.h"
  19          #include "my_config.h"
  20          
  21          volatile bit flag_bat_is_empty = 0;     // ±êÖ¾Î»£¬ÓÃÓÚ¼ì²âÊÇ·ñ°Î³öÁËµç³Ø
  22          volatile bit flag_bat_is_near_full = 0; // ±êÖ¾Î»£¬±íÊ¾µç³ØÊÇ·ñ¿ì³äÂúµç
  23          volatile bit flag_bat_is_full = 0;      // µç³ØÊÇ·ñ±»³äÂúµçµÄ±êÖ¾Î»
  24          
  25          volatile bit flag_is_in_charging = 0;               // ÊÇ·ñ´¦ÓÚ³äµçµÄ±êÖ¾Î»
  26          volatile bit flag_tim_scan_maybe_not_charge = 0;    // ÓÃÓÚ¸ø¶¨Ê±Æ÷É¨ÃèµÄ±êÖ¾Î»£¬¿ÉÄÜ¼ì²âµ½ÁË°Î³ö³äµçÆ÷
  27          volatile bit flag_tim_scan_maybe_in_charging = 0;   // ÓÃÓÚ¸ø¶¨Ê±Æ÷É¨ÃèµÄ±êÖ¾Î»£¬¿ÉÄÜ¼ì²âµ½ÁË³äµçÆ÷
  28          volatile bit flag_tim_set_is_in_charging = 0;       // ÓÉ¶¨Ê±Æ÷ÖÃÎ»/¸´Î»µÄ£¬±íÊ¾ÊÇ·ñÓÐ²åÈë³äµçÆ÷µÄ±êÖ¾Î»
  29          volatile bit flag_tim_scan_bat_maybe_full = 0;      // ÓÃÓÚ¸ø¶¨Ê±Æ÷É¨ÃèµÄ±êÖ¾Î»£¬¿ÉÄÜ¼ì²âµ½µç³Ø±»³äÂúµç
  30          volatile bit flag_tim_set_bat_is_full = 0;          // ÓÉ¶¨Ê±Æ÷ÖÃÎ»/¸´Î»µÄ£¬±íÊ¾µç³ØÊÇ·ñ±»³äÂúµçµÄ±êÖ¾Î»
  31          volatile bit flag_tim_scan_bat_maybe_near_full = 0; // ÓÃÓÚ¸ø¶¨Ê±Æ÷É¨ÃèµÄ±êÖ¾Î»£¬¿ÉÄÜ¼ì²âµ½µç³Ø¿ì±»³äÂúµç
  32          volatile bit flag_tim_set_bat_is_near_full = 0;     // ÓÉ¶¨Ê±Æ÷ÖÃÎ»/¸´Î»µÄ£¬±íÊ¾µç³ØÊÇ·ñ¿ì±»³äÂúµçµÄ±êÖ¾Î»
  33          
  34          volatile bit flag_tim_scan_maybe_low_bat = 0; // ÓÃÓÚ¸ø¶¨Ê±Æ÷É¨ÃèµÄ±êÖ¾Î»£¬¿ÉÄÜ¼ì²âµ½ÁËµÍµçÁ¿
  35          volatile bit flag_tim_set_bat_is_low = 0;     // ÓÉ¶¨Ê±Æ÷ÖÃÎ»/¸´Î»µÄ£¬±íÊ¾ÔÚ¹¤×÷Ê±£¬µç³ØÊÇ·ñ´¦ÓÚµÍµçÁ¿µÄ±ê
             -Ö¾Î»
  36          
  37          volatile bit flag_tim_scan_maybe_shut_down = 0; // ÓÃÓÚ¸ø¶¨Ê±Æ÷É¨ÃèµÄ±êÖ¾Î»£¬¿ÉÄÜ¼ì²âµ½ÁË µç³ØµçÑ¹ µÍÓÚ ¹Ø
             -»ú¶ÔÓ¦µÄµçÑ¹
  38          volatile bit flag_tim_set_shut_down = 0;        // ÓÉ¶¨Ê±Æ÷ÖÃÎ»/¸´Î»µÄ£¬±íÊ¾ÔÚ¹¤×÷Ê±£¬¼ì²âµ½ÁË µç³ØµçÑ¹ ÔÚ
             -Ò»¶ÎÊ±¼äÄÚ¶¼µÍÓÚ ¹Ø»ú¶ÔÓ¦µÄµçÑ¹
  39          
  40          volatile bit flag_tim_scan_maybe_motor_stalling = 0; // ÓÃÓÚ¸ø¶¨Ê±Æ÷É¨ÃèµÄ±êÖ¾Î»£¬¿ÉÄÜ¼ì²âµ½ÁËµç»ú¶Â×ª
  41          volatile bit flag_tim_set_motor_stalling = 0;        // ÓÉ¶¨Ê±Æ÷ÖÃÎ»/¸´Î»µÄ£¬±íÊ¾ÔÚ¹¤×÷Ê±¼ì²âµ½ÁËµç»ú¶Â×ª
  42          
  43          volatile bit flag_is_enable_key_scan = 0; // ±êÖ¾Î»£¬ÊÇ·ñÊ¹ÄÜ°´¼üÉ¨Ãè(Ã¿10ms±»¶¨Ê±Æ÷ÖÃÎ»£¬ÔÚÖ÷º¯ÊýÖÐ¼ì²â²¢
             -ÇåÁã)
  44          // volatile bit flag_is_dev_open = 0;        // £¨Ö»ÔÚ³¤°´¿ª»ú¡¢¹Ø»úÊ±Ê¹ÓÃ£©Éè±¸ÊÇ·ñ¿ª»úµÄ±êÖ¾Î»£¬0--Î´¿ª»
             -ú£¬1--¿ª»ú
  45          
  46          volatile bit flag_ctl_led_blink = 0; // ¿ØÖÆ±êÖ¾Î»£¬ÊÇ·ñ¿ØÖÆÖ¸Ê¾µÆÉÁË¸
  47          volatile bit flag_ctl_turn_dir = 0;  // ¿ØÖÆ±êÖ¾Î»£¬ÊÇ·ñ¸ü»»µç»úµÄ·½Ïò
  48          
C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 2   

  49          volatile bit flag_ctl_dev_close = 0; // ¿ØÖÆ±êÖ¾Î»£¬ÊÇ·ñÒª¹Ø±ÕÉè±¸
  50          
  51          volatile bit flag_ctl_low_bat_alarm = 0; // ¿ØÖÆ±êÖ¾Î»£¬ÊÇ·ñÊ¹ÄÜµÍµçÁ¿±¨¾¯
  52          
  53          volatile bit flag_is_disable_to_open = 0; // ±êÖ¾Î»£¬ÊÇ·ñ²»Ê¹ÄÜ¿ª»ú(µÍµçÁ¿²»ÔÊÐí¿ª»ú)
  54          
  55          volatile bit flag_is_recv_ctl = 0; // ±êÖ¾Î»£¬ÊÇ·ñ½ÓÊÕÁË¿ØÖÆÃüÁî
  56          /*
  57              ±êÖ¾Î»£¬ÊÇ·ñÍ¨¹ýÓïÒôÀ´ÇÐ»»·½Ïò.
  58              ÓÃÔÚ¶¨Ê±Æ÷ÖÐ¶ÏÖÐ£¬ÅÐ¶Ï×Ô¶¯»»·½Ïò£¬Èç¹ûÕâ¸ö±êÖ¾Î»ÖÃÒ»£¬
  59              »áÇå³ýµ±Ç°×Ô¶¯»»·½ÏòµÄ¼ÆÊ±£¬ÖØÐÂ¿ªÊ¼×Ô¶¯»»·½ÏòµÄ¼ÆÊ±,
  60              ¶¨Ê±Æ÷Çå³ý¼ÆÊ±ºó£¬»á¸øÕâ¸ö±êÖ¾Î»ÇåÁã
  61          */
  62          volatile bit flag_is_turn_dir_by_speech = 0;
  63          
  64          /*
  65              ±êÖ¾Î»£¬ÊÇ·ñ½ÓÊÕµ½ÁËÐÂµÄÓïÒôÐÅÏ¢/ÓÐÐÂµÄ°´¼ü²Ù×÷
  66              ÓÃÔÚ¶¨Ê±Æ÷ÖÐ¶Ï£¬ÔÚÍ¨¹ýÓïÒô¹Ø±ÕÉè±¸ºó£¬Ò»¶ÎÊ±¼äÎÞ²Ù×÷¶ø³¹µ×¹Ø»ú
  67              Èç¹ûÕâ¸ö±êÖ¾Î»ÖÃÒ»£¬ÔÚ¶¨Ê±Æ÷ÄÚ»áÇå³ý×Ô¶¯³¹µ×¹Ø»úµÄµ¹¼ÆÊ±£¬
  68              ¶¨Ê±Æ÷ÔÚÇå³ý¼ÆÊ±ºó£¬»á¸øÕâ¸ö±êÖ¾Î»ÇåÁã
  69          */
  70          volatile bit flag_is_new_operation = 0;
  71          
  72          volatile bit flag_is_enter_low_power = 0; // ±êÖ¾Î»£¬ÊÇ·ñÒª½øÈëµÍ¹¦ºÄ
  73          
  74          #if 1
  75          // ¿ØÖÆº¯Êý£¬¿ª»ú
  76          void fun_ctl_power_on(void)
  77          {
  78   1          alter_motor_speed(2); // ¿ª»úºó£¬µç»ú½øÈë¶þµµ
  79   1      
  80   1          motor_pwm_b_enable(); // µç»úÕýÏò×ª¶¯
  81   1      
  82   1          // cur_motor_dir = 1;    // ±íÊ¾µ±Ç°µç»úÔÚÕý×ª
  83   1          cur_motor_status = 2; // ¸üÐÂµç»úµ²Î»×´Ì¬
  84   1      
  85   1          // ÈÃÂÌµÆÉÁË¸
  86   1          LED_GREEN_ON();
  87   1          cur_sel_led = CUR_SEL_LED_GREEN;
  88   1      
  89   1          cur_ctl_led_blink_cnt = cur_motor_status; // ledÉÁË¸´ÎÊýÓëµ±Ç°µç»úµÄµ²Î»ÓÐ¹Ø
  90   1      
  91   1          flag_ctl_led_blink = 1; // ´ò¿ªLEDÉÁË¸µÄ¹¦ÄÜ
  92   1      }
  93          
  94          // ¿ØÖÆº¯Êý£¬¹Ø»ú
  95          void fun_ctl_power_off(void)
  96          {
  97   1          // alter_motor_speed(0); ¹Ø»ú£¨ºÃÏñ¿ÉÒÔ²»Ð´ÕâÒ»Ìõ£©
  98   1      
  99   1          // ¹Ø±ÕµÆ¹âÉÁË¸µÄ¶¯»­
 100   1          // flag_ctl_led_blink = 0;
 101   1          // delay_ms(1); // µÈ´ý¶¨Ê±Æ÷ÖÐ¶ÏÄÚ²¿Çå¿ÕÉÁË¸¹¦ÄÜ¶ÔÓ¦µÄ±êÖ¾ºÍ±äÁ¿£¬·ñÔò´ò¶ÏÉÁµÆµÄÐ§¹û»á±ä²î
 102   1          interrupt_led_blink();
 103   1          LED_GREEN_OFF();
 104   1      
 105   1          if (0 == flag_is_in_charging)
 106   1          {
 107   2              // ²»ÔÚ³äµç£¬²Å¹Ø±ÕºìÉ«LED£¬·ñÔò³äµçÊ±µÄºìÉ«LEDÊµÏÖ²»ÁËºôÎüµÆÐ§¹û
 108   2              LED_RED_OFF();
 109   2          }
 110   1      
C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 3   

 111   1          // ¹Ø±Õ¼ÓÈÈ
 112   1          cur_ctl_heat_status = 0;
 113   1      
 114   1          // ¹Ø±ÕÇý¶¯µç»úµÄPWMÊä³ö£º
 115   1          motor_pwm_disable();
 116   1      
 117   1          // ¹Ø»ú¿ÉÄÜÊÇ ³äµçÊ±½øÈëÁË¹Ø»ú¡¢µÍµçÁ¿½øÈëÁË¹Ø»ú¡¢ÊÖ¶¯¹Ø»ú¡¢×Ô¶¯½øÈëÁË¹Ø»ú
 118   1          // Èç¹ûÊÇ ³äµçÊ±½øÈëÁË¹Ø»ú£¬²»Ó¦¸ÃÇå³ýÏàÓ¦µÄ±êÖ¾Î»
 119   1          if (0 == flag_is_in_charging)
 120   1          {
 121   2              // Èç¹ûÃ»ÓÐÔÚ³äµç£¬Çå¿Õ¸úµÍµçÁ¿²»¿ª»úÎÞ¹ØµÄ±êÖ¾Î»
 122   2              // flag_bat_is_empty = 0;
 123   2              flag_bat_is_near_full = 0;
 124   2              flag_bat_is_full = 0;
 125   2              // flag_tim_scan_maybe_not_charge = 0;
 126   2              // flag_tim_scan_maybe_in_charging = 0;
 127   2              flag_tim_scan_bat_maybe_full = 0;
 128   2              flag_tim_scan_maybe_low_bat = 0;
 129   2              flag_tim_scan_maybe_shut_down = 0;
 130   2              flag_is_enable_key_scan = 0;
 131   2              flag_ctl_low_bat_alarm = 0;
 132   2          }
 133   1      }
 134          
 135          /**
 136           * @brief ¿ØÖÆµç»úµ²Î»
 137           *           Èç¹ûÒª¸ù¾Ý´«²ÎÀ´µ÷½Úµ²Î»£¬»á¸Ä±ä È«¾Ö±äÁ¿ cur_motor_status µÄ×´Ì¬
 138           *
 139           * @param adjust_motor_status Òªµ÷½Úµ½µÄµ²Î»
 140           *                          0--¸ù¾ÝÈ«¾Ö±äÁ¿ cur_motor_status µÄ×´Ì¬À´×Ô¶¯µ÷½Ú
 141           *                          1--µ÷½ÚÎª1µµ
 142           *                          2--µ÷½ÚÎª2µµ
 143           *                          3--µ÷½ÚÎª3µµ
 144           *                          ÆäËû--º¯ÊýÖ±½Ó·µ»Ø £¨ÎªÁË½ÚÊ¡³ÌÐò¿Õ¼ä£¬ÕâÀïÃ»ÓÐ¼Ó£©
 145           */
 146          void fun_ctl_motor_status(u8 adjust_motor_status)
 147          {
 148   1      #if 0  // ¿ÉÒÔ½ÚÊ¡5×Ö½Ú¿Õ¼ä
                  // if (adjust_motor_status > 3)
                  // {
                  //     return; // ´«²ÎÓÐÎó£¬Ö±½Ó·µ»Ø
                  // }
              #endif // ¿ÉÒÔ½ÚÊ¡5×Ö½Ú¿Õ¼ä
 154   1      
 155   1          if (0 == adjust_motor_status)
 156   1          {
 157   2              // Èç¹û²»ÊÇ¸ù¾Ý´«²ÎÀ´µ÷½Úµ²Î»£¬
 158   2              // ¶øÊÇ¸ù¾ÝÈ«¾Ö±äÁ¿cur_motor_statusµÄ×´Ì¬À´µ÷½Ú
 159   2              // if (1 == cur_motor_status)
 160   2              // {
 161   2              //     // ´Ó 1µµ -> 2µµ
 162   2              //     cur_motor_status = 2;
 163   2              // }
 164   2              // else if (2 == cur_motor_status)
 165   2              if (2 == cur_motor_status)
 166   2              {
 167   3                  // ´Ó 2µµ -> 3µµ
 168   3                  cur_motor_status = 3;
 169   3              }
 170   2              else if (3 == cur_motor_status)
 171   2              {
 172   3                  // ´Ó 3µµ -> 1µµ
C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 4   

 173   3                  cur_motor_status = 1;
 174   3              }
 175   2              else
 176   2              {
 177   3                  // 1. ´Ó³õÊ¼×´Ì¬ 0 == cur_motor_status ±äÎª 2 µµ
 178   3                  // 2. »òÕßÊÇ ´Ó 1µµ -> 2µµ
 179   3                  cur_motor_status = 2;
 180   3              }
 181   2          }
 182   1          else
 183   1          {
 184   2              // Èç¹ûÊÇ¸ù¾Ý´«²ÎÀ´µ÷½Úµ²Î»
 185   2              cur_motor_status = adjust_motor_status;
 186   2          }
 187   1      
 188   1          alter_motor_speed(cur_motor_status);
 189   1      
 190   1          // Ã¿´ÎÇÐ»»µ²Î»£¬¶¼ÈÃ¶¨Ê±Æ÷¼ÓÔØ¶¯»­
 191   1          // flag_ctl_led_blink = 0; // ´ò¶Ïµ±Ç°ÕýÔÚÉÁË¸µÄ¹¦ÄÜ
 192   1          // delay_ms(1);            // µÈ´ý¶¨Ê±Æ÷ÖÐ¶ÏÄÚ²¿Çå¿ÕÉÁË¸¹¦ÄÜ¶ÔÓ¦µÄ±êÖ¾ºÍ±äÁ¿£¬·ñÔò´ò¶ÏÉÁµÆµÄÐ§¹û»á±ä²î
 193   1          interrupt_led_blink(); // ´ò¶Ïµ±Ç°ÕýÔÚÖ´ÐÐµÄLEDÉÁË¸¹¦ÄÜ
 194   1      
 195   1          // Èç¹û²»´¦ÓÚµÍµçÁ¿±¨¾¯×´Ì¬£¬²ÅÊ¹ÄÜLEDÉÁË¸¹¦ÄÜ£º
 196   1          if (0 == flag_ctl_low_bat_alarm)
 197   1          {
 198   2              if (0 == cur_ctl_heat_status)
 199   2              {
 200   3                  // Èç¹ûÃ»ÓÐ´ò¿ª¼ÓÈÈ£¬ÈÃÂÌµÆÉÁË¸
 201   3                  LED_RED_OFF();
 202   3                  LED_GREEN_ON();
 203   3                  cur_sel_led = CUR_SEL_LED_GREEN;
 204   3              }
 205   2              else
 206   2              {
 207   3                  // Èç¹û´ò¿ªÁË¼ÓÈÈ£¬ÈÃºìµÆÉÁË¸
 208   3                  LED_GREEN_OFF();
 209   3                  LED_RED_ON();
 210   3                  cur_sel_led = CUR_SEL_LED_RED;
 211   3              }
 212   2      
 213   2              cur_ctl_led_blink_cnt = cur_motor_status; // ledÉÁË¸´ÎÊýÓëµ±Ç°µç»úµÄµ²Î»ÓÐ¹Ø
 214   2              flag_ctl_led_blink = 1;                   // ´ò¿ªLEDÉÁË¸µÄ¹¦ÄÜ
 215   2          }
 216   1      }
 217          #endif
 218          
 219          void user_config(void)
 220          {
 221   1      #if 0 // Î´ÓÅ»¯³ÌÐò¿Õ¼äµÄ´úÂë£º
                  IE_EA = 1; // Ê¹ÄÜ×ÜÖÐ¶Ï
              
                  // ¼ì²â¿ª»ú/Ä£Ê½°´¼ü ºÍ ¼ì²â¼ÓÈÈ°´¼üµÄÒý½Å£º
                  // key_config();
                  // ÉÏÀ­£º
                  P0_PU |= 0x01 << 7;
                  P1_PU |= 0x01;
                  P0_MD1 &= ~(0x03 << 6); // P07 ÊäÈëÄ£Ê½
                  P1_MD0 &= ~0x03;        // P10 ÊäÈëÄ£Ê½
              
                  // heating_pin_config();    // ¼ÓÈÈ¿ØÖÆÒý½Å
                  P1_MD1 |= 0x01; // ÓÃ P14 ¿ØÖÆ¼ÓÈÈ
              
C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 5   

                                  // speech_ctl_pin_config(); // ¿ØÖÆÓïÒôICµçÔ´µÄÒý½Å
                  // P11
                  P1_MD0 |= 0x01 << 2; // Êä³öÄ£Ê½
              
                  // led_config();
                  // P12¡¢P13¶ÔÓ¦µÄLED¶¼Ê¹ÓÃPWMÀ´Çý¶¯
                  P1_MD0 |= 0xA0; // P12¡¢P13¶¼ÅäÖÃÎª¶à¹¦ÄÜIOÄ£Ê½
                  // P1_AF0 &= ~(0x0F); // (¿ÉÒÔ²»Ð´£¬Ä¬ÈÏ¾ÍÊÇ0)P12¸´ÓÃÎª STMR2_CHB ¡¢P13¸´ÓÃÎª STMR2_CHA
                  // ÅäÖÃSTIMER1
                  STMR2_FCONR = 0x00;          // Ñ¡ÔñÏµÍ³Ê±ÖÓ£¬0·ÖÆµ
                  STMR2_PRH = STMR2_PRE / 256; // ÖÜÆÚÖµ
                  STMR2_PRL = STMR2_PRE % 256;
                  // Õ¼¿Õ±ÈÄ¬ÈÏÎª0£¬²»µãÁÁLED
                  // STMR2_CMPAH = STMR2_PRE / 2 / 256; // Í¨µÀAÕ¼¿Õ±È
                  // STMR2_CMPAL = STMR2_PRE / 2 % 256;
                  // STMR2_CMPBH = STMR2_PRE / 4 / 256; // Í¨µÀBÕ¼¿Õ±È
                  // STMR2_CMPBL = STMR2_PRE / 4 % 256;
                  STMR2_PCONRA = 0x10; // Ê¹ÄÜCHA£¬¼ÆÊýÖµ´óÓÚCHA±È½ÏÖµÊä³ö0£¬Ð¡ÓÚÊä³ö1
                  STMR2_PCONRB = 0x10; // Ê¹ÄÜCHB£¬¼ÆÊýÖµ´óÓÚCHA±È½ÏÖµÊä³ö0£¬Ð¡ÓÚÊä³ö1
                  STMR2_CR |= 0x01;    // Ê¹ÄÜ¸ß¼¶¶¨Ê±Æ÷
              
              
              
                  // tmr0_config();     // 1ms¶¨Ê±Æ÷
                  __EnableIRQ(TMR0_IRQn);                                                     // Ê¹ÄÜtimer0ÖÐ¶Ï
                  TMR0_PRL = TMR0_CNT_TIME;                                                   // ÖÜÆÚÖµ
                  TMR0_CNTL = 0x00;                                                           // Çå³ý¼ÆÊýÖµ
                  TMR0_CONH = 0xA0;                                                           // Ê¹ÄÜ¼ÆÊýÖÐ¶Ï
                  TMR0_CONL = (((0x7 & 0x7) << 5) | ((0x7 & 0x7) << 2) | ((0x1 & 0x3) << 0)); // 128·ÖÆµ£¬ÏµÍ³Ê±ÖÓ£¬coun
             -tÄ£Ê½
              
                  // tmr2_pwm_config(); // ¿ØÖÆÉýÑ¹µÄPWM
                  P0_AF0 &= ~(0x03 << 2);         // ¸´ÓÃÄ£Ê½Ñ¡ÔñÎªTMR2PWMÊä³ö
                  TMR2_PRL = TMR2_CNT_TIME % 256; // ÖÜÆÚÖµ
                  TMR2_PRH = TMR2_CNT_TIME / 256;
                  // Õ¼¿Õ±ÈÅäÖÃ£º£¨²»ÄÜÈ¥µô£¬·ñÔò¸ÕÉÏµç/³äµçÊ±¿ÉÄÜ»áÊÇËæ»úÖµ£¬¶ø²»ÊÇ0£©
                  TMR2_PWML = 0; // Õ¼¿Õ±È 0%
                  TMR2_PWMH = 0;
                  TMR2_CNTL = 0x00; // Çå³ý¼ÆÊýÖµ
                  TMR2_CNTH = 0x00;
                  TMR2_CONL = (((0x0 & 0x7) << 5) | ((0x7 & 0x7) << 2) | ((0x2 & 0x3) << 0)); // 0·ÖÆµ£¬ÏµÍ³Ê±ÖÓ£¬PWMÄ£Ê
             -½
                  // ¹Ø±Õ¶¨Ê±Æ÷2
                  tmr2_pwm_disable();
              
                  // adc_config();
                  // P04 AIN4 ¼ì²â³äµç¿Ú´«¹ýÀ´µÄadÖµ
                  P0_MD1 |= 0x03;        // Ä£ÄâÄ£Ê½
                  P0_AIOEN |= 0x01 << 4; // Ê¹ÄÜÄ£Äâ¹¦ÄÜ
                  // P05 AIN5 ¼ì²âµç³Ø·ÖÑ¹ºóµÄadÖµ
                  P0_MD1 |= 0x03 << 2;   // Ä£ÄâÄ£Ê½
                  P0_AIOEN |= 0x01 << 5; // Ê¹ÄÜÄ£Äâ¹¦ÄÜ
                  // Ê¹ÓÃ P06 AIN06 ¼ì²âµç»úÊÇ·ñ¶Â×ª
                  P1_MD1 |= 0x3 << 4;    // Ä£ÄâÄ£Ê½
                  P1_AIOEN |= 0x01 << 6; // Ê¹ÄÜÄ£Äâ¹¦ÄÜ
                  AIP_CON2 |= 0xC0;      // Ê¹ÄÜADCÖÐCMPÊ¹ÄÜÐÅºÅºÍCMPÐ£×¼¹¦ÄÜ
                  AIP_CON4 |= 0x01;      // Ê¹ÄÜADCÆ«ÖÃµçÁ÷£¬²Î¿¼µçÑ¹Ñ¡ÔñÄÚ²¿2.4V(Note: Ê¹ÓÃÄÚ²¿²Î¿¼Ê±£¬Ð¾Æ¬ÐèÔÚ5VµçÑ¹¹©
             -µçÏÂ)
                  ADC_CFG1 = 0x3C;       // ADCÊ±ÖÓ·ÖÆµ£¬16·ÖÆµ
                  ADC_CFG2 = 0xFF;       // ADC²ÉÑùÊ±ÖÓ£¬256¸öADCÊ±ÖÓ
              
                  // motor_config();  // ¿ØÖÆµç»úµÄÁ½Â·PWM
C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 6   

                  P0_AF0 &= ~0xF0; // P02 ¸´ÓÃÎª STMR1_PWMB£¬P03 ¸´ÓÃÎª STMR1_PWMA
                  // ÅäÖÃSTIMER1
                  STMR1_FCONR = 0x00;          // Ñ¡ÔñÏµÍ³Ê±ÖÓ£¬0·ÖÆµ
                  STMR1_PRH = STMR1_PRE / 256; // ÖÜÆÚÖµ
                  STMR1_PRL = STMR1_PRE % 256;
                  // Õ¼¿Õ±È£¬Ä¬ÈÏÎª0
                  // STMR1_CMPAH = STMR1_PRE / 2 / 256;
                  // STMR1_CMPAL = STMR1_PRE / 2 % 256;
                  // STMR1_CMPBH = STMR1_PRE / 4 / 256;
                  // STMR1_CMPBL = STMR1_PRE / 4 % 256;
                  STMR1_PCONRA = 0x10; // Ê¹ÄÜCHA£¬¼ÆÊýÖµ´óÓÚCHA±È½ÏÖµÊä³ö0£¬Ð¡ÓÚÊä³ö1
                  STMR1_PCONRB = 0x10; // Ê¹ÄÜCHB£¬¼ÆÊýÖµ´óÓÚCHA±È½ÏÖµÊä³ö0£¬Ð¡ÓÚÊä³ö1
                  STMR1_CR |= 0x01;    // Ê¹ÄÜ¸ß¼¶¶¨Ê±Æ÷
                  // ¹Ø±Õ¶¨Ê±Æ÷£¬IOÅäÖÃÎªÊä³öÄ£Ê½£¬Êä³öµÍµçÆ½
                  motor_pwm_disable();
              
                  // uart1_config();
                  // P00 RX
                  P0_MD0 &= ~0x03;
                  P0_MD0 |= 0x02; // ¶à¹¦ÄÜIOÄ£Ê½
                  P0_AF0 &= ~0x03;
                  P0_AF0 |= 0x01;                             // P00 ¸´ÓÃÎª UART1_RX
                  __EnableIRQ(UART1_IRQn);                    // ´ò¿ªUARTÄ£¿éÖÐ¶Ï
                  UART1_BAUD1 = (USER_UART_BAUD >> 8) & 0xFF; // ÅäÖÃ²¨ÌØÂÊ¸ß°ËÎ»
                  UART1_BAUD0 = USER_UART_BAUD & 0xFF;        // ÅäÖÃ²¨ÌØÂÊµÍ°ËÎ»
                  UART1_CON = 0x91;                           // 8bitÊý¾Ý£¬1bitÍ£Ö¹Î»£¬Ê¹ÄÜÖÐ¶Ï
                  UART1_CON |= 0x02;                          // ½ÓÊÕÄ£Ê½
              
              #if 0
                  // ²»Ê¹ÓÃµÄÒý½ÅÅäÖÃÎªÊä³ö£¬Êä³öµÍµçÆ½
                  P1_MD1 |= 0x01 << 2;
                  P15 = 0;
              #endif
              
              #endif // Î´ÓÅ»¯³ÌÐò¿Õ¼äµÄ´úÂë
 329   1      
 330   1          IE_EA = 1; // Ê¹ÄÜ×ÜÖÐ¶Ï
 331   1      
 332   1          // ÉÏÀ­£º
 333   1          // P0_PU |= 0x01 << 7;
 334   1          // P1_PU |= 0x01;
 335   1          P0_PU = 0x80; // P07 ÉÏÀ­
 336   1          P1_PU = 0x01; // P10 ÉÏÀ­
 337   1      
 338   1          /*
 339   1              P03 ¶à¹¦ÄÜIOÄ£Ê½
 340   1              P02 ¶à¹¦ÄÜIOÄ£Ê½
 341   1              P01 ¶à¹¦ÄÜIOÄ£Ê½
 342   1              P00 ¶à¹¦ÄÜIOÄ£Ê½
 343   1          */
 344   1          P0_MD0 = 0xAA;
 345   1          /*
 346   1              P07 ÊäÈëÄ£Ê½ ¼ì²â¿ª»ú/Ä£Ê½ÇÐ»»µÄÒý½Å
 347   1              P06 Ä£ÄâÄ£Ê½ ¼ì²âµç»úÊÇ·ñ¶Â×ª
 348   1              P05 Ä£ÄâÄ£Ê½ ¼ì²âµç³Ø·ÖÑ¹ºóµÄµçÑ¹(Íâ²¿1MÉÏÀ­£¬330KÏÂÀ­)
 349   1              P04 Ä£ÄâÄ£Ê½ ¼ì²âÊÇ·ñÓÐ³äµç(Íâ²¿3.3KÉÏÀ­£¬2.2KÏÂÀ­)
 350   1          */
 351   1          P0_MD1 = 0x3F;
 352   1          /*
 353   1              P13 ¶à¹¦ÄÜIOÄ£Ê½ Çý¶¯ºìÉ«LED
 354   1              P12 ¶à¹¦ÄÜIOÄ£Ê½ Çý¶¯ÂÌÉ«LED
 355   1              P11 Êä³öÄ£Ê½ ¿ØÖÆÓïÒôIC¹©µç
C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 7   

 356   1              P10 ÊäÈëÄ£Ê½ ¼ì²â¼ÓÈÈ°´¼üµÄÒý½Å
 357   1          */
 358   1          // P1_MD0 = 0xA4;
 359   1          P1_MD0 = 0x54; // P12¡¢P13ÊÇÇý¶¯LEDµÄÒý½Å£¬µÆ¹â³õÊ¼×´Ì¬Ó¦¸ÃÊÇ¹Ø±ÕµÄ
 360   1          /*
 361   1              P15 ÊäÈëÄ£Ê½ Íâ²¿2KÉÏÀ­£¬Á¬½Óµ½³äµçC¿ÚµÄ5V£¬10KÏÂÀ­½ÓµØ
 362   1              P14 Êä³öÄ£Ê½ ¿ØÖÆ¼ÓÈÈ
 363   1          */
 364   1          P1_MD1 = 0x01;
 365   1          /*
 366   1              P03 ¸´ÓÃÎª STMR1_PWMA
 367   1              P02 ¸´ÓÃÎª STMR1_PWMB
 368   1              P01 ¸´ÓÃÎª TMR2_PWM
 369   1              P00 ¸´ÓÃÎª UART1_RX
 370   1          */
 371   1          P0_AF0 = 0x01;
 372   1          /*
 373   1              P07 ²»¸´ÓÃ
 374   1              P06 ²»¸´ÓÃ
 375   1              P05 ²»¸´ÓÃ
 376   1              P04 ²»¸´ÓÃ
 377   1          */
 378   1          // P0_AF1 = 0x00; // Ä¬ÈÏ¾ÍÊÇ0,¿ÉÒÔ²»Ð´
 379   1          /*
 380   1              P13 ¸´ÓÃÎª STMR2_CHA
 381   1              P12 ¸´ÓÃÎª STMR2_CHB
 382   1              P11 ²»¸´ÓÃ
 383   1              P10 ²»¸´ÓÃ
 384   1          */
 385   1          // P1_AF0 = 0x00; // Ä¬ÈÏ¾ÍÊÇ0,¿ÉÒÔ²»Ð´
 386   1          /*
 387   1              P15 ²»¸´ÓÃ
 388   1              P14 ²»¸´ÓÃ
 389   1          */
 390   1          // P1_AF1 = 0x00; // Ä¬ÈÏ¾ÍÊÇ0,¿ÉÒÔ²»Ð´
 391   1      
 392   1          /*
 393   1              Ö»Ê¹ÄÜ P04¡¢P05ºÍP06 µÄÄ£Äâ¹¦ÄÜ
 394   1          */
 395   1          P0_AIOEN = (0x01 << 4) | (0x01 << 5) | (0x01 << 6); //
 396   1      
 397   1          // P12¡¢P13¶ÔÓ¦µÄLED¶¼Ê¹ÓÃPWMÀ´Çý¶¯
 398   1          LED_GREEN_OFF();
 399   1          LED_RED_OFF();
 400   1          // ÅäÖÃSTIMER1
 401   1          STMR2_FCONR = 0x00;          // Ñ¡ÔñÏµÍ³Ê±ÖÓ£¬0·ÖÆµ
 402   1          STMR2_PRH = STMR2_PRE / 256; // ÖÜÆÚÖµ
 403   1          STMR2_PRL = STMR2_PRE % 256;
 404   1          // Õ¼¿Õ±ÈÄ¬ÈÏÎª0£¬²»µãÁÁLED
 405   1          // STMR2_CMPAH = STMR2_PRE / 2 / 256; // Í¨µÀAÕ¼¿Õ±È
 406   1          // STMR2_CMPAL = STMR2_PRE / 2 % 256;
 407   1          // STMR2_CMPBH = STMR2_PRE / 4 / 256; // Í¨µÀBÕ¼¿Õ±È
 408   1          // STMR2_CMPBL = STMR2_PRE / 4 % 256;
 409   1          STMR2_PCONRA = 0x10; // Ê¹ÄÜCHA£¬¼ÆÊýÖµ´óÓÚCHA±È½ÏÖµÊä³ö0£¬Ð¡ÓÚÊä³ö1
 410   1          STMR2_PCONRB = 0x10; // Ê¹ÄÜCHB£¬¼ÆÊýÖµ´óÓÚCHA±È½ÏÖµÊä³ö0£¬Ð¡ÓÚÊä³ö1
 411   1          STMR2_CR |= 0x01;    // Ê¹ÄÜ¸ß¼¶¶¨Ê±Æ÷
 412   1      
 413   1          __EnableIRQ(TMR0_IRQn);                                                     // Ê¹ÄÜtimer0ÖÐ¶Ï
 414   1          TMR0_PRL = TMR0_CNT_TIME;                                                   // ÖÜÆÚÖµ
 415   1          TMR0_CNTL = 0x00;                                                           // Çå³ý¼ÆÊýÖµ
 416   1          TMR0_CONH = 0xA0;                                                           // Ê¹ÄÜ¼ÆÊýÖÐ¶Ï
 417   1          TMR0_CONL = (((0x7 & 0x7) << 5) | ((0x7 & 0x7) << 2) | ((0x1 & 0x3) << 0)); // 128·ÖÆµ£¬ÏµÍ³Ê±ÖÓ£¬coun
C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 8   

             -tÄ£Ê½
 418   1      
 419   1          // ¿ØÖÆÉýÑ¹µÄPWM
 420   1          TMR2_PRL = TMR2_CNT_TIME % 256; // ÖÜÆÚÖµ
 421   1          TMR2_PRH = TMR2_CNT_TIME / 256;
 422   1          // Õ¼¿Õ±ÈÅäÖÃ£º£¨²»ÄÜÈ¥µô£¬·ñÔò¸ÕÉÏµç/³äµçÊ±¿ÉÄÜ»áÊÇËæ»úÖµ£¬¶ø²»ÊÇ0£©
 423   1          TMR2_PWML = 0; // Õ¼¿Õ±È 0%
 424   1          TMR2_PWMH = 0;
 425   1          // TMR2_CNTL = 0x00; // Çå³ý¼ÆÊýÖµ
 426   1          // TMR2_CNTH = 0x00;
 427   1          TMR2_CONL = (((0x0 & 0x7) << 5) | ((0x7 & 0x7) << 2) | ((0x2 & 0x3) << 0)); // 0·ÖÆµ£¬ÏµÍ³Ê±ÖÓ£¬PWMÄ£Ê
             -½
 428   1          // ¹Ø±Õ¶¨Ê±Æ÷2
 429   1          tmr2_pwm_disable();
 430   1      
 431   1          AIP_CON2 |= 0xC0; // Ê¹ÄÜADCÖÐCMPÊ¹ÄÜÐÅºÅºÍCMPÐ£×¼¹¦ÄÜ
 432   1          AIP_CON4 |= 0x01; // Ê¹ÄÜADCÆ«ÖÃµçÁ÷£¬²Î¿¼µçÑ¹Ñ¡ÔñÄÚ²¿2.4V(Note: Ê¹ÓÃÄÚ²¿²Î¿¼Ê±£¬Ð¾Æ¬ÐèÔÚ5VµçÑ¹¹©µçÏÂ)
 433   1          ADC_CFG1 = 0x3C;  // ADCÊ±ÖÓ·ÖÆµ£¬16·ÖÆµ
 434   1          ADC_CFG2 = 0xFF;  // ADC²ÉÑùÊ±ÖÓ£¬256¸öADCÊ±ÖÓ
 435   1      
 436   1          // ÅäÖÃSTIMER1
 437   1          STMR1_FCONR = 0x00;          // Ñ¡ÔñÏµÍ³Ê±ÖÓ£¬0·ÖÆµ
 438   1          STMR1_PRH = STMR1_PRE / 256; // ÖÜÆÚÖµ
 439   1          STMR1_PRL = STMR1_PRE % 256;
 440   1          // Õ¼¿Õ±È£¬Ä¬ÈÏÎª0
 441   1          // STMR1_CMPAH = STMR1_PRE / 2 / 256;
 442   1          // STMR1_CMPAL = STMR1_PRE / 2 % 256;
 443   1          // STMR1_CMPBH = STMR1_PRE / 4 / 256;
 444   1          // STMR1_CMPBL = STMR1_PRE / 4 % 256;
 445   1          STMR1_PCONRA = 0x10; // Ê¹ÄÜCHA£¬¼ÆÊýÖµ´óÓÚCHA±È½ÏÖµÊä³ö0£¬Ð¡ÓÚÊä³ö1
 446   1          STMR1_PCONRB = 0x10; // Ê¹ÄÜCHB£¬¼ÆÊýÖµ´óÓÚCHA±È½ÏÖµÊä³ö0£¬Ð¡ÓÚÊä³ö1
 447   1          STMR1_CR |= 0x01;    // Ê¹ÄÜ¸ß¼¶¶¨Ê±Æ÷
 448   1          // ¹Ø±Õ¶¨Ê±Æ÷£¬IOÅäÖÃÎªÊä³öÄ£Ê½£¬Êä³öµÍµçÆ½
 449   1          motor_pwm_disable();
 450   1      
 451   1          // P00 RX
 452   1          __EnableIRQ(UART1_IRQn);                    // ´ò¿ªUARTÄ£¿éÖÐ¶Ï
 453   1          UART1_BAUD1 = (USER_UART_BAUD >> 8) & 0xFF; // ÅäÖÃ²¨ÌØÂÊ¸ß°ËÎ»
 454   1          UART1_BAUD0 = USER_UART_BAUD & 0xFF;        // ÅäÖÃ²¨ÌØÂÊµÍ°ËÎ»
 455   1          // UART1_CON = 0x91;                           // 8bitÊý¾Ý£¬1bitÍ£Ö¹Î»£¬Ê¹ÄÜÖÐ¶Ï
 456   1          // UART1_CON |= 0x02;                          // ½ÓÊÕÄ£Ê½
 457   1          UART1_CON = 0x93; // 8bitÊý¾Ý£¬1bitÍ£Ö¹Î»£¬Ê¹ÄÜÖÐ¶Ï,½ÓÊÕÄ£Ê½
 458   1      }
 459          
 460          void main(void)
 461          {
 462   1      // system_init();
 463   1      #define HRCSC_STEP_VAL (*(u8 code *)0x9111) // »ñÈ¡HRCÊ±ÖÓÏ¸µ÷Öµ
 464   1          u8 hrcsc_data = HRCSC_STEP_VAL & 0x7f;  // »ñÈ¡HRCÊ±ÖÓÏ¸µ÷Öµ
 465   1          WDT_KEY = 0xDD;                         // Close WDT
 466   1          FLASH_TIM0 = 0x55;
 467   1          FLASH_TIM1 = 0x54; // FLASH 16M ·ÃÎÊËÙ¶È
 468   1          FLASH_TRIM = 0x0A;
 469   1          AIP_CON0 = 0x80 | hrcsc_data; // Ê¹ÄÜ hirc
 470   1          CLK_CON0 = 0x03;              // Ñ¡Ôñ hirc clk
 471   1          CLK_CON2 = 0x00;              // ÏµÍ³Ê±ÖÓ²»·ÖÆµ
 472   1          CLK_CON6 = 0x1F;              // FLASHÉÕÐ´Ê±ÖÓ32·ÖÆµ£º1M
 473   1          delay_ms(1);                  // ¸ÃÑÓ³Ù²»¿ÉÉ¾³ý£¬±£Ö¤ÉÕÂ¼ÎÈ¶¨ÐÔ
 474   1          __ADC_VREFP_TRIM_5V_CALIB;    // ÌîÈë5VµçÑ¹¹©µçÏÂÄÚ²¿2.4V²Î¿¼µçÑ¹µÄÐ£×¼Öµ
 475   1      
 476   1          // ¹Ø±ÕHCKºÍHDAµÄµ÷ÊÔ¹¦ÄÜ
 477   1          WDT_KEY = 0x55;  // ½â³ýÐ´±£»¤
C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 9   

 478   1          IO_MAP &= ~0x03; // ¹Ø±ÕHCKºÍHDAÒý½ÅµÄµ÷ÊÔ¹¦ÄÜ£¨½â³ýÓ³Éä£©
 479   1          WDT_KEY = 0xBB;
 480   1      
 481   1          // ³õÊ¼»¯´òÓ¡
 482   1      #if USE_MY_DEBUG
                  debug_init();
                  printf("TXM8C101x_SDK main start\n");
              #endif //  #if USE_MY_DEBUG
 486   1      
 487   1          user_config();
 488   1      
 489   1      #if 1
 490   1          // ÓÉÓÚÐ¾Æ¬ÏÂÔØÖ®ºó»áÃ»ÓÐ·´Ó¦£¬ÕâÀïÓÃÂÌÉ«µÆ×÷ÎªÖ¸Ê¾£º
 491   1          LED_GREEN_ON();
 492   1          // LED_RED_ON();
 493   1          delay_ms(1000);
 494   1          LED_GREEN_OFF();
 495   1          // LED_RED_OFF();
 496   1      #endif
 497   1      
 498   1      #if 0 // ÉÏµçÊ±¼ì²âµç³ØÊÇ·ñÕýÈ·°²×°(²âÊÔÍ¨¹ý)(Õ¼ÓÃ58¸ö×Ö½Ú):
              
                  /*
                      Èç¹û´ò¿ªPWMºó£¬¼ì²âµç³ØµÄµçÑ¹±ÈÂúµç»¹Òª¸ß£¬ËµÃ÷Ã»ÓÐ½ÓÈëµç³Ø£¬
                      ¼ì²âµ½µÄÊÇ³äµç5VÉýÑ¹ºóµÄµçÑ¹
                  */
                  TMR2_PWML = 93 % 256; // µ÷½ÚÎªÔ¼47.6%µÄÕ¼¿Õ±È
                  // ×î´óÕ¼¿Õ±ÈµÄÖµ²»³¬¹ý255£¬ÎªÁË½ÚÊ¡³ÌÐò¿Õ¼ä£¬¿ÉÒÔ²»ÓÃÅäÖÃ¸ß8Î»µÄ¼Ä´æÆ÷
                  // µ«ÊÇÕâÀï²»ÄÜÈ¥µôÏÂÃæÕâÒ»Ìõ£¬»áµ¼ÖÂµçÁ÷Òì³£Ìø¶¯£¬Éè±¸»á·´¸´ÖØÆô£º
                  // TMR2_PWMH = 93 / 256;
                  TMR2_PWMH = 0;
                  tmr2_pwm_enable();                // ´ò¿ª¿ØÖÆÉýÑ¹µçÂ·µÄpwm
                  adc_sel_channel(ADC_CHANNEL_BAT); // ÇÐ»»µ½¼ì²âµç³Ø½µÑ¹ºóµÄµçÑ¹µÄ¼ì²âÒý½Å
                  {
                      u8 i = 0;
                      u16 adc_val = 0;
                      for (i = 0; i < 10; i++) //  
                      {
                          adc_val = adc_get_val();
                          if (adc_val >= ADCDETECT_BAT_FULL + ADCDETECT_BAT_NULL_EX)
                          {
                              flag_bat_is_empty = 1; // ±íÊ¾µç³ØÊÇ¿ÕµÄ(µç³ØÃ»ÓÐ°²×°)
                          }
                      }
                  }
                  tmr2_pwm_disable(); // ¹Ø±Õ¿ØÖÆÉýÑ¹µçÂ·µÄPWM
                  TMR2_PWML = 0;      // 0%Õ¼¿Õ±È
                  // TMR2_PWMH = 0;  // ×î´óÕ¼¿Õ±ÈµÄÖµ²»³¬¹ý255£¬ÎªÁË½ÚÊ¡³ÌÐò¿Õ¼ä£¬¿ÉÒÔ²»ÓÃÅäÖÃ¸ß8Î»µÄ¼Ä´æÆ÷
              
              #endif // ÉÏµçÊ±¼ì²âµç³ØÊÇ·ñÕýÈ·°²×°
 528   1      
 529   1          flag_is_enter_low_power = 1; // ÉÏµçÖ®ºó¾Í½øÈëµÍ¹¦ºÄ
 530   1      
 531   1          while (1)
 532   1          {
 533   2      
 534   2      #if 0  // (²âÊÔÍ¨¹ý)ÉÏµçÊ±£¬Èç¹û¼ì²âµ½µç³ØÃ»ÓÐ°²×°£¬ÈÃLEDÉÁË¸£¬Ö±µ½ÖØÐÂÉÏµç(Õ¼ÓÃ25¸ö×Ö½Ú)
                      if (flag_bat_is_empty)
                      {
                          // Ã»ÓÐ·ÅÈëµç³Ø£¬¿ØÖÆLEDÉÁË¸£¬Ö±µ½ÖØÐÂÉÏµç
                          LED_RED_ON();
                          delay_ms(200);
C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 10  

                          LED_RED_OFF();
                          delay_ms(200);
                          continue;
                      }
              #endif // ÉÏµçÊ±£¬Èç¹û¼ì²âµ½µç³ØÃ»ÓÐ°²×°£¬ÈÃLEDÉÁË¸£¬Ö±µ½ÖØÐÂÉÏµç
 545   2      
 546   2      #if 1
 547   2              charge_scan_handle();
 548   2      
 549   2              if (flag_is_enable_key_scan) // Ã¿10ms£¬¸Ã±êÖ¾Î»»á±»¶¨Ê±Æ÷ÖÃÎ»Ò»´Î
 550   2              {
 551   3                  flag_is_enable_key_scan = 0;
 552   3                  key_scan_10ms_isr();
 553   3              }
 554   2      
 555   2              key_event_handle();
 556   2      
 557   2              speech_scan_process(); // ¼ì²âÊÇ·ñÓÐ´ÓÓïÒôIC´«À´µÄÃüÁî£¬Èç¹ûÓÐÔò×öÏàÓ¦µÄ´¦Àí
 558   2      #endif
 559   2      
 560   2      #if 1 // µç»ú×Ô¶¯×ªÏò
 561   2              if (flag_ctl_turn_dir)
 562   2              {
 563   3                  // Èç¹ûÒªÇÐ»»µç»ú×ªÏò
 564   3                  flag_ctl_turn_dir = 0;
 565   3                  // if (0 == cur_motor_dir)
 566   3                  // {
 567   3                  //     // Èç¹ûµ±Ç°µç»úÎª³õÊ¼×´Ì¬£¬²»µ÷½Ú
 568   3                  // }
 569   3                  // else if (1 == cur_motor_dir)
 570   3                  if (1 == cur_motor_dir)
 571   3                  {
 572   4                      // Èç¹ûµ±Ç°µç»úÎªÕý×ª£¬µ÷½ÚÎª·´×ª
 573   4                      motor_pwm_b_disable(); // ¹Ø±ÕÕý×ªµÄPWMÊä³ö
 574   4                      delay_ms(500);
 575   4                      motor_pwm_a_enable(); // ´ò¿ª·´×ªµÄPWMÊä³ö
 576   4                      // cur_motor_dir = 2;    // ±íÊ¾µç»úµ±Ç°×ªÏòÎª ·´×ª
 577   4                  }
 578   3                  else if (2 == cur_motor_dir)
 579   3                  {
 580   4                      // Èç¹ûµ±Ç°µç»úÎª·´×ª£¬µ÷½ÚÎªÕý×ª
 581   4                      motor_pwm_a_disable(); // ¹Ø±Õ·´×ªµÄPWMÊä³ö
 582   4                      delay_ms(500);
 583   4                      motor_pwm_b_enable();
 584   4                      // cur_motor_dir = 1; // ±íÊ¾µç»úµ±Ç°×ªÏòÎª Õý×ª
 585   4                  }
 586   3                  // else
 587   3                  // {
 588   3                  //     // ÆäËûÇé¿ö£¬²»¿¼ÂÇ£¬²»×ö´¦Àí
 589   3                  // }
 590   3              }
 591   2      #endif // µç»ú×Ô¶¯×ªÏò
 592   2      
 593   2      #if 1 // µç»ú¹ýÁ÷¼ì²âºÍ´¦Àí
 594   2      
 595   2              motor_over_current_detect_handle(); // º¯ÊýÄÚ²¿»á¼ì²âµç»úÓÐÃ»ÓÐÔËÐÐ
 596   2      
 597   2      #endif // µç»ú¹ýÁ÷¼ì²âºÍ´¦Àí
 598   2      
 599   2      #if 1 // ¸ù¾Ý¿ØÖÆ±êÖ¾Î»À´¿ØÖÆ¹Ø»ú
 600   2              if (flag_ctl_dev_close)
 601   2              {
C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 11  

 602   3                  // Èç¹ûÒª¹Ø±ÕÉè±¸
 603   3                  flag_ctl_dev_close = 0;
 604   3      
 605   3                  if (flag_is_in_charging)
 606   3                  {
 607   4                      // Èç¹ûÕýÔÚ³äµç£¬Ö±½Ó¹Ø±ÕÓïÒôICµÄµçÔ´
 608   4                      SPEECH_POWER_DISABLE();
 609   4                  }
 610   3      
 611   3                  // º¯ÊýÄÚ²¿»áÅÐ¶ÏÊÇ²»ÊÇÕýÔÚ³äµç¶ø¹Ø»ú
 612   3                  fun_ctl_power_off();
 613   3              }
 614   2      #endif // ¸ù¾Ý¿ØÖÆ±êÖ¾Î»À´¿ØÖÆ¹Ø»ú
 615   2      
 616   2      #if 1 // µÍ¹¦ºÄ
 617   2      
 618   2              if (flag_is_enter_low_power)
 619   2              {
 620   3                  flag_is_enter_low_power = 0;
 621   3                  low_power();
 622   3              }
 623   2      
 624   2      #endif // µÍ¹¦ºÄ
 625   2      
 626   2          } // while (1)
 627   1      }
 628          
 629          void TMR0_IRQHandler(void) interrupt TMR0_IRQn
 630          {
 631   1          if (TMR0_CONH & 0x80)
 632   1          {
 633   2              TMR0_CONH |= 0x80;
 634   2              // 1ms²úÉúÒ»´ÎÖÐ¶Ï£¬½øÈëµ½ÕâÀï
 635   2      
 636   2              if (flag_bat_is_empty)
 637   2              {
 638   3                  return; // Èç¹ûµç³ØÎª¿Õ£¬ÌáÇ°ÍË³öÖÐ¶Ï·þÎñº¯Êý
 639   3              }
 640   2      
 641   2              { // °´¼üÉ¨Ãè
 642   3                  static volatile u8 key_scan_cnt = 0;
 643   3                  key_scan_cnt++;
 644   3                  if (key_scan_cnt >= 10)
 645   3                  {
 646   4                      key_scan_cnt = 0;
 647   4                      flag_is_enable_key_scan = 1;
 648   4                  }
 649   3              } // °´¼üÉ¨Ãè
 650   2      
 651   2      #if 1 // ¼ì²âÊÇ·ñ°Î³ö/²åÈë³äµçÆ÷
 652   2      
 653   2              { // ¼ì²âÊÇ·ñ°Î³ö/²åÈë³äµçÆ÷
 654   3                  static u8 not_charge_ms_cnt = 0;
 655   3                  static u8 charging_ms_cnt = 0;
 656   3                  if (flag_is_in_charging)
 657   3                  {
 658   4                      if (flag_tim_scan_maybe_not_charge)
 659   4                      {
 660   5                          // ÕýÔÚ³äµç£¬²¢ÇÒ¼ì²âµ½¿ÉÄÜÓÐ³äµçÆ÷¶Ï¿ª£¬½øÐÐ¼ÆÊ±
 661   5                          not_charge_ms_cnt++;
 662   5                          if (not_charge_ms_cnt >= 250)
 663   5                          {
C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 12  

 664   6                              not_charge_ms_cnt = 0;
 665   6                              flag_tim_set_is_in_charging = 0;
 666   6                          }
 667   5                      }
 668   4                      else
 669   4                      {
 670   5                          // ÕýÔÚ³äµç£¬²¢ÇÒÃ»ÓÐ¼ì²âµ½³äµçÆ÷¶Ï¿ª£º
 671   5                          not_charge_ms_cnt = 0;
 672   5                          flag_tim_set_is_in_charging = 1;
 673   5                      }
 674   4                  }
 675   3                  else
 676   3                  {
 677   4                      if (flag_tim_scan_maybe_in_charging)
 678   4                      {
 679   5                          // Ã»ÓÐÔÚ³äµç£¬µ«ÊÇ¼ì²âµ½ÓÐ³äµçÆ÷²åÈë£¬½øÐÐ¼ÆÊ±£¬È·ÈÏ³äµçÆ÷ÊÇ·ñÕæµÄ²åÈë£º
 680   5                          charging_ms_cnt++;
 681   5                          if (charging_ms_cnt >= 250)
 682   5                          {
 683   6                              charging_ms_cnt = 0;
 684   6                              flag_tim_set_is_in_charging = 1;
 685   6                          }
 686   5                      }
 687   4                      else
 688   4                      {
 689   5                          // Ã»ÓÐÔÚ³äµç£¬²¢ÇÒÒ²Ã»ÓÐ¼ì²âµ½³äµçÆ÷²åÈë
 690   5                          charging_ms_cnt = 0;
 691   5                          flag_tim_set_is_in_charging = 0;
 692   5                      }
 693   4                  }
 694   3              } // ¼ì²âÊÇ·ñ°Î³ö/²åÈë³äµçÆ÷
 695   2      #endif // ¼ì²âÊÇ·ñ°Î³ö/²åÈë³äµçÆ÷
 696   2      
 697   2      #if 1 // ¿ØÖÆµÆ¹âÉÁË¸µÄÐ§¹û
 698   2      
 699   2              { // ¿ØÖÆµÆ¹âÉÁË¸µÄÐ§¹û
 700   3      
 701   3                  static volatile u16 blink_ms_cnt = 0; // ¼ÆÊýÖµ£¬¿ØÖÆµÆ¹âÉÁË¸µÄÊ±¼ä¼ä¸ô
 702   3      
 703   3                  // ×´Ì¬»ú£¬
 704   3                  // 0--³õÊ¼Öµ¡¢ÎÞ×´Ì¬£¬
 705   3                  // 1--×¼±¸½øÈëÉÁË¸£¬
 706   3                  // 2--ÕýÔÚÉÁË¸
 707   3                  static volatile u8 cur_blink_status = 0;
 708   3                  static volatile u8 __blink_cnt = 0; // Ò»¿ªÊ¼´æ·ÅÒªÉÁË¸µÄ´ÎÊý£¬ºóÃæ¿ØÖÆµ±Ç°Ê£ÓàÉÁË¸´ÎÊý
 709   3      
 710   3                  if (flag_ctl_led_blink)
 711   3                  {
 712   4                      // Èç¹ûÊ¹ÄÜÁËµÆ¹âÉÁË¸
 713   4                      if (0 == cur_blink_status)
 714   4                      {
 715   5                          // Èç¹ûµ±Ç°µÆ¹â×´Ì¬´¦ÓÚ³õÊ¼Öµ£¬Ã»ÓÐÔÚÉÁË¸
 716   5                          cur_blink_status = 1;
 717   5                      }
 718   4                  }
 719   3                  else
 720   3                  {
 721   4                      // Èç¹û²»Ê¹ÄÜµÆ¹âÉÁË¸£¬Á¢¼´Í£Ö¹µ±Ç°µÆ¹âÉÁË¸µÄÐ§¹û
 722   4                      cur_blink_status = 0;
 723   4                      blink_ms_cnt = 0;
 724   4                      __blink_cnt = 0;
 725   4                  }
C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 13  

 726   3      
 727   3                  if (1 == cur_blink_status)
 728   3                  {
 729   4                      // ×¼±¸½øÈëÉÁË¸£¬ÅÐ¶ÏÒªÉÁË¸µÄÊÇºìµÆ»¹ÊÇÂÌµÆ£¬ÊÇÒª±íÊ¾µ±Ç°µç»úµÄµ²Î»»¹ÊÇ¼ÓÈÈµÄµ²Î»
 730   4      
 731   4                      // ¿ÉÒÔÔÚÉÁË¸Ç°ÏÈ¹Ø±ÕµÆ¹â£¬ÔÙµãÁÁÒªÉÁË¸µÄLED£¬
 732   4                      // ×îºóÔÙÊ¹ÄÜÉÁË¸µÄÐ§¹û£¬ÕâÑù¾Í²»ÓÃ¼ÓÈëÏÂÃæµÄÅÐ¶Ï£º
 733   4                      // if (CUR_SEL_LED_RED == cur_sel_led)
 734   4                      // {
 735   4                      //     // Èç¹ûÒªÈÃºìµÆÉÁË¸
 736   4                      //     // LED_GREEN_OFF();
 737   4                      //     // LED_RED_ON();
 738   4                      // }
 739   4                      // else if (CUR_SEL_LED_GREEN == cur_sel_led)
 740   4                      // {
 741   4                      //     // Èç¹ûÒªÈÃÂÌµÆÉÁË¸
 742   4                      //     // LED_RED_OFF();
 743   4                      //     // LED_GREEN_ON();
 744   4                      // }
 745   4      
 746   4                      // ÈÃµÆ¹â±£³ÖµãÁÁ500ms
 747   4                      blink_ms_cnt++;
 748   4                      if (blink_ms_cnt >= 500)
 749   4                      {
 750   5                          blink_ms_cnt = 0;
 751   5                          cur_blink_status = 2; // ±íÊ¾ÕýÊ½½øÈëLEDÉÁË¸×´Ì¬
 752   5                      }
 753   4                  }
 754   3                  else if (2 == cur_blink_status)
 755   3                  {
 756   4                      // Èç¹ûÕýÔÚ½øÐÐLEDÉÁË¸
 757   4                      if (0 == __blink_cnt)
 758   4                      {
 759   5                          __blink_cnt = cur_ctl_led_blink_cnt; // ´æ·Åµ±Ç°ÒªÉÁË¸µÄ´ÎÊý
 760   5                      }
 761   4      
 762   4                      if (__blink_cnt) // Èç¹ûÉÁË¸´ÎÊý²»Îª0£¬¼ÌÐøÉÁË¸
 763   4                      {
 764   5                          blink_ms_cnt++;
 765   5                          if (blink_ms_cnt <= 500)
 766   5                          {
 767   6                              // Ï¨ÃðLED 500ms
 768   6                              if (CUR_SEL_LED_RED == cur_sel_led)
 769   6                              {
 770   7                                  // Èç¹ûÒªÈÃºìµÆÉÁË¸
 771   7                                  LED_RED_OFF();
 772   7                              }
 773   6                              else if (CUR_SEL_LED_GREEN == cur_sel_led)
 774   6                              {
 775   7                                  // Èç¹ûÒªÈÃÂÌµÆÉÁË¸
 776   7                                  LED_GREEN_OFF();
 777   7                              }
 778   6                          }
 779   5                          else if (blink_ms_cnt < 1000)
 780   5                          {
 781   6                              // µãÁÁLED 500ms
 782   6                              if (CUR_SEL_LED_RED == cur_sel_led)
 783   6                              {
 784   7                                  // Èç¹ûÒªÈÃºìµÆÉÁË¸
 785   7                                  LED_RED_ON();
 786   7                              }
 787   6                              else if (CUR_SEL_LED_GREEN == cur_sel_led)
C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 14  

 788   6                              {
 789   7                                  // Èç¹ûÒªÈÃÂÌµÆÉÁË¸
 790   7                                  LED_GREEN_ON();
 791   7                              }
 792   6                          }
 793   5                          else
 794   5                          {
 795   6                              blink_ms_cnt = 0;
 796   6                              __blink_cnt--; // Íê³ÉÁËÒ»´ÎÉÁË¸£¬¼ÆÊýÖµ¼õÒ»
 797   6                              if (0 == __blink_cnt)
 798   6                              {
 799   7                                  // Èç¹ûÊ£ÓàÉÁË¸´ÎÊýÎª0£¬½áÊøÉÁË¸
 800   7                                  flag_ctl_led_blink = 0; // ²»Ê¹ÄÜÉÁË¸
 801   7                                  cur_blink_status = 0;   // »Ö¸´µ½³õÊ¼Öµ£¬±íÊ¾Ã»ÓÐÔÚÉÁË¸
 802   7                              }
 803   6                          }
 804   5                      }
 805   4                  }
 806   3              } // ¿ØÖÆµÆ¹âÉÁË¸µÄÐ§¹û
 807   2      #endif // ¿ØÖÆµÆ¹âÉÁË¸µÄÐ§¹û
 808   2      
 809   2      #if 1 // ¿ØÖÆ¼ÓÈÈ
 810   2      
 811   2              { // ¿ØÖÆ¼ÓÈÈ
 812   3                  static volatile u8 __ctl_heat_ms_cnt = 0;
 813   3      
 814   3                  if (1 == cur_ctl_heat_status)
 815   3                  {
 816   4                      // Ò»µµ¼ÓÈÈ
 817   4                      HEATING_ON();
 818   4                  }
 819   3                  else if (2 == cur_ctl_heat_status)
 820   3                  {
 821   4                      // ¶þµµ¼ÓÈÈ
 822   4                      __ctl_heat_ms_cnt++;
 823   4                      if (__ctl_heat_ms_cnt <= 5)
 824   4                      {
 825   5                          HEATING_ON();
 826   5                      }
 827   4                      else if (__ctl_heat_ms_cnt < 10)
 828   4                      {
 829   5                          HEATING_OFF();
 830   5                      }
 831   4                      else
 832   4                      {
 833   5                          __ctl_heat_ms_cnt = 0;
 834   5                      }
 835   4                  }
 836   3                  else
 837   3                  {
 838   4                      // ÎÞ×´Ì¬£¬¹Ø±Õ¼ÓÈÈ
 839   4                      HEATING_OFF();
 840   4                      __ctl_heat_ms_cnt = 0;
 841   4                  }
 842   3      
 843   3              } // ¿ØÖÆ¼ÓÈÈ
 844   2      #endif // ¿ØÖÆ¼ÓÈÈ
 845   2      
 846   2      #if 1 // ¿ØÖÆ×Ô¶¯¹Ø»ú
 847   2      
 848   2              { // ×Ô¶¯¹Ø»ú
 849   3                  static volatile u32 shut_down_ms_cnt = 0;
C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 15  

 850   3      
 851   3                  // if ((0 != cur_motor_status ||     /* Èç¹ûµç»ú²»ÊÇ¹Ø±ÕµÄ */
 852   3                  //      0 != cur_ctl_heat_status) && /* Èç¹û¼ÓÈÈ²»ÊÇ¹Ø±ÕµÄ */
 853   3                  //     0 == flag_is_in_charging      /* µ±Ç°Ã»ÓÐÔÚ³äµç */
 854   3                  if ((SPEECH_CTL_PIN_OPEN == SPEECH_CTL_PIN) && /* Èç¹ûÓïÒôICµÄµçÔ´¿ªÆô£¬ËµÃ÷Éè±¸ÕýÔÚ¹¤×÷ */
 855   3                      0 == flag_is_in_charging                   /* µ±Ç°Ã»ÓÐÔÚ³äµç */
 856   3                  )
 857   3                  {
 858   4                      shut_down_ms_cnt++;
 859   4                      if (shut_down_ms_cnt >= 600000) // xx ms ºó£¬¹Ø»ú
 860   4                      {
 861   5                          shut_down_ms_cnt = 0;
 862   5                          flag_ctl_dev_close = 1;
 863   5                          flag_is_enter_low_power = 1; // ÔÊÐí½øÈëµÍ¹¦ºÄ
 864   5                      }
 865   4                  }
 866   3                  else
 867   3                  {
 868   4                      shut_down_ms_cnt = 0;
 869   4                  }
 870   3              } // ×Ô¶¯¹Ø»ú
 871   2      #endif // ¿ØÖÆ×Ô¶¯¹Ø»ú
 872   2      
 873   2      #if 1 // ¿ØÖÆµç»ú×Ô¶¯»»·½Ïò
 874   2      
 875   2              { // ×Ô¶¯»»·½Ïò
 876   3      
 877   3                  static volatile u16 turn_dir_ms_cnt = 0; // ¿ØÖÆÔÚÔËÐÐÊ±Ã¿ xx minÇÐ»»Ò»´Î×ªÏòµÄ¼ÆÊ±±äÁ¿
 878   3      
 879   3                  if ((0 != cur_motor_status) &&       /* Èç¹ûµç»ú²»ÊÇ¹Ø±ÕµÄ */
 880   3                      0 == flag_is_turn_dir_by_speech) /* Èç¹ûÃ»ÓÐÍ¨¹ýÓïÒôµ÷½Ú¹ý·½Ïò */
 881   3      
 882   3                  {
 883   4                      turn_dir_ms_cnt++;
 884   4                      if (turn_dir_ms_cnt >= 60000) // xx ms ºó£¬»»·½Ïò
 885   4                      // if (turn_dir_ms_cnt >= 60) // xx ms ºó£¬»»·½Ïò£¨²âÊÔÓÃ£©
 886   4                      {
 887   5                          turn_dir_ms_cnt = 0;
 888   5                          // ±êÖ¾Î»ÖÃÒ»£¬ÈÃ»»·½ÏòµÄ²Ù×÷ÔÚÖ÷º¯ÊýÖ´ÐÐ£¬ÒòÎª»»·½ÏòÒª¼ä¸ô500ms
 889   5                          flag_ctl_turn_dir = 1;
 890   5                      }
 891   4                  }
 892   3                  else
 893   3                  {
 894   4                      turn_dir_ms_cnt = 0;
 895   4      
 896   4                      if (flag_is_turn_dir_by_speech)
 897   4                      {
 898   5                          flag_is_turn_dir_by_speech = 0; // ÒÑ¾­Çå³ý×Ô¶¯»»·½ÏòµÄ¼ÆÊ±£¬±ãÇå³ý¸Ã±êÖ¾Î»
 899   5                      }
 900   4                  }
 901   3      
 902   3              } // ×Ô¶¯»»·½Ïò
 903   2      #endif // ¿ØÖÆµç»ú×Ô¶¯»»·½Ïò
 904   2      
 905   2      #if 1 // ¼ì²âÊÇ·ñ¿ì³äÂúµç
 906   2      
 907   2              {
 908   3                  static volatile u16 bat_is_near_full_ms_cnt = 0;
 909   3                  // Èç¹û²»ÔÚ³äµç¾ÍÇå¿ÕÁË±êÖ¾Î» flag_tim_scan_bat_maybe_near_full £¬
 910   3                  //  |-- ¿ÉÒÔ²»¼ÓÏÂÃæÕâ¸öÅÐ¶ÏÌõ¼þ£º
 911   3                  // if (flag_is_in_charging)
C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 16  

 912   3                  {
 913   4                      if (flag_tim_scan_bat_maybe_near_full)
 914   4                      {
 915   5                          // ÕýÔÚ³äµç£¬ÇÒ¼ì²âµ½¿ì³äÂúµç£¬½øÐÐ¼ÆÊ±
 916   5                          bat_is_near_full_ms_cnt++;
 917   5                          if (bat_is_near_full_ms_cnt >= 5000) // xx ms
 918   5                          {
 919   6                              bat_is_near_full_ms_cnt = 0;
 920   6                              flag_tim_set_bat_is_near_full = 1;
 921   6                          }
 922   5                      }
 923   4                      else
 924   4                      {
 925   5                          // ÕýÔÚ³äµç£¬µ«ÊÇÓÐÒ»´ÎÃ»ÓÐ¼ì²âµ½¿ì³äÂúµç£¬Çå³ý¼ÆÊ±ºÍ±êÖ¾Î»
 926   5                          bat_is_near_full_ms_cnt = 0;
 927   5                          flag_tim_set_bat_is_near_full = 0;
 928   5                      }
 929   4                  }
 930   3              }
 931   2      
 932   2      #endif // ¼ì²âÊÇ·ñ¿ì³äÂúµç
 933   2      
 934   2      #if 1 // ¼ì²âÊÇ·ñ³äÂúµç
 935   2      
 936   2              { // ¼ì²âÊÇ·ñ³äÂúµç
 937   3                  static volatile u16 bat_is_full_ms_cnt = 0;
 938   3                  // Èç¹û²»ÔÚ³äµç¾ÍÇå¿ÕÁË±êÖ¾Î» flag_tim_scan_bat_maybe_full £¬
 939   3                  //  |-- ¿ÉÒÔ²»¼ÓÕâ¸öÅÐ¶ÏÌõ¼þ£º
 940   3                  // if (flag_is_in_charging)
 941   3                  {
 942   4                      if (flag_tim_scan_bat_maybe_full)
 943   4                      {
 944   5                          // ÕýÔÚ³äµç£¬²¢ÇÒÓÐ¼ì²âµ½µç³ØÂúµç£¬½øÐÐÀÛ¼Æ£º
 945   5                          bat_is_full_ms_cnt++;
 946   5                          if (bat_is_full_ms_cnt >= 5000) // xx ms
 947   5                          {
 948   6                              bat_is_full_ms_cnt = 0;
 949   6                              flag_tim_set_bat_is_full = 1;
 950   6                          }
 951   5                      }
 952   4                      else
 953   4                      {
 954   5                          // ÕýÔÚ³äµç£¬µ«ÊÇÃ»ÓÐ¼ì²âµ½µç³ØÂúµç£º
 955   5                          bat_is_full_ms_cnt = 0;
 956   5                          flag_tim_set_bat_is_full = 0;
 957   5                      }
 958   4                  }
 959   3              } // ¼ì²âÊÇ·ñ³äÂúµç
 960   2      #endif // ¼ì²âÊÇ·ñ³äÂúµç
 961   2      
 962   2      #if 1 // ¼ì²âÊÇ·ñÒªµÍµçÁ¿±¨¾¯
 963   2      
 964   2              {
 965   3                  static volatile u16 low_bat_ms_cnt = 0;
 966   3                  if (flag_tim_scan_maybe_low_bat)
 967   3                  {
 968   4                      // Èç¹û¿ÉÄÜ¼ì²âµ½ÁËµÍµçÁ¿£¬½øÐÐÁ¬Ðø¼ÆÊ±
 969   4                      low_bat_ms_cnt++;
 970   4                      if (low_bat_ms_cnt >= LOW_BAT_SCAN_TIMES_MS)
 971   4                      {
 972   5                          low_bat_ms_cnt = 0;
 973   5                          flag_tim_set_bat_is_low = 1;
C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 17  

 974   5                      }
 975   4                  }
 976   3                  else
 977   3                  {
 978   4                      // Èç¹ûÃ»ÓÐ¼ì²âµ½µÍµçÁ¿
 979   4                      low_bat_ms_cnt = 0;
 980   4                      flag_tim_set_bat_is_low = 0;
 981   4                  }
 982   3              }
 983   2      
 984   2              { // ¸ù¾Ý±êÖ¾Î»À´Ö´ÐÐµÍµçÁ¿±¨¾¯µÄ¹¦ÄÜ£¬Ö´ÐÐÇ°(¸ø¿ØÖÆ±êÖ¾Î»ÖÃÒ»Ç°)ÒªÏÈ¹Ø±ÕËùÓÐLED
 985   3      
 986   3                  static volatile bit __flag_is_in_low_bat_alarm = 0;   // ±êÖ¾Î»£¬ÊÇ·ñÕýÔÚÖ´ÐÐµÍµçÁ¿±¨¾¯µÄ¹¦ÄÜ
 987   3                  static volatile u16 __blink_cnt_in_low_bat_alarm = 0; // µÍµçÁ¿±¨¾¯Ê±£¬LEDÉÁË¸Ê±¼ä¼ÆÊý
 988   3      
 989   3                  /* Èç¹ûÊ¹ÄÜÁËµÍµçÁ¿±¨¾¯£¬²¢ÇÒÉè±¸ÕýÔÚÔËÐÐ */
 990   3                  if (flag_ctl_low_bat_alarm &&
 991   3                      (0 != cur_motor_status || 0 != cur_ctl_heat_status))
 992   3                  {
 993   4                      if (0 == __flag_is_in_low_bat_alarm)
 994   4                      {
 995   5                          __flag_is_in_low_bat_alarm = 1; // ÔÚ¸ÃÓï¾ä¿éÄÚ²¿£¬Ê¹ÄÜµÍµçÁ¿±¨¾¯µÄ¹¦ÄÜ
 996   5                      }
 997   4                  }
 998   3                  else
 999   3                  {
1000   4                      __blink_cnt_in_low_bat_alarm = 0;
1001   4                      __flag_is_in_low_bat_alarm = 0;
1002   4                  }
1003   3      
1004   3                  if (__flag_is_in_low_bat_alarm)
1005   3                  {
1006   4                      __blink_cnt_in_low_bat_alarm++;
1007   4                      if (__blink_cnt_in_low_bat_alarm <= 300)
1008   4                      {
1009   5                          LED_RED_ON();
1010   5                      }
1011   4                      else if (__blink_cnt_in_low_bat_alarm < 600)
1012   4                      {
1013   5                          LED_RED_OFF();
1014   5                      }
1015   4                      else
1016   4                      {
1017   5                          __blink_cnt_in_low_bat_alarm = 0;
1018   5                      }
1019   4                  }
1020   3              } // ¸ù¾Ý±êÖ¾Î»À´Ö´ÐÐµÍµçÁ¿±¨¾¯µÄ¹¦ÄÜ£¬Ö´ÐÐÇ°(¸ø¿ØÖÆ±êÖ¾Î»ÖÃÒ»Ç°)ÒªÏÈ¹Ø±ÕËùÓÐLED
1021   2      #endif // ¼ì²âÊÇ·ñÒªµÍµçÁ¿±¨¾¯
1022   2      
1023   2      #if 1 // ¹¤×÷Ê±£¬¼ì²âµç³ØµçÁ¿ÊÇ·ñÒ»Ö±µÍÓÚ¹Ø»úµçÑ¹
1024   2      
1025   2              {
1026   3                  static u16 __shut_down_cnt = 0; // ¶Ôµç³ØµçÑ¹µÍÓÚ¹Ø»úµçÑ¹µÄÁ¬Ðø¼ÆÊ±
1027   3      
1028   3                  // Èç¹û¼ì²âµ½µç³ØµÍµçÑ¹£¬²¢ÇÒµç»úÃ»ÓÐ¶Â×ª(µç»ú¶Â×ªÊ±»á°Ñµç³ØµçÑ¹À­µÍ£¬»áÓ°ÏìÅÐ¶Ï)
1029   3                  if (flag_tim_scan_maybe_shut_down && 0 == flag_tim_scan_maybe_motor_stalling)
1030   3                  {
1031   4                      // Èç¹û¼ì²âµ½ÔÚ¹¤×÷Ê±£¬µç³ØµçÑ¹µÍÓÚ¹Ø»úµçÑ¹£¬½øÐÐÁ¬Ðø¼ÆÊ±
1032   4                      __shut_down_cnt++;
1033   4                      if (__shut_down_cnt >= SHUT_DOWN_SCAN_TIMES_MS)
1034   4                      {
1035   5                          __shut_down_cnt = 0;
C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 18  

1036   5                          flag_tim_set_shut_down = 1;
1037   5                      }
1038   4                  }
1039   3                  else
1040   3                  {
1041   4                      // Èç¹ûÔÚ¹¤×÷Ê±£¬Ã»ÓÐ¼ì²âµ½ µç³ØµçÑ¹µÍÓÚ¹Ø»úµçÑ¹
1042   4                      __shut_down_cnt = 0;
1043   4                      flag_tim_set_shut_down = 0;
1044   4                  }
1045   3              }
1046   2      #endif // ¹¤×÷Ê±£¬¼ì²âµç³ØµçÁ¿ÊÇ·ñÒ»Ö±µÍÓÚ¹Ø»úµçÑ¹
1047   2      
1048   2      #if 1 // µç»ú¹ýÁ÷¼ì²â£¬³¬¹ý10s±ãÈÏÎªµç»ú¶Â×ª
1049   2      
1050   2              {
1051   3                  // ¼ì²âµ½µç»ú¶Â×ªºó£¬½øÐÐÁ¬Ðø¼ÆÊ±
1052   3                  static volatile u16 __detect_motor_stalling_cnt = 0;
1053   3      
1054   3                  // if (flag_tim_scan_maybe_motor_stalling && 0 != cur_motor_status)
1055   3                  if (flag_tim_scan_maybe_motor_stalling && cur_motor_status)
1056   3                  {
1057   4                      // Èç¹û¼ì²âµ½ÓÐµç»ú¶Â×ªµÄÇé¿ö
1058   4                      __detect_motor_stalling_cnt++;
1059   4                      if (__detect_motor_stalling_cnt >= MOTOR_STALLING_SCAN_TIMES_MS)
1060   4                      {
1061   5                          __detect_motor_stalling_cnt = 0;
1062   5                          flag_tim_set_motor_stalling = 1;
1063   5                      }
1064   4                  }
1065   3                  else
1066   3                  {
1067   4                      // Èç¹ûÃ»ÓÐ¼ì²âµ½ÓÐµç»ú¶Â×ªµÄÇé¿ö
1068   4                      // P00 = 0; // ·½±ã²âÊÔ¹ýÁ÷¼ì²âÊ±¼ä
1069   4                      __detect_motor_stalling_cnt = 0;
1070   4                      flag_tim_set_motor_stalling = 0;
1071   4                  }
1072   3              }
1073   2      #endif // µç»ú¹ýÁ÷¼ì²â£¬³¬¹ý10s±ãÈÏÎªµç»ú¶Â×ª
1074   2      
1075   2      #if 1 // ¿ØÖÆÓïÒôIC¹Ø»úºó£¬ÎÞ²Ù×÷¶ø¹Ø»ú
1076   2      
1077   2              {
1078   3                  static u32 no_operation_shut_down_cnt = 0; // ÎÞ²Ù×÷×Ô¶¯¹Ø»úµÄ¼ÆÊ±
1079   3      
1080   3                  // if (0 == flag_is_new_operation && /* Èç¹ûÃ»ÓÐÐÂµÄ²Ù×÷ */
1081   3                  //     0 == cur_motor_status &&      /* Èç¹ûµç»ú¹Ø±Õ */
1082   3                  //     // 0 == cur_ctl_heat_status &&   /* Èç¹û¼ÓÈÈ¹Ø±Õ */
1083   3                  //     0 == flag_is_enter_low_power  /* Èç¹ûÃ»ÓÐÊ¹ÄÜ½øÈëµÍ¹¦ºÄ */
1084   3                  // )
1085   3                  if (0 == flag_is_new_operation && /* Èç¹ûÃ»ÓÐÐÂµÄ²Ù×÷ */
1086   3                      (0 == flag_is_in_charging) && /* Èç¹û²»ÊÇÔÚ³äµç */
1087   3                      0 == cur_motor_status &&      /* Èç¹ûµç»ú¹Ø±Õ */
1088   3                      0 == cur_ctl_heat_status &&   /* Èç¹û¼ÓÈÈ¹Ø±Õ */
1089   3                      0 == flag_is_enter_low_power  /* Èç¹ûÃ»ÓÐÊ¹ÄÜ½øÈëµÍ¹¦ºÄ */
1090   3                  )
1091   3                  {
1092   4                      no_operation_shut_down_cnt++;
1093   4                      if (no_operation_shut_down_cnt >= NO_OPERATION_SHUT_DOWN_TIMES_MS)
1094   4                      {
1095   5                          no_operation_shut_down_cnt = 0;
1096   5                          flag_is_enter_low_power = 1;
1097   5                      }
C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 19  

1098   4                  }
1099   3                  else
1100   3                  {
1101   4                      no_operation_shut_down_cnt = 0;
1102   4                      flag_is_new_operation = 0;
1103   4                  }
1104   3              }
1105   2      #endif // ¿ØÖÆÓïÒôIC¹Ø»úºó£¬ÎÞ²Ù×÷¶ø¹Ø»ú
1106   2      
1107   2      #if 1 // ¿ØÖÆºôÎüµÆÐ§¹û
1108   2      
1109   2              {
1110   3                  // 0 -- ³õÊ¼×´Ì¬
1111   3                  // 1 -- ¸Õ½øÈëºôÎüµÆ×´Ì¬
1112   3                  // 2 -- ´ÓÁÁµ½Ãð
1113   3                  // 3 -- ´ÓÃðµ½ÁÁ
1114   3                  static u8 cur_breathing_status = 0;
1115   3                  static u16 pwm_duty = 0;
1116   3      
1117   3                  if (flag_is_in_charging &&
1118   3                      (0 == flag_bat_is_near_full) &&
1119   3                      (0 == flag_bat_is_full))
1120   3                  {
1121   4                      if (0 == cur_breathing_status)
1122   4                      {
1123   5                          cur_breathing_status = 1;
1124   5                      }
1125   4                  }
1126   3                  else
1127   3                  {
1128   4                      cur_breathing_status = 0;
1129   4                      pwm_duty = 0;
1130   4                  }
1131   3      
1132   3                  if (1 == cur_breathing_status)
1133   3                  {
1134   4                      // ¸Õ½øÈëºôÎüµÆÉÁË¸Ð§¹û
1135   4                      pwm_duty = (STMR2_PRE + 1);
1136   4                      cur_breathing_status = 2;
1137   4                      LED_RED_ON();
1138   4                  }
1139   3                  else if (2 == cur_breathing_status)
1140   3                  {
1141   4                      if (pwm_duty > 0)
1142   4                      {
1143   5                          pwm_duty--;
1144   5                      }
1145   4                      else
1146   4                      {
1147   5                          cur_breathing_status = 3;
1148   5                          pwm_duty = 0;
1149   5                      }
1150   4      
1151   4      #ifdef USE_P13_RLED_USE_P12_GLED
1152   4                      STMR2_CMPAH = (pwm_duty) / 256; // Í¨µÀAÕ¼¿Õ±È
1153   4                      STMR2_CMPAL = (pwm_duty) % 256;
1154   4      #endif
1155   4      
1156   4      #ifdef USE_P12_RLED_USE_P13_GLED
                              STMR2_CMPBH = (pwm_duty) / 256; // Í¨µÀBÕ¼¿Õ±È  100%
                              STMR2_CMPBL = (pwm_duty) % 256;
              #endif
C51 COMPILER V9.60.7.0   MAIN                                                              02/27/2025 15:58:50 PAGE 20  

1160   4                  }
1161   3                  else if (3 == cur_breathing_status)
1162   3                  {
1163   4                      if (pwm_duty < (STMR2_PRE + 1))
1164   4                      {
1165   5                          pwm_duty++;
1166   5                      }
1167   4                      else
1168   4                      {
1169   5                          cur_breathing_status = 2;
1170   5                          pwm_duty = (STMR2_PRE + 1);
1171   5                      }
1172   4      
1173   4      #ifdef USE_P13_RLED_USE_P12_GLED
1174   4                      STMR2_CMPAH = (pwm_duty) / 256; // Í¨µÀAÕ¼¿Õ±È
1175   4                      STMR2_CMPAL = (pwm_duty) % 256;
1176   4      #endif
1177   4      
1178   4      #ifdef USE_P12_RLED_USE_P13_GLED
                              STMR2_CMPBH = (pwm_duty) / 256; // Í¨µÀBÕ¼¿Õ±È
                              STMR2_CMPBL = (pwm_duty) % 256;
              #endif
1182   4                  }
1183   3              }
1184   2      
1185   2      #endif // ¿ØÖÆºôÎüµÆÐ§¹û
1186   2      
1187   2      #if 0 // ³äµçÊ±£¬Ö»ÈÃºìµÆÉÁË¸
              
              #endif // ³äµçÊ±£¬Ö»ÈÃºìµÆÉÁË¸
1190   2      
1191   2          }
1192   1      }
1193          
1194          /**
1195           * @}
1196           */
1197          
1198          /*************************** (C) COPYRIGHT 2021 HUGE-IC ***** END OF FILE *****/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1439    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     33    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =     28    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
