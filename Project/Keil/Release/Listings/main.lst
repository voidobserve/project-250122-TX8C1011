C51 COMPILER V9.60.7.0   MAIN                                                              02/18/2025 17:34:22 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Release\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\main.c OPTIMIZE(9,SIZE) BROWSE INTVECTOR(0X8000) INCDIR(..\..
                    -\Libraries\Include;..\..\User;..\..\Hardware;..\..\App) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\main.lst
                    -) OBJECT(.\Release\Objects\main.obj)

line level    source

   1          /**
   2           ******************************************************************************
   3           * @file    main.c
   4           * @author  HUGE-IC Application Team
   5           * @version V1.0.0
   6           * @date    01-05-2021
   7           * @brief   Main program body
   8           ******************************************************************************
   9           * @attention
  10           *
  11           * <h2><center>&copy; COPYRIGHT 2021 HUGE-IC</center></h2>
  12           *
  13           * °æÈ¨ËµÃ÷ºóÐø²¹ÉÏ
  14           *
  15           ******************************************************************************
  16           */
  17          
  18          #include "include.h"
*** WARNING C322 IN LINE 6 OF ..\..\Hardware\motor.h: unknown identifier
*** WARNING C322 IN LINE 26 OF ..\..\App\speech_process.h: unknown identifier
  19          #include "my_config.h"
  20          
  21          volatile bit flag_bat_is_empty = 0;     // ±êÖ¾Î»£¬ÓÃÓÚ¼ì²âÊÇ·ñ°Î³öÁËµç³Ø
  22          volatile bit flag_bat_is_near_full = 0; // ±êÖ¾Î»£¬±íÊ¾µç³ØÊÇ·ñ¿ì³äÂúµç
  23          volatile bit flag_bat_is_full = 0;      // µç³ØÊÇ·ñ±»³äÂúµçµÄ±êÖ¾Î»
  24          
  25          volatile bit flag_is_in_charging = 0;               // ÊÇ·ñ´¦ÓÚ³äµçµÄ±êÖ¾Î»
  26          volatile bit flag_tim_scan_maybe_not_charge = 0;    // ÓÃÓÚ¸ø¶¨Ê±Æ÷É¨ÃèµÄ±êÖ¾Î»£¬¿ÉÄÜ¼ì²âµ½ÁË°Î³ö³äµçÆ÷
  27          volatile bit flag_tim_scan_maybe_in_charging = 0;   // ÓÃÓÚ¸ø¶¨Ê±Æ÷É¨ÃèµÄ±êÖ¾Î»£¬¿ÉÄÜ¼ì²âµ½ÁË³äµçÆ÷
  28          volatile bit flag_tim_set_is_in_charging = 0;       // ÓÉ¶¨Ê±Æ÷ÖÃÎ»/¸´Î»µÄ£¬±íÊ¾ÊÇ·ñÓÐ²åÈë³äµçÆ÷µÄ±êÖ¾Î»
  29          volatile bit flag_tim_scan_bat_maybe_full = 0;      // ÓÃÓÚ¸ø¶¨Ê±Æ÷É¨ÃèµÄ±êÖ¾Î»£¬¿ÉÄÜ¼ì²âµ½µç³Ø±»³äÂúµç
  30          volatile bit flag_tim_set_bat_is_full = 0;          // ÓÉ¶¨Ê±Æ÷ÖÃÎ»/¸´Î»µÄ£¬±íÊ¾µç³ØÊÇ·ñ±»³äÂúµçµÄ±êÖ¾Î»
  31          volatile bit flag_tim_scan_bat_maybe_near_full = 0; // ÓÃÓÚ¸ø¶¨Ê±Æ÷É¨ÃèµÄ±êÖ¾Î»£¬¿ÉÄÜ¼ì²âµ½µç³Ø¿ì±»³äÂúµç
  32          volatile bit flag_tim_set_bat_is_near_full = 0;     // ÓÉ¶¨Ê±Æ÷ÖÃÎ»/¸´Î»µÄ£¬±íÊ¾µç³ØÊÇ·ñ¿ì±»³äÂúµçµÄ±êÖ¾Î»
  33          
  34          volatile bit flag_tim_scan_maybe_low_bat = 0; // ÓÃÓÚ¸ø¶¨Ê±Æ÷É¨ÃèµÄ±êÖ¾Î»£¬¿ÉÄÜ¼ì²âµ½ÁËµÍµçÁ¿
  35          volatile bit flag_tim_set_bat_is_low = 0;     // ÓÉ¶¨Ê±Æ÷ÖÃÎ»/¸´Î»µÄ£¬±íÊ¾ÔÚ¹¤×÷Ê±£¬µç³ØÊÇ·ñ´¦ÓÚµÍµçÁ¿µÄ±ê
             -Ö¾Î»
  36          
  37          volatile bit flag_tim_scan_maybe_shut_down = 0; // ÓÃÓÚ¸ø¶¨Ê±Æ÷É¨ÃèµÄ±êÖ¾Î»£¬¿ÉÄÜ¼ì²âµ½ÁË µç³ØµçÑ¹ µÍÓÚ ¹Ø
             -»ú¶ÔÓ¦µÄµçÑ¹
  38          volatile bit flag_tim_set_shut_down = 0;        // ÓÉ¶¨Ê±Æ÷ÖÃÎ»/¸´Î»µÄ£¬±íÊ¾ÔÚ¹¤×÷Ê±£¬¼ì²âµ½ÁË µç³ØµçÑ¹ ÔÚ
             -Ò»¶ÎÊ±¼äÄÚ¶¼µÍÓÚ ¹Ø»ú¶ÔÓ¦µÄµçÑ¹
  39          
  40          volatile bit flag_tim_scan_maybe_motor_stalling = 0; // ÓÃÓÚ¸ø¶¨Ê±Æ÷É¨ÃèµÄ±êÖ¾Î»£¬¿ÉÄÜ¼ì²âµ½ÁËµç»ú¶Â×ª
  41          volatile bit flag_tim_set_motor_stalling = 0;        // ÓÉ¶¨Ê±Æ÷ÖÃÎ»/¸´Î»µÄ£¬±íÊ¾ÔÚ¹¤×÷Ê±¼ì²âµ½ÁËµç»ú¶Â×ª
  42          
  43          volatile bit flag_is_enable_key_scan = 0; // ±êÖ¾Î»£¬ÊÇ·ñÊ¹ÄÜ°´¼üÉ¨Ãè(Ã¿10ms±»¶¨Ê±Æ÷ÖÃÎ»£¬ÔÚÖ÷º¯ÊýÖÐ¼ì²â²¢
             -ÇåÁã)
  44          // volatile bit flag_is_dev_open = 0;        // £¨Ö»ÔÚ³¤°´¿ª»ú¡¢¹Ø»úÊ±Ê¹ÓÃ£©Éè±¸ÊÇ·ñ¿ª»úµÄ±êÖ¾Î»£¬0--Î´¿ª»
             -ú£¬1--¿ª»ú
  45          
  46          volatile bit flag_ctl_led_blink = 0; // ¿ØÖÆ±êÖ¾Î»£¬ÊÇ·ñ¿ØÖÆÖ¸Ê¾µÆÉÁË¸
C51 COMPILER V9.60.7.0   MAIN                                                              02/18/2025 17:34:22 PAGE 2   

  47          volatile bit flag_ctl_turn_dir = 0;  // ¿ØÖÆ±êÖ¾Î»£¬ÊÇ·ñ¸ü»»µç»úµÄ·½Ïò
  48          
  49          volatile bit flag_ctl_dev_close = 0; // ¿ØÖÆ±êÖ¾Î»£¬ÊÇ·ñÒª¹Ø±ÕÉè±¸
  50          
  51          volatile bit flag_ctl_low_bat_alarm = 0; // ¿ØÖÆ±êÖ¾Î»£¬ÊÇ·ñÊ¹ÄÜµÍµçÁ¿±¨¾¯
  52          
  53          volatile bit flag_is_disable_to_open = 0; // ±êÖ¾Î»£¬ÊÇ·ñ²»Ê¹ÄÜ¿ª»ú(µÍµçÁ¿²»ÔÊÐí¿ª»ú)
  54          
  55          volatile bit flag_is_recv_ctl = 0; // ±êÖ¾Î»£¬ÊÇ·ñ½ÓÊÕÁË¿ØÖÆÃüÁî
  56          /*
  57              ±êÖ¾Î»£¬ÊÇ·ñÍ¨¹ýÓïÒôÀ´ÇÐ»»·½Ïò.
  58              ÓÃÔÚ¶¨Ê±Æ÷ÖÐ¶ÏÖÐ£¬ÅÐ¶Ï×Ô¶¯»»·½Ïò£¬Èç¹ûÕâ¸ö±êÖ¾Î»ÖÃÒ»£¬
  59              »áÇå³ýµ±Ç°×Ô¶¯»»·½ÏòµÄ¼ÆÊ±£¬ÖØÐÂ¿ªÊ¼×Ô¶¯»»·½ÏòµÄ¼ÆÊ±,
  60              ¶¨Ê±Æ÷Çå³ý¼ÆÊ±ºó£¬»á¸øÕâ¸ö±êÖ¾Î»ÇåÁã
  61          */
  62          volatile bit flag_is_turn_dir_by_speech = 0;
  63          
  64          /*
  65              ±êÖ¾Î»£¬ÊÇ·ñ½ÓÊÕµ½ÁËÐÂµÄÓïÒôÐÅÏ¢/ÓÐÐÂµÄ°´¼ü²Ù×÷
  66              ÓÃÔÚ¶¨Ê±Æ÷ÖÐ¶Ï£¬ÔÚÍ¨¹ýÓïÒô¹Ø±ÕÉè±¸ºó£¬Ò»¶ÎÊ±¼äÎÞ²Ù×÷¶ø³¹µ×¹Ø»ú
  67              Èç¹ûÕâ¸ö±êÖ¾Î»ÖÃÒ»£¬ÔÚ¶¨Ê±Æ÷ÄÚ»áÇå³ý×Ô¶¯³¹µ×¹Ø»úµÄµ¹¼ÆÊ±£¬
  68              ¶¨Ê±Æ÷ÔÚÇå³ý¼ÆÊ±ºó£¬»á¸øÕâ¸ö±êÖ¾Î»ÇåÁã
  69          */
  70          volatile bit flag_is_new_operation = 0;
  71          
  72          volatile bit flag_is_enter_low_power = 0; // ±êÖ¾Î»£¬ÊÇ·ñÒª½øÈëµÍ¹¦ºÄ
  73          
  74          // ¿ØÖÆº¯Êý£¬¿ª»ú
  75          void fun_ctl_power_on(void)
  76          {
  77   1      #if USE_MOTOR
                  alter_motor_speed(2); // ¿ª»úºó£¬µç»ú½øÈë¶þµµ
              
                  motor_pwm_b_enable(); // µç»úÕýÏò×ª¶¯
              
                  cur_motor_dir = 1;    // ±íÊ¾µ±Ç°µç»úÔÚÕý×ª
                  cur_motor_status = 2; // ¸üÐÂµç»úµ²Î»×´Ì¬
              
              #endif
  86   1      
  87   1          // ÈÃÂÌµÆÉÁË¸
  88   1          LED_GREEN_ON();
  89   1          cur_sel_led = CUR_SEL_LED_GREEN;
  90   1      #if USE_MOTOR
                  cur_ctl_led_blink_cnt = cur_motor_status; // ledÉÁË¸´ÎÊýÓëµ±Ç°µç»úµÄµ²Î»ÓÐ¹Ø
              #endif
  93   1          flag_ctl_led_blink = 1; // ´ò¿ªLEDÉÁË¸µÄ¹¦ÄÜ
  94   1      }
  95          
  96          // ¿ØÖÆº¯Êý£¬¹Ø»ú
  97          void fun_ctl_power_off(void)
  98          {
  99   1          // alter_motor_speed(0); ¹Ø»ú£¨ºÃÏñ¿ÉÒÔ²»Ð´ÕâÒ»Ìõ£©
 100   1      
 101   1          // ¹Ø±ÕµÆ¹âÉÁË¸µÄ¶¯»­
 102   1          flag_ctl_led_blink = 0;
 103   1          delay_ms(1); // µÈ´ý¶¨Ê±Æ÷ÖÐ¶ÏÄÚ²¿Çå¿ÕÉÁË¸¹¦ÄÜ¶ÔÓ¦µÄ±êÖ¾ºÍ±äÁ¿£¬·ñÔò´ò¶ÏÉÁµÆµÄÐ§¹û»á±ä²î
 104   1          LED_GREEN_OFF();
 105   1          LED_RED_OFF();
 106   1      
 107   1          // ¹Ø±Õ¼ÓÈÈ
 108   1          cur_ctl_heat_status = 0;
C51 COMPILER V9.60.7.0   MAIN                                                              02/18/2025 17:34:22 PAGE 3   

 109   1      
 110   1      #if USE_MOTOR
                  // ¹Ø±ÕPWMÊä³ö£º
                  motor_pwm_disable();
              
                  cur_motor_status = 0; // ±íÊ¾µç»úÒÑ¾­¹Ø±Õ
                  cur_motor_dir = 0;    // ÇåÁã£¬»Øµ½³õÊ¼×´Ì¬
              #endif
 117   1      
 118   1          // ¹Ø»ú¿ÉÄÜÊÇ ³äµçÊ±½øÈëÁË¹Ø»ú¡¢µÍµçÁ¿½øÈëÁË¹Ø»ú¡¢ÊÖ¶¯¹Ø»ú¡¢×Ô¶¯½øÈëÁË¹Ø»ú
 119   1          // Èç¹ûÊÇ ³äµçÊ±½øÈëÁË¹Ø»ú£¬²»Ó¦¸ÃÇå³ýÏàÓ¦µÄ±êÖ¾Î»
 120   1          if (0 == flag_is_in_charging)
 121   1          {
 122   2              // Èç¹ûÃ»ÓÐÔÚ³äµç£¬Çå¿Õ¸úµÍµçÁ¿²»¿ª»úÎÞ¹ØµÄ±êÖ¾Î»
 123   2              flag_bat_is_full = 0;
 124   2              flag_tim_scan_maybe_not_charge = 0;
 125   2              flag_tim_scan_maybe_in_charging = 0;
 126   2              flag_tim_scan_bat_maybe_full = 0;
 127   2              flag_tim_scan_maybe_low_bat = 0;
 128   2              flag_tim_scan_maybe_shut_down = 0;
 129   2              flag_is_enable_key_scan = 0;
 130   2              flag_ctl_low_bat_alarm = 0;
 131   2          }
 132   1      }
 133          
 134          #if USE_MOTOR
              /**
               * @brief ¿ØÖÆµç»úµ²Î»
               *           Èç¹ûÒª¸ù¾Ý´«²ÎÀ´µ÷½Úµ²Î»£¬»á¸Ä±ä È«¾Ö±äÁ¿ cur_motor_status µÄ×´Ì¬
               *
               * @param adjust_motor_status Òªµ÷½Úµ½µÄµ²Î»
               *                          0--¸ù¾ÝÈ«¾Ö±äÁ¿ cur_motor_status µÄ×´Ì¬À´×Ô¶¯µ÷½Ú
               *                          1--µ÷½ÚÎª1µµ
               *                          2--µ÷½ÚÎª2µµ
               *                          3--µ÷½ÚÎª3µµ
               *                          ÆäËû--º¯ÊýÖ±½Ó·µ»Ø £¨ÎªÁË½ÚÊ¡³ÌÐò¿Õ¼ä£¬ÕâÀïÃ»ÓÐ¼Ó£©
               */
              void fun_ctl_motor_status(u8 adjust_motor_status)
              {
              #if 0  // ¿ÉÒÔ½ÚÊ¡5×Ö½Ú¿Õ¼ä
                  // if (adjust_motor_status > 3)
                  // {
                  //     return; // ´«²ÎÓÐÎó£¬Ö±½Ó·µ»Ø
                  // }
              #endif // ¿ÉÒÔ½ÚÊ¡5×Ö½Ú¿Õ¼ä
              
                  if (0 == adjust_motor_status)
                  {
                      // Èç¹û²»ÊÇ¸ù¾Ý´«²ÎÀ´µ÷½Úµ²Î»£¬
                      // ¶øÊÇ¸ù¾ÝÈ«¾Ö±äÁ¿cur_motor_statusµÄ×´Ì¬À´µ÷½Ú
                      if (1 == cur_motor_status)
                      {
                          // ´Ó 1µµ -> 2µµ
                          cur_motor_status = 2;
                      }
                      else if (2 == cur_motor_status)
                      {
                          // ´Ó 2µµ -> 3µµ
                          cur_motor_status = 3;
                      }
                      else if (3 == cur_motor_status)
                      {
C51 COMPILER V9.60.7.0   MAIN                                                              02/18/2025 17:34:22 PAGE 4   

                          // ´Ó 3µµ -> 1µµ
                          cur_motor_status = 1;
                      }
                  }
                  else
                  {
                      // Èç¹ûÊÇ¸ù¾Ý´«²ÎÀ´µ÷½Úµ²Î»
                      cur_motor_status = adjust_motor_status;
                  }
              
                  alter_motor_speed(cur_motor_status);
              
                  // Ã¿´ÎÇÐ»»µ²Î»£¬¶¼ÈÃ¶¨Ê±Æ÷¼ÓÔØ¶¯»­
                  flag_ctl_led_blink = 0; // ´ò¶Ïµ±Ç°ÕýÔÚÉÁË¸µÄ¹¦ÄÜ
                  delay_ms(1);            // µÈ´ý¶¨Ê±Æ÷ÖÐ¶ÏÄÚ²¿Çå¿ÕÉÁË¸¹¦ÄÜ¶ÔÓ¦µÄ±êÖ¾ºÍ±äÁ¿£¬·ñÔò´ò¶ÏÉÁµÆµÄÐ§¹û»á±ä²î
              
                  // Èç¹û²»´¦ÓÚµÍµçÁ¿±¨¾¯×´Ì¬£¬²ÅÊ¹ÄÜLEDÉÁË¸¹¦ÄÜ£º
                  if (0 == flag_tim_set_bat_is_low)
                  {
                      if (0 == cur_ctl_heat_status)
                      {
                          // Èç¹ûÃ»ÓÐ´ò¿ª¼ÓÈÈ£¬ÈÃÂÌµÆÉÁË¸
                          LED_RED_OFF();
                          LED_GREEN_ON();
                          cur_sel_led = CUR_SEL_LED_GREEN;
                      }
                      else
                      {
                          // Èç¹û´ò¿ªÁË¼ÓÈÈ£¬ÈÃºìµÆÉÁË¸
                          LED_GREEN_OFF();
                          LED_RED_ON();
                          cur_sel_led = CUR_SEL_LED_RED;
                      }
              
                      cur_ctl_led_blink_cnt = cur_motor_status; // ledÉÁË¸´ÎÊýÓëµ±Ç°µç»úµÄµ²Î»ÓÐ¹Ø
                      flag_ctl_led_blink = 1;                   // ´ò¿ªLEDÉÁË¸µÄ¹¦ÄÜ
                  }
              }
              #endif
 210          
 211          void main(void)
 212          {
 213   1          system_init();
 214   1      
 215   1          // ¹Ø±ÕHCKºÍHDAµÄµ÷ÊÔ¹¦ÄÜ
 216   1          WDT_KEY = 0x55;  // ½â³ýÐ´±£»¤
 217   1          IO_MAP &= ~0x03; // ¹Ø±ÕHCKºÍHDAÒý½ÅµÄµ÷ÊÔ¹¦ÄÜ£¨½â³ýÓ³Éä£©
 218   1          WDT_KEY = 0xBB;
 219   1      
 220   1          // ³õÊ¼»¯´òÓ¡
 221   1      #if USE_MY_DEBUG
 222   1          debug_init();
 223   1          printf("TXM8C101x_SDK main start\n");
 224   1      #endif //  #if USE_MY_DEBUG
 225   1      
 226   1          key_config();
 227   1          heating_pin_config();    // ¼ÓÈÈ¿ØÖÆÒý½Å
 228   1          speech_ctl_pin_config(); // ¿ØÖÆÓïÒôICµçÔ´µÄÒý½Å
 229   1          led_config();
 230   1      
 231   1          tmr1_config();     // 1ms¶¨Ê±Æ÷
 232   1          tmr2_pwm_config(); // ¿ØÖÆÉýÑ¹µÄPWM
C51 COMPILER V9.60.7.0   MAIN                                                              02/18/2025 17:34:22 PAGE 5   

 233   1      
 234   1          adc_config();
 235   1      #if USE_MOTOR
                  motor_config(); // ¿ØÖÆµç»úµÄÁ½Â·PWM
              #endif
 238   1      
 239   1          uart1_config();
 240   1      
 241   1          // ²»Ê¹ÓÃµÄÒý½ÅÅäÖÃÎªÊä³ö£¬Êä³öµÍµçÆ½
 242   1          P1_MD1 |= 0x01 << 2;
 243   1          P15 = 0;
 244   1      
 245   1          // ÓÉÓÚÐ¾Æ¬ÏÂÔØÖ®ºó»áÃ»ÓÐ·´Ó¦£¬ÕâÀïÓÃÂÌÉ«µÆ×÷ÎªÖ¸Ê¾£º
 246   1          LED_GREEN_ON();
 247   1          delay_ms(1000);
 248   1          LED_GREEN_OFF();
 249   1      
 250   1      #if 1 // ÉÏµçÊ±¼ì²âµç³ØÊÇ·ñÕýÈ·°²×°(²âÊÔÍ¨¹ý):
 251   1          /*
 252   1              Èç¹û´ò¿ªPWMºó£¬¼ì²âµç³ØµÄµçÑ¹±ÈÂúµç»¹Òª¸ß£¬ËµÃ÷Ã»ÓÐ½ÓÈëµç³Ø£¬
 253   1              ¼ì²âµ½µÄÊÇ³äµç5VÉýÑ¹ºóµÄµçÑ¹
 254   1          */
 255   1          tmr2_pwm_enable();    // ´ò¿ª¿ØÖÆÉýÑ¹µçÂ·µÄpwm
 256   1          TMR2_PWML = 93 % 256; // µ÷½ÚÎªÔ¼47.6%µÄÕ¼¿Õ±È
 257   1          TMR2_PWMH = 93 / 256;
 258   1          adc_sel_channel(ADC_CHANNEL_BAT); // ÇÐ»»µ½¼ì²âµç³Ø½µÑ¹ºóµÄµçÑ¹µÄ¼ì²âÒý½Å
 259   1      
 260   1          {
 261   2              u8 i = 0;
 262   2              u16 adc_val = 0;
 263   2              for (i = 0; i < 10; i++) // Ã¿55ms½øÈëÒ»´Î£¬Ñ­»·ÄÚÃ¿´Î¼ä¸ôÔ¼4.8ms
 264   2              {
 265   3                  adc_val = adc_get_val();
 266   3                  if (adc_val >= ADCDETECT_BAT_FULL + ADCDETECT_BAT_NULL_EX)
 267   3                  {
 268   4                      flag_bat_is_empty = 1; // ±íÊ¾µç³ØÊÇ¿ÕµÄ(µç³ØÃ»ÓÐ°²×°)
 269   4                  }
 270   3              }
 271   2          }
 272   1      
 273   1          tmr2_pwm_disable(); // ¹Ø±Õ¿ØÖÆÉýÑ¹µçÂ·µÄPWM
 274   1          TMR2_PWML = 0;      // 0%Õ¼¿Õ±È
 275   1          TMR2_PWMH = 0;
 276   1      
 277   1      #endif // ÉÏµçÊ±¼ì²âµç³ØÊÇ·ñÕýÈ·°²×°
 278   1      
 279   1          while (1)
 280   1          {
 281   2      
 282   2      #if 1 // (²âÊÔÍ¨¹ý)ÉÏµçÊ±£¬Èç¹û¼ì²âµ½µç³ØÃ»ÓÐ°²×°£¬ÈÃLEDÉÁË¸£¬Ö±µ½ÖØÐÂÉÏµç
 283   2              if (flag_bat_is_empty)
 284   2              {
 285   3                  // Ã»ÓÐ·ÅÈëµç³Ø£¬¿ØÖÆLEDÉÁË¸£¬Ö±µ½ÖØÐÂÉÏµç
 286   3                  LED_RED_ON();
 287   3                  delay_ms(200);
 288   3                  LED_RED_OFF();
 289   3                  delay_ms(200);
 290   3                  continue;
 291   3              }
 292   2      #endif // ÉÏµçÊ±£¬Èç¹û¼ì²âµ½µç³ØÃ»ÓÐ°²×°£¬ÈÃLEDÉÁË¸£¬Ö±µ½ÖØÐÂÉÏµç
 293   2      
 294   2      #if 1
C51 COMPILER V9.60.7.0   MAIN                                                              02/18/2025 17:34:22 PAGE 6   

 295   2              charge_scan_handle();
 296   2      
 297   2              // if (0 == flag_is_in_charging &&   /* ²»³äµçÊ±£¬²Å¶Ô°´¼ü×ö¼ì²âºÍ´¦Àí */
 298   2              //     0 == flag_is_disable_to_open) /* ²»´¦ÓÚµÍµçÁ¿²»ÄÜ¿ª»úµÄ×´Ì¬Ê± */
 299   2      
 300   2              if (0 == flag_is_in_charging)
 301   2              //  &&   /* ²»³äµçÊ±£¬²Å¶Ô°´¼ü×ö¼ì²âºÍ´¦Àí */
 302   2              // 0 == flag_is_disable_to_open) /* ²»´¦ÓÚµÍµçÁ¿²»ÄÜ¿ª»úµÄ×´Ì¬Ê± */
 303   2              {
 304   3                  if (flag_is_enable_key_scan) // Ã¿10ms£¬¸Ã±êÖ¾Î»»á±»¶¨Ê±Æ÷ÖÃÎ»Ò»´Î
 305   3                  {
 306   4                      flag_is_enable_key_scan = 0;
 307   4                      key_scan_10ms_isr();
 308   4                  }
 309   3      
 310   3                  key_event_handle();
 311   3              }
 312   2      
 313   2              // speech_scan_process(); // ¼ì²âÊÇ·ñÓÐ´ÓÓïÒôIC´«À´µÄÃüÁî£¬Èç¹ûÓÐÔò×öÏàÓ¦µÄ´¦Àí
 314   2      #endif
 315   2      
 316   2      #if 0  // µç»ú×Ô¶¯×ªÏò
                      if (flag_ctl_turn_dir)
                      {
                          // Èç¹ûÒªÇÐ»»µç»ú×ªÏò
                          flag_ctl_turn_dir = 0;
                          if (0 == cur_motor_dir)
                          {
                              // Èç¹ûµ±Ç°µç»úÎª³õÊ¼×´Ì¬£¬²»µ÷½Ú
                          }
                          else if (1 == cur_motor_dir)
                          {
                              // Èç¹ûµ±Ç°µç»úÎªÕý×ª£¬µ÷½ÚÎª·´×ª
                              // PWM0EC = 0; // ¹Ø±ÕÕý×ªµÄPWMÊä³ö
                              motor_pwm_b_disable(); // ¹Ø±ÕÕý×ªµÄPWMÊä³ö
                              delay_ms(500);
                              // PWM1EC = 1;        // ´ò¿ª·´×ªµÄPWMÊä³ö
                              motor_pwm_a_enable(); // ´ò¿ª·´×ªµÄPWMÊä³ö
                              cur_motor_dir = 2;    // ±íÊ¾µç»úµ±Ç°×ªÏòÎª ·´×ª
                          }
                          else if (2 == cur_motor_dir)
                          {
                              // Èç¹ûµ±Ç°µç»úÎª·´×ª£¬µ÷½ÚÎªÕý×ª
                              // PWM1EC = 0; // ¹Ø±Õ·´×ªµÄPWMÊä³ö
                              motor_pwm_a_disable(); // ¹Ø±Õ·´×ªµÄPWMÊä³ö
                              delay_ms(500);
                              // PWM0EC = 1;        // ´ò¿ªÕý×ªµÄPWMÊä³ö
                              motor_pwm_b_enable();
                              cur_motor_dir = 1; // ±íÊ¾µç»úµ±Ç°×ªÏòÎª Õý×ª
                          }
                          else
                          {
                              // ÆäËûÇé¿ö£¬²»¿¼ÂÇ£¬²»×ö´¦Àí
                          }
                      }
              #endif // µç»ú×Ô¶¯×ªÏò
 351   2      
 352   2      #if 0 // µç»ú¹ýÁ÷¼ì²âºÍ´¦Àí
              
                      motor_over_current_detect_handle(); // º¯ÊýÄÚ²¿»á¼ì²âµç»úÓÐÃ»ÓÐÔËÐÐ
              
              #endif // µç»ú¹ýÁ÷¼ì²âºÍ´¦Àí
C51 COMPILER V9.60.7.0   MAIN                                                              02/18/2025 17:34:22 PAGE 7   

 357   2      
 358   2      #if 0  // ¸ù¾Ý¿ØÖÆ±êÖ¾Î»À´¿ØÖÆ¹Ø»ú
                      if (flag_ctl_dev_close)
                      {
                          // Èç¹ûÒª¹Ø±ÕÉè±¸
                          flag_ctl_dev_close = 0;
              
                          if (flag_is_in_charging)
                          {
                              // Èç¹ûÕýÔÚ³äµç£¬Ö±½Ó¹Ø±ÕÓïÒôICµÄµçÔ´
                              SPEECH_POWER_DISABLE();
                          }
              
                          fun_ctl_power_off();
                      }
              #endif // ¸ù¾Ý¿ØÖÆ±êÖ¾Î»À´¿ØÖÆ¹Ø»ú
 373   2      
 374   2      #if 0  // µÍ¹¦ºÄ
              
                      {
                          if (flag_is_enter_low_power)
                          {
                              flag_is_enter_low_power = 0;
              
                              SPEECH_POWER_DISABLE(); // ¹Ø±ÕÓïÒôICµÄµçÔ´
                              low_power();
                          }
                      }
              #endif // µÍ¹¦ºÄ
 386   2      
 387   2          } // while (1)
 388   1      }
 389          
 390          void TMR0_IRQHandler(void) interrupt TMR0_IRQn
 391          {
 392   1          if (TMR0_CONH & 0x80)
 393   1          {
 394   2              TMR0_CONH |= 0x80;
 395   2              // 1ms²úÉúÒ»´ÎÖÐ¶Ï£¬½øÈëµ½ÕâÀï
 396   2      
 397   2              if (flag_bat_is_empty)
 398   2              {
 399   3                  return; // Èç¹ûµç³ØÎª¿Õ£¬ÌáÇ°ÍË³öÖÐ¶Ï·þÎñº¯Êý
 400   3              }
 401   2      
 402   2              { // °´¼üÉ¨Ãè
 403   3                  static volatile u8 key_scan_cnt = 0;
 404   3                  key_scan_cnt++;
 405   3                  if (key_scan_cnt >= 10)
 406   3                  {
 407   4                      key_scan_cnt = 0;
 408   4                      flag_is_enable_key_scan = 1;
 409   4                  }
 410   3              } // °´¼üÉ¨Ãè
 411   2      
 412   2      #if 1 // ¼ì²âÊÇ·ñ°Î³ö/²åÈë³äµçÆ÷
 413   2      
 414   2              { // ¼ì²âÊÇ·ñ°Î³ö/²åÈë³äµçÆ÷
 415   3                  static u8 not_charge_ms_cnt = 0;
 416   3                  static u8 charging_ms_cnt = 0;
 417   3                  if (flag_is_in_charging)
 418   3                  {
C51 COMPILER V9.60.7.0   MAIN                                                              02/18/2025 17:34:22 PAGE 8   

 419   4                      if (flag_tim_scan_maybe_not_charge)
 420   4                      {
 421   5                          // ÕýÔÚ³äµç£¬²¢ÇÒ¼ì²âµ½¿ÉÄÜÓÐ³äµçÆ÷¶Ï¿ª£¬½øÐÐ¼ÆÊ±
 422   5                          not_charge_ms_cnt++;
 423   5                          if (not_charge_ms_cnt >= 50)
 424   5                          {
 425   6                              not_charge_ms_cnt = 0;
 426   6                              flag_tim_set_is_in_charging = 0;
 427   6                          }
 428   5                      }
 429   4                      else
 430   4                      {
 431   5                          // ÕýÔÚ³äµç£¬²¢ÇÒÃ»ÓÐ¼ì²âµ½³äµçÆ÷¶Ï¿ª£º
 432   5                          not_charge_ms_cnt = 0;
 433   5                          flag_tim_set_is_in_charging = 1;
 434   5                      }
 435   4                  }
 436   3                  else
 437   3                  {
 438   4                      if (flag_tim_scan_maybe_in_charging)
 439   4                      {
 440   5                          // Ã»ÓÐÔÚ³äµç£¬µ«ÊÇ¼ì²âµ½ÓÐ³äµçÆ÷²åÈë£¬½øÐÐ¼ÆÊ±£¬È·ÈÏ³äµçÆ÷ÊÇ·ñÕæµÄ²åÈë£º
 441   5                          charging_ms_cnt++;
 442   5                          if (charging_ms_cnt >= 50)
 443   5                          {
 444   6                              charging_ms_cnt = 0;
 445   6                              flag_tim_set_is_in_charging = 1;
 446   6                          }
 447   5                      }
 448   4                      else
 449   4                      {
 450   5                          // Ã»ÓÐÔÚ³äµç£¬²¢ÇÒÒ²Ã»ÓÐ¼ì²âµ½³äµçÆ÷²åÈë
 451   5                          charging_ms_cnt = 0;
 452   5                          flag_tim_set_is_in_charging = 0;
 453   5                      }
 454   4                  }
 455   3              } // ¼ì²âÊÇ·ñ°Î³ö/²åÈë³äµçÆ÷
 456   2      #endif // ¼ì²âÊÇ·ñ°Î³ö/²åÈë³äµçÆ÷
 457   2      
 458   2      #if 0  // ¿ØÖÆµÆ¹âÉÁË¸µÄÐ§¹û
              
                      { // ¿ØÖÆµÆ¹âÉÁË¸µÄÐ§¹û
              
                          static volatile u16 blink_ms_cnt = 0; // ¼ÆÊýÖµ£¬¿ØÖÆµÆ¹âÉÁË¸µÄÊ±¼ä¼ä¸ô
              
                          // ×´Ì¬»ú£¬
                          // 0--³õÊ¼Öµ¡¢ÎÞ×´Ì¬£¬
                          // 1--×¼±¸½øÈëÉÁË¸£¬
                          // 2--ÕýÔÚÉÁË¸
                          static volatile u8 cur_blink_status = 0;
                          static u8 __blink_cnt = 0; // Ò»¿ªÊ¼´æ·ÅÒªÉÁË¸µÄ´ÎÊý£¬ºóÃæ¿ØÖÆµ±Ç°Ê£ÓàÉÁË¸´ÎÊý
              
                          if (flag_ctl_led_blink)
                          {
                              // Èç¹ûÊ¹ÄÜÁËµÆ¹âÉÁË¸
                              if (0 == cur_blink_status)
                              {
                                  // Èç¹ûµ±Ç°µÆ¹â×´Ì¬´¦ÓÚ³õÊ¼Öµ£¬Ã»ÓÐÔÚÉÁË¸
                                  cur_blink_status = 1;
                              }
                          }
                          else
C51 COMPILER V9.60.7.0   MAIN                                                              02/18/2025 17:34:22 PAGE 9   

                          {
                              // Èç¹û²»Ê¹ÄÜµÆ¹âÉÁË¸£¬Á¢¼´Í£Ö¹µ±Ç°µÆ¹âÉÁË¸µÄÐ§¹û
                              cur_blink_status = 0;
                              blink_ms_cnt = 0;
                              __blink_cnt = 0;
                          }
              
                          if (1 == cur_blink_status)
                          {
                              // ×¼±¸½øÈëÉÁË¸£¬ÅÐ¶ÏÒªÉÁË¸µÄÊÇºìµÆ»¹ÊÇÂÌµÆ£¬ÊÇÒª±íÊ¾µ±Ç°µç»úµÄµ²Î»»¹ÊÇ¼ÓÈÈµÄµ²Î»
              
                              // ¿ÉÒÔÔÚÉÁË¸Ç°ÏÈ¹Ø±ÕµÆ¹â£¬ÔÙµãÁÁÒªÉÁË¸µÄLED£¬
                              // ×îºóÔÙÊ¹ÄÜÉÁË¸µÄÐ§¹û£¬ÕâÑù¾Í²»ÓÃ¼ÓÈëÏÂÃæµÄÅÐ¶Ï£º
                              // if (CUR_SEL_LED_RED == cur_sel_led)
                              // {
                              //     // Èç¹ûÒªÈÃºìµÆÉÁË¸
                              //     // LED_GREEN_OFF();
                              //     // LED_RED_ON();
                              // }
                              // else if (CUR_SEL_LED_GREEN == cur_sel_led)
                              // {
                              //     // Èç¹ûÒªÈÃÂÌµÆÉÁË¸
                              //     // LED_RED_OFF();
                              //     // LED_GREEN_ON();
                              // }
              
                              // ÈÃµÆ¹â±£³ÖµãÁÁ500ms
                              blink_ms_cnt++;
                              if (blink_ms_cnt >= 500)
                              {
                                  blink_ms_cnt = 0;
                                  cur_blink_status = 2; // ±íÊ¾ÕýÊ½½øÈëLEDÉÁË¸×´Ì¬
                              }
                          }
                          else if (2 == cur_blink_status)
                          {
                              // Èç¹ûÕýÔÚ½øÐÐLEDÉÁË¸
                              if (0 == __blink_cnt)
                              {
                                  __blink_cnt = cur_ctl_led_blink_cnt; // ´æ·Åµ±Ç°ÒªÉÁË¸µÄ´ÎÊý
                              }
              
                              if (__blink_cnt) // Èç¹ûÉÁË¸´ÎÊý²»Îª0£¬¼ÌÐøÉÁË¸
                              {
                                  blink_ms_cnt++;
                                  if (blink_ms_cnt <= 500)
                                  {
                                      // Ï¨ÃðLED 500ms
                                      if (CUR_SEL_LED_RED == cur_sel_led)
                                      {
                                          // Èç¹ûÒªÈÃºìµÆÉÁË¸
                                          LED_RED_OFF();
                                      }
                                      else if (CUR_SEL_LED_GREEN == cur_sel_led)
                                      {
                                          // Èç¹ûÒªÈÃÂÌµÆÉÁË¸
                                          LED_GREEN_OFF();
                                      }
                                  }
                                  else if (blink_ms_cnt < 1000)
                                  {
                                      // µãÁÁLED 500ms
C51 COMPILER V9.60.7.0   MAIN                                                              02/18/2025 17:34:22 PAGE 10  

                                      if (CUR_SEL_LED_RED == cur_sel_led)
                                      {
                                          // Èç¹ûÒªÈÃºìµÆÉÁË¸
                                          LED_RED_ON();
                                      }
                                      else if (CUR_SEL_LED_GREEN == cur_sel_led)
                                      {
                                          // Èç¹ûÒªÈÃÂÌµÆÉÁË¸
                                          LED_GREEN_ON();
                                      }
                                  }
                                  else
                                  {
                                      blink_ms_cnt = 0;
                                      __blink_cnt--; // Íê³ÉÁËÒ»´ÎÉÁË¸£¬¼ÆÊýÖµ¼õÒ»
                                      if (0 == __blink_cnt)
                                      {
                                          // Èç¹ûÊ£ÓàÉÁË¸´ÎÊýÎª0£¬½áÊøÉÁË¸
                                          flag_ctl_led_blink = 0; // ²»Ê¹ÄÜÉÁË¸
                                          cur_blink_status = 0;   // »Ö¸´µ½³õÊ¼Öµ£¬±íÊ¾Ã»ÓÐÔÚÉÁË¸
                                      }
                                  }
                              }
                          }
                      } // ¿ØÖÆµÆ¹âÉÁË¸µÄÐ§¹û
              #endif // ¿ØÖÆµÆ¹âÉÁË¸µÄÐ§¹û
 569   2      
 570   2      #if 0  // ¿ØÖÆ¼ÓÈÈ
              
                      { // ¿ØÖÆ¼ÓÈÈ
                          static volatile u8 __ctl_heat_ms_cnt = 0;
              
                          if (1 == cur_ctl_heat_status)
                          {
                              // Ò»µµ¼ÓÈÈ
                              HEATING_ON();
                          }
                          else if (2 == cur_ctl_heat_status)
                          {
                              // ¶þµµ¼ÓÈÈ
                              __ctl_heat_ms_cnt++;
                              if (__ctl_heat_ms_cnt <= 5)
                              {
                                  HEATING_ON();
                              }
                              else if (__ctl_heat_ms_cnt < 10)
                              {
                                  HEATING_OFF();
                              }
                              else
                              {
                                  __ctl_heat_ms_cnt = 0;
                              }
                          }
                          else
                          {
                              // ÎÞ×´Ì¬£¬¹Ø±Õ¼ÓÈÈ
                              HEATING_OFF();
                              __ctl_heat_ms_cnt = 0;
                          }
              
                      } // ¿ØÖÆ¼ÓÈÈ
C51 COMPILER V9.60.7.0   MAIN                                                              02/18/2025 17:34:22 PAGE 11  

              #endif // ¿ØÖÆ¼ÓÈÈ
 606   2      
 607   2      #if 0  // ¿ØÖÆ×Ô¶¯¹Ø»ú
              
                      { // ×Ô¶¯¹Ø»ú
                          static volatile u32 shut_down_ms_cnt = 0;
              
                          if ((0 != cur_motor_status ||     /* Èç¹ûµç»ú²»ÊÇ¹Ø±ÕµÄ */
                               0 != cur_ctl_heat_status) && /* Èç¹û¼ÓÈÈ²»ÊÇ¹Ø±ÕµÄ */
                              0 == flag_is_in_charging      /* µ±Ç°Ã»ÓÐÔÚ³äµç */
                          )
                          {
                              shut_down_ms_cnt++;
                              if (shut_down_ms_cnt >= 600000) // xx ms ºó£¬¹Ø»ú
                              {
                                  shut_down_ms_cnt = 0;
                                  flag_ctl_dev_close = 1;
                              }
                          }
                          else
                          {
                              shut_down_ms_cnt = 0;
                          }
                      } // ×Ô¶¯¹Ø»ú
              #endif // ¿ØÖÆ×Ô¶¯¹Ø»ú
 630   2      
 631   2      #if 0  // ¿ØÖÆµç»ú×Ô¶¯»»·½Ïò
              
                      { // ×Ô¶¯»»·½Ïò
              
                          static volatile u16 turn_dir_ms_cnt = 0; // ¿ØÖÆÔÚÔËÐÐÊ±Ã¿ xx minÇÐ»»Ò»´Î×ªÏòµÄ¼ÆÊ±±äÁ¿
              
                          if ((0 != cur_motor_status) &&       /* Èç¹ûµç»ú²»ÊÇ¹Ø±ÕµÄ */
                              0 == flag_is_turn_dir_by_speech) /* Èç¹ûÃ»ÓÐÍ¨¹ýÓïÒôµ÷½Ú¹ý·½Ïò */
              
                          {
                              turn_dir_ms_cnt++;
                              if (turn_dir_ms_cnt >= 60000) // xx ms ºó£¬»»·½Ïò
                              // if (turn_dir_ms_cnt >= 60) // xx ms ºó£¬»»·½Ïò£¨²âÊÔÓÃ£©
                              {
                                  turn_dir_ms_cnt = 0;
                                  // ±êÖ¾Î»ÖÃÒ»£¬ÈÃ»»·½ÏòµÄ²Ù×÷ÔÚÖ÷º¯ÊýÖ´ÐÐ£¬ÒòÎª»»·½ÏòÒª¼ä¸ô500ms
                                  flag_ctl_turn_dir = 1;
                              }
                          }
                          else
                          {
                              turn_dir_ms_cnt = 0;
              
                              if (flag_is_turn_dir_by_speech)
                              {
                                  flag_is_turn_dir_by_speech = 0; // ÒÑ¾­Çå³ý×Ô¶¯»»·½ÏòµÄ¼ÆÊ±£¬±ãÇå³ý¸Ã±êÖ¾Î»
                              }
                          }
              
                      } // ×Ô¶¯»»·½Ïò
              #endif // ¿ØÖÆµç»ú×Ô¶¯»»·½Ïò
 662   2      
 663   2      #if 0 // ¼ì²âÊÇ·ñ¿ì³äÂúµç
              
                      {
                          static volatile u16 bat_is_near_full_ms_cnt = 0;
C51 COMPILER V9.60.7.0   MAIN                                                              02/18/2025 17:34:22 PAGE 12  

                          // Èç¹û²»ÔÚ³äµç¾ÍÇå¿ÕÁË±êÖ¾Î» flag_tim_scan_bat_maybe_near_full £¬
                          //  |-- ¿ÉÒÔ²»¼ÓÕâ¸öÅÐ¶ÏÌõ¼þ£º
                          // if (flag_is_in_charging)
                          {
                              if (flag_tim_scan_bat_maybe_near_full)
                              {
                                  // ÕýÔÚ³äµç£¬ÇÒ¼ì²âµ½¿ì³äÂúµç£¬½øÐÐ¼ÆÊ±
                                  bat_is_near_full_ms_cnt++;
                                  if (bat_is_near_full_ms_cnt >= 5000) // xx ms
                                  {
                                      bat_is_near_full_ms_cnt = 0;
                                      flag_bat_is_near_full = 1;
                                  }
                              }
                              else
                              {
                                  // ÕýÔÚ³äµç£¬µ«ÊÇÓÐÒ»´ÎÃ»ÓÐ¼ì²âµ½¿ì³äÂúµç£¬Çå³ý¼ÆÊ±ºÍ±êÖ¾Î»
                                  bat_is_near_full_ms_cnt = 0;
                                  flag_tim_set_bat_is_near_full = 0;
                              }
                          }
                      }
              
              #endif // ¼ì²âÊÇ·ñ¿ì³äÂúµç
 691   2      
 692   2      #if 0  // ¼ì²âÊÇ·ñ³äÂúµç
              
                      { // ¼ì²âÊÇ·ñ³äÂúµç
                          static volatile u16 bat_is_full_ms_cnt = 0;
                          // Èç¹û²»ÔÚ³äµç¾ÍÇå¿ÕÁË±êÖ¾Î» flag_tim_scan_bat_maybe_full £¬
                          //  |-- ¿ÉÒÔ²»¼ÓÕâ¸öÅÐ¶ÏÌõ¼þ£º
                          // if (flag_is_in_charging)
                          {
                              if (flag_tim_scan_bat_maybe_full)
                              {
                                  // ÕýÔÚ³äµç£¬²¢ÇÒÓÐ¼ì²âµ½µç³ØÂúµç£¬½øÐÐÀÛ¼Æ£º
                                  bat_is_full_ms_cnt++;
                                  if (bat_is_full_ms_cnt >= 5000) // xx ms
                                  {
                                      bat_is_full_ms_cnt = 0;
                                      flag_tim_set_bat_is_full = 1;
                                  }
                              }
                              else
                              {
                                  // ÕýÔÚ³äµç£¬µ«ÊÇÃ»ÓÐ¼ì²âµ½µç³ØÂúµç£º
                                  bat_is_full_ms_cnt = 0;
                                  flag_tim_set_bat_is_full = 0;
                              }
                          }
                      } // ¼ì²âÊÇ·ñ³äÂúµç
              #endif // ¼ì²âÊÇ·ñ³äÂúµç
 719   2      
 720   2      #if 0  // ¼ì²âÊÇ·ñÒªµÍµçÁ¿±¨¾¯
              
                      {
                          static u16 low_bat_ms_cnt = 0;
                          if (flag_tim_scan_maybe_low_bat)
                          {
                              // Èç¹û¿ÉÄÜ¼ì²âµ½ÁËµÍµçÁ¿£¬½øÐÐÁ¬Ðø¼ÆÊ±
                              low_bat_ms_cnt++;
                              if (low_bat_ms_cnt >= LOW_BAT_SCAN_TIMES_MS)
C51 COMPILER V9.60.7.0   MAIN                                                              02/18/2025 17:34:22 PAGE 13  

                              {
                                  low_bat_ms_cnt = 0;
                                  flag_tim_set_bat_is_low = 1;
                              }
                          }
                          else
                          {
                              // Èç¹ûÃ»ÓÐ¼ì²âµ½µÍµçÁ¿
                              low_bat_ms_cnt = 0;
                              flag_tim_set_bat_is_low = 0;
                          }
                      }
              
                      { // ¸ù¾Ý±êÖ¾Î»À´Ö´ÐÐµÍµçÁ¿±¨¾¯µÄ¹¦ÄÜ£¬Ö´ÐÐÇ°(¸ø¿ØÖÆ±êÖ¾Î»ÖÃÒ»Ç°)ÒªÏÈ¹Ø±ÕËùÓÐLED
              
                          static bit __flag_is_in_low_bat_alarm = 0;   // ±êÖ¾Î»£¬ÊÇ·ñÕýÔÚÖ´ÐÐµÍµçÁ¿±¨¾¯µÄ¹¦ÄÜ
                          static u16 __blink_cnt_in_low_bat_alarm = 0; // µÍµçÁ¿±¨¾¯Ê±£¬LEDÉÁË¸Ê±¼ä¼ÆÊý
              
                          /* Èç¹ûÊ¹ÄÜÁËµÍµçÁ¿±¨¾¯£¬²¢ÇÒÉè±¸ÕýÔÚÔËÐÐ */
                          if (flag_ctl_low_bat_alarm &&
                              (0 != cur_motor_status || 0 != cur_ctl_heat_status))
                          {
                              if (0 == __flag_is_in_low_bat_alarm)
                              {
                                  __flag_is_in_low_bat_alarm = 1; // ÔÚ¸ÃÓï¾ä¿éÄÚ²¿£¬Ê¹ÄÜµÍµçÁ¿±¨¾¯µÄ¹¦ÄÜ
                              }
                          }
                          else
                          {
                              __blink_cnt_in_low_bat_alarm = 0;
                              __flag_is_in_low_bat_alarm = 0;
                          }
              
                          if (__flag_is_in_low_bat_alarm)
                          {
                              __blink_cnt_in_low_bat_alarm++;
                              if (__blink_cnt_in_low_bat_alarm <= 300)
                              {
                                  LED_RED_ON();
                              }
                              else if (__blink_cnt_in_low_bat_alarm < 600)
                              {
                                  LED_RED_OFF();
                              }
                              else
                              {
                                  __blink_cnt_in_low_bat_alarm = 0;
                              }
                          }
                      } // ¸ù¾Ý±êÖ¾Î»À´Ö´ÐÐµÍµçÁ¿±¨¾¯µÄ¹¦ÄÜ£¬Ö´ÐÐÇ°(¸ø¿ØÖÆ±êÖ¾Î»ÖÃÒ»Ç°)ÒªÏÈ¹Ø±ÕËùÓÐLED
              #endif // ¼ì²âÊÇ·ñÒªµÍµçÁ¿±¨¾¯
 780   2      
 781   2      #if 0  // ¹¤×÷Ê±£¬¼ì²âµç³ØµçÁ¿ÊÇ·ñÒ»Ö±µÍÓÚ¹Ø»úµçÑ¹
              
                      {
                          static u16 __shut_down_cnt = 0; // ¶Ôµç³ØµçÑ¹µÍÓÚ¹Ø»úµçÑ¹µÄÁ¬Ðø¼ÆÊ±
              
                          if (flag_tim_scan_maybe_shut_down)
                          {
                              // Èç¹û¼ì²âµ½ÔÚ¹¤×÷Ê±£¬µç³ØµçÑ¹µÍÓÚ¹Ø»úµçÑ¹£¬½øÐÐÁ¬Ðø¼ÆÊ±
                              __shut_down_cnt++;
                              if (__shut_down_cnt >= SHUT_DOWN_SCAN_TIMES_MS)
C51 COMPILER V9.60.7.0   MAIN                                                              02/18/2025 17:34:22 PAGE 14  

                              {
                                  __shut_down_cnt = 0;
                                  flag_tim_set_shut_down = 1;
                              }
                          }
                          else
                          {
                              // Èç¹ûÔÚ¹¤×÷Ê±£¬Ã»ÓÐ¼ì²âµ½ µç³ØµçÑ¹µÍÓÚ¹Ø»úµçÑ¹
                              __shut_down_cnt = 0;
                              flag_tim_set_shut_down = 0;
                          }
                      }
              #endif // ¹¤×÷Ê±£¬¼ì²âµç³ØµçÁ¿ÊÇ·ñÒ»Ö±µÍÓÚ¹Ø»úµçÑ¹
 804   2      
 805   2      #if 0  // µç»ú¹ýÁ÷¼ì²â£¬³¬¹ý10s±ãÈÏÎªµç»ú¶Â×ª
              
                      {
                          // ¼ì²âµ½µç»ú¶Â×ªºó£¬½øÐÐÁ¬Ðø¼ÆÊ±
                          static u16 __detect_motor_stalling_cnt = 0;
              
                          if (flag_tim_scan_maybe_motor_stalling && 0 != cur_motor_status)
                          {
                              // Èç¹û¼ì²âµ½ÓÐµç»ú¶Â×ªµÄÇé¿ö
                              // P00 = 1; // ·½±ã²âÊÔ¹ýÁ÷¼ì²âÊ±¼ä
              
                              __detect_motor_stalling_cnt++;
                              if (__detect_motor_stalling_cnt >= MOTOR_STALLING_SCAN_TIMES_MS)
                              {
                                  __detect_motor_stalling_cnt = 0;
                                  flag_tim_set_motor_stalling = 1;
                              }
                          }
                          else
                          {
                              // Èç¹ûÃ»ÓÐ¼ì²âµ½ÓÐµç»ú¶Â×ªµÄÇé¿ö
                              // P00 = 0; // ·½±ã²âÊÔ¹ýÁ÷¼ì²âÊ±¼ä
              
                              __detect_motor_stalling_cnt = 0;
                              flag_tim_set_motor_stalling = 0;
                          }
                      }
              #endif // µç»ú¹ýÁ÷¼ì²â£¬³¬¹ý10s±ãÈÏÎªµç»ú¶Â×ª
 833   2      
 834   2      #if 0  // ¿ØÖÆÓïÒôIC¹Ø»úºó£¬ÎÞ²Ù×÷¶ø¹Ø»ú
              
                      {
                          static u32 no_operation_shut_down_cnt = 0; // ÎÞ²Ù×÷×Ô¶¯¹Ø»úµÄ¼ÆÊ±
              
                          if (0 == flag_is_new_operation && /* Èç¹ûÃ»ÓÐÐÂµÄ²Ù×÷ */
                              0 == cur_motor_status &&      /* Èç¹ûµç»ú¹Ø±Õ */
                              0 == cur_ctl_heat_status &&   /* Èç¹û¼ÓÈÈ¹Ø±Õ */
                              0 == flag_is_enter_low_power) /* Èç¹ûÃ»ÓÐÊ¹ÄÜ½øÈëµÍ¹¦ºÄ */
                          {
                              no_operation_shut_down_cnt++;
                              if (no_operation_shut_down_cnt >= NO_OPERATION_SHUT_DOWN_TIMES_MS)
                              {
                                  no_operation_shut_down_cnt = 0;
                                  flag_is_enter_low_power = 1;
                              }
                          }
                          else
                          {
C51 COMPILER V9.60.7.0   MAIN                                                              02/18/2025 17:34:22 PAGE 15  

                              no_operation_shut_down_cnt = 0;
                              flag_is_new_operation = 0;
                          }
                      }
              #endif // ¿ØÖÆÓïÒôIC¹Ø»úºó£¬ÎÞ²Ù×÷¶ø¹Ø»ú
 858   2      
 859   2      #if 1 // ¿ØÖÆºôÎüµÆÐ§¹û
 860   2      
 861   2              {
 862   3                  // 0 -- ³õÊ¼×´Ì¬
 863   3                  // 1 -- ¸Õ½øÈëºôÎüµÆ×´Ì¬
 864   3                  // 2 -- ´ÓÁÁµ½Ãð
 865   3                  // 3 -- ´ÓÃðµ½ÁÁ
 866   3                  static u8 cur_breathing_status = 0;
 867   3                  static u16 pwm_duty = 0;
 868   3      
 869   3                  if (flag_is_in_charging &&
 870   3                      (0 == flag_bat_is_near_full) &&
 871   3                      (0 == flag_bat_is_full))
 872   3                  {
 873   4                      if (0 == cur_breathing_status)
 874   4                      {
 875   5                          cur_breathing_status = 1;
 876   5                      }
 877   4                  }
 878   3                  else
 879   3                  {
 880   4                      cur_breathing_status = 0;
 881   4                      pwm_duty = 0;
 882   4                  }
 883   3      
 884   3                  if (1 == cur_breathing_status)
 885   3                  {
 886   4                      pwm_duty = (STMR2_PRE + 1);
 887   4                      cur_breathing_status = 2;
 888   4                      LED_RED_ON();
 889   4                  }
 890   3                  else if (2 == cur_breathing_status)
 891   3                  {
 892   4                      if (pwm_duty > 0)
 893   4                      {
 894   5                          pwm_duty--;
 895   5                      }
 896   4                      else
 897   4                      {
 898   5                          cur_breathing_status = 3;
 899   5                          pwm_duty = 0;
 900   5                      }
 901   4      
 902   4                      STMR2_CMPAH = (pwm_duty) / 256; // Í¨µÀAÕ¼¿Õ±È
 903   4                      STMR2_CMPAL = (pwm_duty) % 256;
 904   4                  }
 905   3                  else if (3 == cur_breathing_status)
 906   3                  {
 907   4                      if (pwm_duty < (STMR2_PRE + 1))
 908   4                      {
 909   5                          pwm_duty++;
 910   5                      }
 911   4                      else
 912   4                      {
 913   5                          cur_breathing_status = 2;
 914   5                          pwm_duty = (STMR2_PRE + 1);
C51 COMPILER V9.60.7.0   MAIN                                                              02/18/2025 17:34:22 PAGE 16  

 915   5                      }
 916   4      
 917   4                      STMR2_CMPAH = (pwm_duty) / 256; // Í¨µÀAÕ¼¿Õ±È
 918   4                      STMR2_CMPAL = (pwm_duty) % 256;
 919   4                  }
 920   3              }
 921   2      
 922   2      #endif // ¿ØÖÆºôÎüµÆÐ§¹û
 923   2          }
 924   1      }
 925          
 926          /**
 927           * @}
 928           */
 929          
 930          /*************************** (C) COPYRIGHT 2021 HUGE-IC ***** END OF FILE *****/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    496    ----
   CONSTANT SIZE    =     26    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      6       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =     27    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
